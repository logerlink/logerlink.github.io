<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"></link>
        <meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
        <title>window mongodb复制集全量备份与增量备份 - LogerLink .NET Blog</title>
        <meta name="keywords" content="mongodb,全量备份,差异备份,增量备份">
        <meta name="description" content="window mongodb复制集全量备份与增量备份，window mongodb复制集，window mongodb服务自启动">
        <link href='../../css/family.css' rel='stylesheet' type='text/css' />
        <script src="../../js/base.js" type="module"></script>
    </head>
    <body>
        <div class="container">
            
            <div class="col-left">
                <div class="wave"></div>
                <div class="category">
                </div>
            </div>
            <div class="col-right">
                <article>
                    <header>
                        <h1 class="title">
                            window mongodb复制集全量备份与增量备份
                        </h1>
                        <div class="dateTime">
                            2021-11-08
                        </div>
                    </header>
                    <hr/>
                    <div class="content">
<div class='typora-export os-windows' >
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span class="btn-toggle">&gt;</span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2"><a class="md-toc-inner" href="#全量备份差异备份增量备份">全量备份、差异备份、增量备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n5"><a class="md-toc-inner" href="#资源占比">资源占比</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n46"><a class="md-toc-inner" href="#还原复杂度">还原复杂度</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n63"><a class="md-toc-inner" href="#备份数据缺失">备份数据缺失</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n68"><a class="md-toc-inner" href="#其他">其他</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n71"><a class="md-toc-inner" href="#工具准备">工具准备</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n75"><a class="md-toc-inner" href="#mongodump">mongodump</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n91"><a class="md-toc-inner" href="#mongorestore">mongorestore</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n98"><a class="md-toc-inner" href="#window-搭建mongodb-副本集">window 搭建mongodb 副本集</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n102"><a class="md-toc-inner" href="#rs1">rs1</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n115"><a class="md-toc-inner" href="#rs2">rs2</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n128"><a class="md-toc-inner" href="#rs3">rs3</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n141"><a class="md-toc-inner" href="#启动rs1rs2rs3">启动rs1、rs2、rs3</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n143"><a class="md-toc-inner" href="#配置添加节点">配置添加节点</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n147"><a class="md-toc-inner" href="#题外）将mongodb加入window服务开机自启动">（题外）将mongodb加入window服务，开机自启动</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n157"><a class="md-toc-inner" href="#window-mongodb-测试全量备份增量备份与还原">window mongodb 测试全量备份、增量备份与还原</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n159"><a class="md-toc-inner" href="#数据准备1">数据准备1</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n162"><a class="md-toc-inner" href="#全量备份">全量备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n166"><a class="md-toc-inner" href="#数据准备2">数据准备2</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n169"><a class="md-toc-inner" href="#增量备份">增量备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n183"><a class="md-toc-inner" href="#删除测试记录不要在生产环境测试">删除测试记录，不要在生产环境测试！！！</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n186"><a class="md-toc-inner" href="#还原全量备份">还原全量备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n191"><a class="md-toc-inner" href="#还原增量备份">还原增量备份</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n197"><a class="md-toc-inner" href="#参考资料">参考资料</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n207"><a class="md-toc-inner" href="#window-mongodb自动备份">window mongodb自动备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n210"><a class="md-toc-inner" href="#全量备份-backupallbat">全量备份 backupAll.bat</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n213"><a class="md-toc-inner" href="#增量备份-backupoplogbat">增量备份 backupOplog.bat</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n217"><a class="md-toc-inner" href="#window任务计划定时执行全量备份">window任务计划定时执行全量备份</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n228"><a class="md-toc-inner" href="#window任务计划定时执行增量备份">window任务计划定时执行增量备份</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n232"><a class="md-toc-inner" href="#mongodb副本集如何添加删除新节点呢">mongodb副本集如何添加、删除新节点呢？</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n234"><a class="md-toc-inner" href="#rs4">rs4</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n248"><a class="md-toc-inner" href="#添加新节点">添加新节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n252"><a class="md-toc-inner" href="#验证添加新节点是否成功">验证添加新节点是否成功</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n256"><a class="md-toc-inner" href="#删除副本节点">删除副本节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n260"><a class="md-toc-inner" href="#删除副本节点-注意事项">删除副本节点 注意事项</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n265"><a class="md-toc-inner" href="#删除节点错误示范">删除节点错误示范***</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n272"><a class="md-toc-inner" href="#单机-mongodb-如何变成副本集呢">单机 mongodb 如何变成副本集呢？</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n275"><a class="md-toc-inner" href="#mongodb如何做差异备份呢">mongodb如何做差异备份呢？</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n283"><a class="md-toc-inner" href="#其他问题">其他问题</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n284"><a class="md-toc-inner" href="#this-node-was-not-started-with-the-replset-option">This node was not started with the replSet option</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n286"><a class="md-toc-inner" href="#failed-bad-option---oplog-mode-only-supported-on-full-dumps">Failed: bad option: --oplog mode only supported on full dumps</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n290"><a class="md-toc-inner" href="#failed-no-oplog-file-to-replay-make-sure-you-run-mongodump-with---oplog">Failed: no oplog file to replay; make sure you run mongodump with --oplog</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n295"><a class="md-toc-inner" href="#mongorestore-恢复失败插入主键冲突">mongorestore 恢复失败。插入主键冲突</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n298"><a class="md-toc-inner" href="#not-master-and-slaveokfalse">not master and slaveOk=false</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n301"><a class="md-toc-inner" href="#not-master--notwritableprimary">not master  NotWritablePrimary</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n303"><a class="md-toc-inner" href="#new-config-is-rejected--caused-by--replsetreconfig-should-only-be-run-on-a-writable-primary-current-state-secondary">New config is rejected :: caused by :: replSetReconfig should only be run on a writable PRIMARY. Current state SECONDARY;</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n306"><a class="md-toc-inner" href="#reconfig-attempted-to-install-a-config-that-would-change-the-implicit-default-write-concern-use-the-setdefaultrwconcern-command-to-set-a-cluster-wide-write-concern-and-try-the-reconfig-again	删除仲裁副）节点报错">Reconfig attempted to install a config that would change the implicit default write concern. Use the setDefaultRWConcern command to set a cluster-wide write concern and try the reconfig again<span>	</span>删除仲裁（副）节点报错</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n310"><a class="md-toc-inner" href="#如何将副节点转成仲裁节点仲裁节点转成副节点">如何将副节点转成仲裁节点，仲裁节点转成副节点，</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n326"><a class="md-toc-inner" href="#quorum-check-failed-because-not-enough-voting-nodes-responded-required-2-but-only-the-following-1-voting-nodes-responded-localhost27007-the-following-nodes-did-not-respond-affirmatively-localhost27009-failed-with-error-connecting-to-localhost27009-12700127009">Quorum check failed because not enough voting nodes responded; required 2 but only the following 1 voting nodes responded: localhost:27007; the following nodes did not respond affirmatively: localhost:27009 failed with Error connecting to localhost:27009 (127.0.0.1:27009)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n330"><a class="md-toc-inner" href="#修改配置文件投票数）报错caused-by--bson-field-votes-value-must-be--1-actual-value-2">修改配置文件（投票数）报错：caused by :: BSON field 'votes' value must be &lt;= 1, actual value '2'</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n332"><a class="md-toc-inner" href="#修改配置文件投票数）报错caused-by--priority-must-be-0-when-non-voting-votes0">修改配置文件（投票数）报错：caused by :: priority must be 0 when non-voting (votes:0)</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n334"><a class="md-toc-inner" href="#删除仲裁节点报错rejecting-reconfig-where-the-new-config-has-a-psa-topology-and-the-secondary-is-electable-but-the-old-config-contains-only-one-writable-node">删除仲裁节点报错：Rejecting reconfig where the new config has a PSA topology and the secondary is electable, but the old config contains only one writable node</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n348"><a class="md-toc-inner" href="#mongodb备份的磁盘占用备份时间局域网）">mongodb备份的磁盘占用，备份时间（局域网）。</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n385"><a class="md-toc-inner" href="#其他-n385">其他</a></span></p></div><h4><a name="全量备份差异备份增量备份" class="md-header-anchor"></a><span>全量备份、差异备份、增量备份</span></h4><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/03/DgjEA1mMVnc974i.jpg" referrerpolicy="no-referrer" alt="u=3157406177,12331095&amp;fm=253&amp;app=138&amp;f=JPEG"></p><p><span>看图写字：</span></p><h5><a name="资源占比" class="md-header-anchor"></a><span>资源占比</span></h5><p><span>如周日做了一个备份共 10G ，往后每天产生 1G 数据。在大数据的角度来看的话增量备份优势还是很大的。而且从时间上来看备份 1G 数据明显要比备份十几G数据所花费的时间要少。</span></p><p><span>备份占用空间：全量备份 &gt; 差异备份 &gt; 增量备份</span></p><p><span>备份花费时间：全量备份 &gt; 差异备份 &gt; 增量备份</span></p><figure><table><thead><tr><th>&nbsp;</th><th><span>一</span></th><th><span>二</span></th><th><span>三</span></th><th><span>四</span></th><th><span>五</span></th><th><span>六</span></th><th><span>总</span></th></tr></thead><tbody><tr><td><span>全量备份</span></td><td><span>10+1</span></td><td><span>11+1</span></td><td><span>12+1</span></td><td><span>13+1</span></td><td><span>14+1</span></td><td><span>15+1</span></td><td><span>81</span></td></tr><tr><td><span>差异备份</span></td><td><span>1</span></td><td><span>1+1</span></td><td><span>2+1</span></td><td><span>3+1</span></td><td><span>4+1</span></td><td><span>5+1</span></td><td><span>21</span></td></tr><tr><td><span>增量备份</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>1</span></td><td><span>6</span></td></tr></tbody></table></figure><h5><a name="还原复杂度" class="md-header-anchor"></a><span>还原复杂度</span></h5><p><span>为何要备份数据？备份就是为还原做准备的，那我们再看看这三种模式还原又有什么表现呢？</span></p><p><span>如周四数据出现问题，我们要将整个数据回退到周三前的数据。</span></p><p><span>备份还原复杂度：增量备份 &gt; 差异备份 &gt; 全量备份</span></p><figure><table><thead><tr><th>&nbsp;</th><th><span>备份还原操作</span></th></tr></thead><tbody><tr><td><span>全量备份</span></td><td><span>直接找到周三的（全量）备份，还原即可</span></td></tr><tr><td><span>差异备份</span></td><td><span>先找最近一次（周日）的全量备份A，再找周三的（差异）备份B。</span><br><span>先还原全量备份A，再还原差异备份B</span></td></tr><tr><td><span>增量备份</span></td><td><span>先找最近一次（周日）的全量备份A，再找周一到周三的增量备份（B、C、D）</span><br><span>先还原全量备份A，再还原差异备份B、C、D。顺序不能乱，也不要缺失任何一份增量备份数据</span></td></tr></tbody></table></figure><h5><a name="备份数据缺失" class="md-header-anchor"></a><span>备份数据缺失</span></h5><p><span>如周四数据出现问题，我们要将整个数据回退到周三前的数据，可周二的备份数据被删除了，或者周二备份失败了。这时候又会发生什么呢？</span></p><p><span>对于全量、差异备份，缺少周二的数据并没有太大影响，整体数据基本不会缺失；而对于增量备份，周二的数据无法恢复，整体数据会缺失周二的数据。</span></p><p><span>备份还原安全性：全量备份 &gt; 差异备份 &gt; 增量备份</span></p><p><span>掐头去尾取中间，大家都推荐用差异备份，如sql server默认的方式就是差异备份。而 mongodb 副本集有 oplog 的加持，做备份的时候大多都是增量备份，这也是我们今天要讲的内容。</span></p><h5><a name="其他" class="md-header-anchor"></a><span>其他</span></h5><p><strong><span>mongodb 单机无法做增量备份，只能做全量备份</span></strong></p><p><span>关于这三者的区别与介绍可参考：</span><a href='https://www.cnblogs.com/kevingrace/p/6098963.html'><span>全量备份/增量备份/差异备份说明 - 散尽浮华 - 博客园 (cnblogs.com)</span></a></p><h4><a name="工具准备" class="md-header-anchor"></a><span>工具准备</span></h4><p><span>OS：window</span></p><p><span>mongodb v5.0.3  下载地址：</span><a href='https://www.mongodb.com/try/download/community'><span>MongoDB Community Download | MongoDB</span></a></p><p><span>mongodump、mongorestore 下载地址：</span><a href='https://www.mongodb.com/try/download/database-tools'><span>Download MongoDB Command Line Database Tools | MongoDB</span></a></p><h4><a name="mongodump" class="md-header-anchor"></a><span>mongodump</span></h4><p><span>备份所有库</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mongodump</span> <span class="cm-operator">-</span><span class="cm-variable">h</span> <span class="cm-variable">链接地址</span>:<span class="cm-variable">端口</span> <span class="cm-operator">--</span><span class="cm-variable">oplog</span> <span class="cm-operator">-</span><span class="cm-variable">o</span> <span class="cm-variable">输出文件夹路径</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><strong><span>--oplog</span></strong><span>	</span><span>备份过程如果有插入数据，会将这些操作一起记到 oplog 文件，后续使用mongorestore 还原时指定 --oplogReplay 可以将全部数据还原，就不会出现漏数据的问题了。单机mongodb不能指定 --oplog 参数</span></p><p><strong><span>-o</span></strong><span>	</span><span>输出文件夹路径</span></p><p><strong><span>基本语法</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mongodump</span> <span class="cm-operator">-</span><span class="cm-variable">h</span> <span class="cm-variable">链接地址</span>:<span class="cm-variable">端口</span> <span class="cm-operator">-</span><span class="cm-variable">u</span> <span class="cm-variable">用户名</span> <span class="cm-operator">-</span><span class="cm-variable">p</span> <span class="cm-variable">密码</span> <span class="cm-operator">-</span><span class="cm-variable">d</span> <span class="cm-variable">数据库名称</span> <span class="cm-operator">-</span><span class="cm-variable">c</span> <span class="cm-variable">集合名称</span> <span class="cm-operator">-</span><span class="cm-variable">q</span> <span class="cm-variable">搜索条件</span> <span class="cm-operator">--</span><span class="cm-variable">oplog</span> <span class="cm-operator">-</span><span class="cm-variable">o</span> <span class="cm-variable">备份输出文件夹路径</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>-u</span></strong><span> 用户名  </span><strong><span>-p</span></strong><span> 密码</span><span>		</span><span>没有账号密码可不填</span></p><p><strong><span>-d</span></strong><span> 数据库名称  </span><strong><span>-c</span></strong><span> 集合名称</span><span>	</span><span>可不填，不填时默认备份全库全表</span></p><p><strong><span>-q</span></strong><span> 搜索条件</span><span>	</span><span>可不填，要填的话一定要指定</span><strong><span>-d -c</span></strong><span> 的参数，这个搜索条件就是 </span><strong><span>-c</span></strong><span> 指定表的搜索条件。这里要写成 json 字符串，一定要写双引号，双引号的内部双引号或特殊符号要记得转义，如：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span><span class="cm-variable">q</span> <span class="cm-string">"{\"name\":\"xiaoming\"}"</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><strong><span>-q</span></strong><span> 要符合 mongo 的 json ，</span><a href='https://github.com/mongodb/specifications/blob/master/source/extended-json.rst'><span>specifications/extended-json.rst at master · mongodb/specifications (github.com)</span></a><span>  如：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">use</span> <span class="cm-variable">local</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//举例：搜索local库oplog.rs集合中 ts小于1635929573 且 ns以test开头的记录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//mongodb 正常的搜索</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">db</span>.<span class="cm-property">oplog</span>.<span class="cm-property">rs</span>.<span class="cm-property">find</span>({<span class="cm-property">ts</span>:{<span class="cm-property">$gt</span>:<span class="cm-variable">Timestamp</span>(<span class="cm-number">1635929573</span>,<span class="cm-number">1</span>)},<span class="cm-property">ns</span>:<span class="cm-string-2">/^test/</span>})</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/IcqxlnvWh9sutkm.png" referrerpolicy="no-referrer" alt="image-20211106151311918"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//mongodump 的查询要写成</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">-</span><span class="cm-variable">q</span> <span class="cm-string">"{\"ts\":{\"$gt\":{\"$timestamp\":{\"t\":1635929573,\"i\":1}}},\"ns\":{\"$regex\":\"^test\"}}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 非转义  {"ts":{"$gt":{"$timestamp":{"t":1635929573,"i":1}}},"ns":{"$regex":"^test"}}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ***特别注意的是：这个-q的查询，用mongodb正常查询是查不出来记录的 如下：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// db.oplog.rs.find({"ts":{"$lt":{"$timestamp":{"t":1635929573,"i":1}}},"ns":{"$regex":"^test"}})</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// ***这样是查不出来记录的</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/8iM2LG4BuNgpWsr.png" referrerpolicy="no-referrer" alt="image-20211106151523389"></p><h4><a name="mongorestore" class="md-header-anchor"></a><span>mongorestore</span></h4><p><strong><span>基本语法</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="js"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="js"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">mongorestore</span> <span class="cm-operator">-</span><span class="cm-variable">h</span> <span class="cm-variable">链接地址</span>:<span class="cm-variable">端口</span> <span class="cm-operator">-</span><span class="cm-variable">u</span> <span class="cm-variable">用户名</span> <span class="cm-operator">-</span><span class="cm-variable">p</span> <span class="cm-variable">密码</span> <span class="cm-operator">-</span><span class="cm-variable">d</span> <span class="cm-variable">数据库名称</span> <span class="cm-operator">-</span><span class="cm-variable">c</span> <span class="cm-variable">集合名称</span> <span class="cm-operator">--</span><span class="cm-variable">drop</span> <span class="cm-operator">--</span><span class="cm-variable">oplogReplay</span> &nbsp;<span class="cm-variable">指定还原的文件夹路径</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>-u</span></strong><span> 用户名  </span><strong><span>-p</span></strong><span> 密码</span><span>		</span><span>没有账号密码可不填</span></p><p><strong><span>-d</span></strong><span> 数据库名称  </span><strong><span>-c</span></strong><span> 集合名称</span><span>	</span><span>指定还原某个库、某个表，可不填，不填默认还原全库全表</span></p><p><strong><span>--drop</span></strong><span> 还原过程中出现冲突时，先删除冲突数据，再进行还原。有时候还原过程中出现主键冲突时可以加上这个参数处理</span></p><p><strong><span>--oplogReplay</span></strong><span> 配合 mongodump 的  </span><strong><span>--oplog</span></strong><span>  参数使用，如果你的备份没有使用 </span><strong><span>--oplog</span></strong><span> ，那么还原的时候就不要指定  </span><strong><span>--oplogReplay </span></strong><span>参数</span></p><h4><a name="window-搭建mongodb-副本集" class="md-header-anchor"></a><span>window 搭建mongodb 副本集</span></h4><p><span>创建三个文件夹 rs1、rs2、rs3 ，分别代表三个 mongodb 服务</span></p><p><span>rs1 文件夹示例， rs2、rs3 基本都一样</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/Vy2oUxhFSuN57KA.png" referrerpolicy="no-referrer" alt="image-20211105144526790"></p><h5><a name="rs1" class="md-header-anchor"></a><span>rs1</span></h5><ol start='' ><li><span>创建 db 文件夹，一定要创建</span></li><li><span>创建 mongodb.conf 文件，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dbpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs1\db</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs1\mongodb.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logappend</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">journal</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">quiet</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port</span><span class="cm-operator">=</span><span class="cm-number">27007</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replSet <span class="cm-operator">=</span> testrs</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><ol start='3' ><li><span>创建 mongodb.log 文件，内容留空，一定要创建</span></li><li><span>创建 start.bat 文件，启动程序，双击即可开启 mongodb 服务，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> D:\Install\mongodb5\b<span class="cm-keyword">in</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongod <span class="cm-attribute">--config</span> D:\Install\mongos\rs1\mongodb.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><h5><a name="rs2" class="md-header-anchor"></a><span>rs2</span></h5><ol start='' ><li><span>创建 db 文件夹，一定要创建</span></li><li><span>创建 mongodb.conf 文件，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dbpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs2\db</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs2\mongodb.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logappend</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">journal</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">quiet</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port</span><span class="cm-operator">=</span><span class="cm-number">27008</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replSet <span class="cm-operator">=</span> testrs</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><ol start='3' ><li><span>创建 mongodb.log 文件，内容留空，一定要创建</span></li><li><span>创建 start.bat 文件，启动程序，双击即可开启 mongodb 服务，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> D:\Install\mongodb5\b<span class="cm-keyword">in</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongod <span class="cm-attribute">--config</span> D:\Install\mongos\rs2\mongodb.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><h5><a name="rs3" class="md-header-anchor"></a><span>rs3</span></h5><ol start='' ><li><span>创建 db 文件夹，一定要创建</span></li><li><span>创建 mongodb.conf 文件，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dbpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs3\db</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs3\mongodb.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logappend</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">journal</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">quiet</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port</span><span class="cm-operator">=</span><span class="cm-number">27009</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replSet <span class="cm-operator">=</span> testrs</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><ol start='3' ><li><span>创建 mongodb.log 文件，内容留空，一定要创建</span></li><li><span>创建 start.bat 文件，启动程序，双击即可开启 mongodb 服务，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> D:\Install\mongodb5\b<span class="cm-keyword">in</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongod <span class="cm-attribute">--config</span> D:\Install\mongos\rs3\mongodb.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><h5><a name="启动rs1rs2rs3" class="md-header-anchor"></a><span>启动rs1、rs2、rs3</span></h5><p><span>分别双击 rs1、rs2、rs3 文件夹下的 start.bat 即可启动</span></p><h5><a name="配置添加节点" class="md-header-anchor"></a><span>配置添加节点</span></h5><p><span>打开 cmd 窗口，按顺序执行以下命令</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#进入到 mongodb环境</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切到admin库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># priority 优先级 同等条件下优先级越高  越容易被选举为主节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># arbiterOnly 该节点为仲裁节点，仅用于内部选举，无法读写数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cfg</span><span class="cm-operator">=</span>{ _id:<span class="cm-string">"testrs"</span>, members:[ {_id:0,host:<span class="cm-string">'localhost:27007'</span>,priority:2}, {_id:1,host:<span class="cm-string">'localhost:27008'</span>,priority:1}, {_id:2,host:<span class="cm-string">'localhost:27009'</span>,arbiterOnly:true}] };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.initiate(cfg)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 322px;"></div><div class="CodeMirror-gutters" style="display: none; height: 322px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/G6Sh2QyfVZUCFXg.png" referrerpolicy="no-referrer" alt="image-20211105144922792"></p><h4><a name="题外）将mongodb加入window服务开机自启动" class="md-header-anchor"></a><span>（题外）将mongodb加入window服务，开机自启动</span></h4><p><span>上面的 start.bat 启动的时候会留一个 cmd 窗口，一旦关闭这个窗口 mongodb 服务就无法访问了，对此我们可以将 mongodb 加到 window 服务，这样就比较方便了，以 rs1 为例，右键以管理员身份运行 startService.bat 即可。</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/PWLDUqNBzyVGedh.png" referrerpolicy="no-referrer" alt="image-20211108175325749"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">D:\Install\mongodb5\b<span class="cm-keyword">in</span>\mongod.exe <span class="cm-attribute">--config</span> <span class="cm-string">"D:\Install\mongos\rs1\mongodb.conf"</span> <span class="cm-attribute">--install</span> <span class="cm-attribute">--serviceName</span> <span class="cm-string">"mongoDBr1"</span> <span class="cm-attribute">--serviceDisplayName</span> <span class="cm-string">"mongoDBr1"</span> <span class="cm-attribute">--serviceDescription</span> <span class="cm-string">"mongoDBr1"</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">net <span class="cm-builtin">start</span> mongoDBr1</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><strong><span>--config</span></strong><span>	</span><span>指定配置文件</span></p><p><strong><span>--install</span></strong><span>	</span><span>安装为 window 服务</span></p><p><strong><span>--serviceName</span></strong><span>	</span><span>指定服务名  net start mongoDBr1 就是这个服务名</span></p><p><strong><span>--serviceDisplayName</span></strong><span>	</span><span>指定服务显示名   在服务列表显示的名称</span></p><p><strong><span>--serviceDescription</span></strong><span>	</span><span>指定服务描述   在服务列表显示的服务描述</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/gezQ9vuqOBDKSsR.png" referrerpolicy="no-referrer" alt="image-20211108180531686"></p><h4><a name="window-mongodb-测试全量备份增量备份与还原" class="md-header-anchor"></a><span>window mongodb 测试全量备份、增量备份与还原</span></h4><p><span>再开一个 cmd 窗口，执行备份与还原操作（一定要开 cmd 窗口，不要开 powershell ，powerShell 执行 mongodump 和 mongorestore  命令会出现错误）。这个窗口不需要进入到 mongodb 环境</span></p><h5><a name="数据准备1" class="md-header-anchor"></a><span>数据准备1</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换到test 库</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use test</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># for循环 写入1001条数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(var <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;i&lt;<span class="cm-operator">=</span><span class="cm-number">1000</span>;i<span class="cm-operator">++</span>){db.user.insert({name:<span class="cm-string">'num'</span><span class="cm-operator">+</span>i})}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/pkHCjysV91QZRBb.png" referrerpolicy="no-referrer" alt="image-20211105145331314"></p><h5><a name="全量备份" class="md-header-anchor"></a><span>全量备份</span></h5><p><span>先执行一次全量备份</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongodump <span class="cm-attribute">-h</span> localhost:27007 <span class="cm-attribute">--oplog</span> <span class="cm-attribute">-o</span> D:\Install\mongos\backup\backup_20211105\full</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/TdJkPjGLaF1Hs5i.png" referrerpolicy="no-referrer" alt="image-20211105145948133"></p><h5><a name="数据准备2" class="md-header-anchor"></a><span>数据准备2</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># for循环 再写入1001条数据</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span>(var <span class="cm-def">i</span><span class="cm-operator">=</span><span class="cm-number">0</span>;i&lt;<span class="cm-operator">=</span><span class="cm-number">1000</span>;i<span class="cm-operator">++</span>){db.user.insert({name:<span class="cm-string">'number'</span><span class="cm-operator">+</span>i})}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/4L6abiC5IQkdw2E.png" referrerpolicy="no-referrer" alt="image-20211105150221714"></p><h5><a name="增量备份" class="md-header-anchor"></a><span>增量备份</span></h5><p><span>首先增量备份有两个很重要的时间点：上次备份时间，当前时间。</span></p><p><span>如定时每天零点执行增量备份，我们上一次备份时间为：2021-08-08 00:00:00 ，那么我们</span></p><p><span>这次备份的时间段应该是 2021-08-08 00:00:00 至 2021-08-09 00:00:00，</span></p><p><span>下一次备份时间点是 2021-08-09 00:00:00 至  2021-08-10 00:00:00。</span></p><p><span>如果我们不记得上一次备份时间，我们可以通过bsondump来解析oplog.bson文件，取得上次备份（全量备份）的时间戳为：1636095484，当前时间戳为：1636099300</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#  在执行mongodump 时指定 --oplog才会生成 oplog.bson 文件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bsondump D:\Install\mongos\backup\backup_20211105\full\oplog.bson</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/sCAeiSHDMLkVTfy.png" referrerpolicy="no-referrer" alt="image-20211105175737841"></p><p><span>执行增量备份，不要用 powerShell 执行，用 cmd、用 cmd、用 cmd</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongodump <span class="cm-attribute">-h</span> localhost:27007 <span class="cm-attribute">-d</span> local <span class="cm-attribute">-c</span> oplog.rs <span class="cm-attribute">--query</span> <span class="cm-string">"{\"ts\":{\"</span><span class="cm-def">$lt</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":1636099300,\"i\":1}},\"</span><span class="cm-def">$gte</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":1636095484,\"i\":1}}},\"ns\":{\"</span><span class="cm-def">$regex</span><span class="cm-string">\":\"^test\"}}"</span> <span class="cm-attribute">-o</span> D:\Install\mongos\backup\backup_oplog_202111051601</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><strong><span>-d local -c oplog.rs</span></strong><span>	</span><span>备份 local 库 oplog.rs 表下的记录</span></p><p><strong><span>ts</span></strong><span>	</span><span>仅备份 ts 大于等于 1636095484 小于 1636099300 </span></p><p><strong><span>ns</span></strong><span>   仅备份 test 开头</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/AoJagKmyRL7X6nB.png" referrerpolicy="no-referrer" alt="image-20211105181541888"></p><h5><a name="删除测试记录不要在生产环境测试" class="md-header-anchor"></a><span>删除测试记录，不要在生产环境测试！！！</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除user 表</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.user.drop()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/iKRb1yMO23Fkvcd.png" referrerpolicy="no-referrer" alt="image-20211105182144279"></p><h5><a name="还原全量备份" class="md-header-anchor"></a><span>还原全量备份</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 还原路径 全量备份指定的是什么路径  这里就填什么路径</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongorestore <span class="cm-attribute">-h</span> localhost:27007 <span class="cm-attribute">--drop</span> <span class="cm-attribute">--oplogReplay</span> D:\Install\mongos\backup\backup_20211105\full</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/CKaWryJDRpwPTSL.png" referrerpolicy="no-referrer" alt="image-20211105182726727"></p><p><span>上图已还原 1001 条文档，我们来验证一下，还原成功</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/rQ7Be5FVh63Gml4.png" referrerpolicy="no-referrer" alt="image-20211105182925847"></p><h5><a name="还原增量备份" class="md-header-anchor"></a><span>还原增量备份</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 还原路径 增量备份指定的是什么路径  这里就填什么路径</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongorestore <span class="cm-attribute">-h</span> localhost:27007 <span class="cm-attribute">--oplogReplay</span> D:\Install\mongos\backup\backup_oplog_202111051601</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/sznlvVOuhyD2wTP.png" referrerpolicy="no-referrer" alt="image-20211105183148875"></p><p><span>上图已回放 1001 条  oplog 记录，我们再来验证一下，还原成功</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/05/To4ur5RtvbmpVnk.png" referrerpolicy="no-referrer" alt="image-20211105183410972"></p><p><span>还原增量备份的时候要注意，一定要按照时间先后顺序还原，而且增量备份不可缺失，否则会造成数据缺失或者还原失败。</span></p><h4><a name="参考资料" class="md-header-anchor"></a><span>参考资料</span></h4><p><span>mongodb的备份与还原，以及下面的这两个 bat 执行文件都是参考这个博客：</span><a href='https://blog.csdn.net/yumikobu/article/details/83623992'><span> windows下mongodb增量备份方案_芊芊寻的博客-CSDN博客</span></a></p><p><span>可能是我 mongodb 版本（v5.0.3）太高的原因，我按照这些博客进行测试时，不是很顺利，所以重新梳理了一番。</span></p><p><span>更多 mongodump 和 mongorestore 命令可参考：</span></p><p><a href='https://www.cnblogs.com/nanxiang/p/15269540.html'><span>mongodump/mongorestore命令详解 - 柴米油盐酱醋 - 博客园 (cnblogs.com)</span></a></p><p><a href='https://www.cnblogs.com/xiaoyaojinzhazhadehangcheng/articles/15098062.html'><span>MongoDB 逻辑备份工具mongodump--转发 - 北方客888 - 博客园 (cnblogs.com)</span></a></p><p><span>也可以查阅官方文档：</span></p><p><a href='https://docs.mongodb.com/database-tools/mongodump/'><span>mongodump — MongoDB Database Tools</span></a></p><p><a href='https://docs.mongodb.com/database-tools/mongorestore/'><span>mongorestore — MongoDB Database Tools</span></a></p><p><a href='https://docs.mongodb.com/database-tools/bsondump/'><span>bsondump — MongoDB Database Tools</span></a></p><h4><a name="window-mongodb自动备份" class="md-header-anchor"></a><span>window mongodb自动备份</span></h4><p><span>全量备份：一月一次，每月一号凌晨两点</span></p><p><span>增量备份：一天一次，每天零点</span></p><h5><a name="全量备份-backupallbat" class="md-header-anchor"></a><span>全量备份 backupAll.bat</span></h5><p><span>替换里面的相关路径和端口即可，执行一次会将本次执行的时间戳记录到 timestamp.txt ，供全量备份后的第一次增量备份使用。（可能有 bug ，如果 mongodump 执行很久，这个时间戳会提前，不知道 oplog 回放会不会受影响，上次测试单机 mongodb 备份 1T 的数据需要36个小时左右...）</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rem ******Mongodb full backup <span class="cm-builtin">start</span>******</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@echo off</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-string">"Ymd=%date:~0,4%%date:~5,2%%date:~8,2%0%time:~0,2%%time:~3,2%%time:~6,2%"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-def">backupFile</span><span class="cm-operator">=</span>D:\Install\mongos\backup\backup_%Ymd%\full\</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">md %backupFile%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【全量备份】备份文件夹：%backupFile% &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【全量备份】命令： <span class="cm-string">"D:\Install\mongodb5\bin\mongodump.exe"</span> <span class="cm-attribute">--host</span><span class="cm-operator">=</span>localhost <span class="cm-attribute">--port</span><span class="cm-operator">=</span><span class="cm-number">27007</span> <span class="cm-attribute">--oplog</span> <span class="cm-attribute">-o</span> D:\Install\mongos\backup\backup_%Ymd%\full\ &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"D:\Install\mongodb5\bin\mongodump.exe"</span> <span class="cm-attribute">--host</span><span class="cm-operator">=</span>localhost <span class="cm-attribute">--port</span><span class="cm-operator">=</span><span class="cm-number">27007</span> <span class="cm-attribute">--oplog</span> <span class="cm-attribute">-o</span> D:\Install\mongos\backup\backup_%Ymd%\full\</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-string">"TimeNow=%date:~0,4%-%date:~5,2%-%date:~8,2% %time:~0,2%:%time:~3,2%:%time:~6,2%"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【全量备份】成功。时间为：%TimeNow% &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:: 记录当前全备份的时间戳</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> wscript.echo DateDiff(<span class="cm-string">"s"</span>, <span class="cm-string">"01/01/1970 00:00:00"</span>, Now())&gt;D:\Install\mongos\sjc.vbs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> /f %%i <span class="cm-keyword">in</span> (<span class="cm-string">'cscript sjc.vbs /nologo'</span>) <span class="cm-keyword">do</span> <span class="cm-keyword">set</span> <span class="cm-def">endDate</span><span class="cm-operator">=</span>%%i</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rem 减掉8小时时差</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> /a <span class="cm-string">"endDate=%endDate%-28800"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> %endDate% &gt;D:\Install\mongos\timestamp.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@echo on</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rem ******Mongodb full backup end******</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 736px;"></div><div class="CodeMirror-gutters" style="display: none; height: 736px;"></div></div></div></pre><h5><a name="增量备份-backupoplogbat" class="md-header-anchor"></a><span>增量备份 backupOplog.bat</span></h5><p><span>如果存在 D:\Install\mongos\timestamp.txt 则 &quot;上一次时间A&quot; 取 timestamp.txt 内记录的时间戳，若不存在则 将当前时间减去 24 小时，得到&quot;上一次时间A&quot;（1天一次增量备份）</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rem ******MongoDB backup <span class="cm-builtin">start</span>********</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@echo off&amp;setlocal enabledelayedexpansion</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> wscript.echo DateDiff(<span class="cm-string">"s"</span>, <span class="cm-string">"01/01/1970 00:00:00"</span>, Date())&gt;D:\Install\mongos\sjc.vbs</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> /f %%i <span class="cm-keyword">in</span> (<span class="cm-string">'cscript sjc.vbs /nologo'</span>) <span class="cm-keyword">do</span> <span class="cm-keyword">set</span> <span class="cm-def">endDate</span><span class="cm-operator">=</span>%%i</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:: 减8小时 &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> /a <span class="cm-string">"endDate=%endDate%-28800"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">:: <span class="cm-number">86400</span> 减一天<span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-number">3600</span> 减一个小时<span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-number">300</span> 减5分钟</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> /a <span class="cm-string">"startDate=%endDate%-86400"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-def">timeFile</span><span class="cm-operator">=</span>D:\Install\mongos\timestamp.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">if</span> exist %timeFile% (</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>rem 读取文件第一列</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">for</span> /f %%a <span class="cm-keyword">in</span> (%timeFile%) <span class="cm-keyword">do</span> <span class="cm-keyword">set</span> <span class="cm-def">startDate</span><span class="cm-operator">=</span>%%a</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>:: 删除txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>del %timeFile%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-string">"Ymd=%date:~0,4%%date:~5,2%%date:~8,2%%time:~0,2%%time:~3,2%%time:~6,2%"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-def">backupFile</span><span class="cm-operator">=</span>D:\Install\mongos\backup\backup_oplog_%Ymd%\</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">md %backupFile%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> %startDate%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【增量备份】时间为：%startDate% 至 %endDate%，备份文件夹：%backupFile% &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【增量备份】命令：<span class="cm-string">"D:\Install\mongodb5\bin\mongodump.exe"</span> <span class="cm-attribute">--host</span><span class="cm-operator">=</span>localhost <span class="cm-attribute">--port</span><span class="cm-operator">=</span><span class="cm-number">27007</span> <span class="cm-attribute">-d</span> local <span class="cm-attribute">-c</span> oplog.rs <span class="cm-attribute">--query</span> <span class="cm-string">"{\"ts\":{\"</span><span class="cm-def">$lt</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":%endDate%,\"i\":1}},\"</span><span class="cm-def">$gt</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":%startDate%,\"i\":1}}},\"ns\":{\"</span><span class="cm-def">$regex</span><span class="cm-string">\":\"^test\"}}"</span> <span class="cm-attribute">-o</span> %backupFile% &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"D:\Install\mongodb5\bin\mongodump.exe"</span> <span class="cm-attribute">--host</span><span class="cm-operator">=</span>localhost <span class="cm-attribute">--port</span><span class="cm-operator">=</span><span class="cm-number">27007</span> <span class="cm-attribute">-d</span> local <span class="cm-attribute">-c</span> oplog.rs <span class="cm-attribute">--query</span> <span class="cm-string">"{\"ts\":{\"</span><span class="cm-def">$lt</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":%endDate%,\"i\":1}},\"</span><span class="cm-def">$gte</span><span class="cm-string">\":{\"</span><span class="cm-def">$timestamp</span><span class="cm-string">\":{\"t\":%startDate%,\"i\":1}}},\"ns\":{\"</span><span class="cm-def">$regex</span><span class="cm-string">\":\"^test\"}}"</span> <span class="cm-attribute">-o</span> %backupFile%</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">set</span> <span class="cm-string">"TimeNow=%date:~0,4%-%date:~5,2%-%date:~8,2% %time:~0,2%:%time:~3,2%:%time:~6,2%"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">echo</span> 【增量备份】成功。时间为：%TimeNow% &gt;&gt;D:\Install\mongos\log.txt</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">@echo on</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rem ******MongoDB backup end********</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1081px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1081px;"></div></div></div></pre><p><span>打开任务计划程序，建立任务让 window 自动执行这两个 bat 执行文件就好了。</span></p><h5><a name="window任务计划定时执行全量备份" class="md-header-anchor"></a><span>window任务计划定时执行全量备份</span></h5><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/XbZOr9lM8gxUECP.png" referrerpolicy="no-referrer" alt="image-20211106100940794"></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/rMinHZOjdhgoy97.png" referrerpolicy="no-referrer" alt="image-20211106101050576"></p><p><span>这里开始时间选择凌晨2点，月份选择全部月份，天选择1，即每月一号凌晨两点执行一次全量备份</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/PyQUw34BlJWbRsC.png" referrerpolicy="no-referrer" alt="image-20211106140053797"></p><p><span>选择 bat 执行文件</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/KdokDtQjiRZV6AM.png" referrerpolicy="no-referrer" alt="image-20211106115205247"></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/M41tLsFkVlxOUfh.png" referrerpolicy="no-referrer" alt="image-20211106115114059"></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/tL1wsHUa4fYNgZD.png" referrerpolicy="no-referrer" alt="image-20211106120235571"></p><p><span>这个列表需要关注两列，一列是下次运行时间栏，还有就是状态栏。为了测试我们可以直接选中任务，右键执行一次看看是否成功。</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/UN5pBZ6eIOgXmsl.png" referrerpolicy="no-referrer" alt="image-20211106120712830"></p><h5><a name="window任务计划定时执行增量备份" class="md-header-anchor"></a><span>window任务计划定时执行增量备份</span></h5><p><span>和上面的步骤没多大区别，主要是时间选择那里调整一下就可以了。</span></p><p><span>如下图参数，每天零点执行一次增量备份</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/WZtuBL2em9GPi7x.png" referrerpolicy="no-referrer" alt="image-20211106135940906"></p><h4><a name="mongodb副本集如何添加删除新节点呢" class="md-header-anchor"></a><span>mongodb副本集如何添加、删除新节点呢？</span></h4><p><span>如增加 rs4 ，测试后再将其删除。默认只有主节点可以添加、删除新节点</span></p><h5><a name="rs4" class="md-header-anchor"></a><span>rs4</span></h5><ol start='' ><li><span>创建 db 文件夹，一定要创建</span></li><li><span>创建 mongodb.conf 文件，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dbpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs4\db</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logpath</span><span class="cm-operator">=</span>D:\Install\mongos\rs4\mongodb.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logappend</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">journal</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">quiet</span><span class="cm-operator">=</span><span class="cm-atom">true</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port</span><span class="cm-operator">=</span><span class="cm-number">27010</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replSet <span class="cm-operator">=</span> testrs</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><ol start='3' ><li><span>创建 mongodb.log 文件，内容留空，一定要创建</span></li><li><span>创建 start.bat 文件，启动程序，双击即可开启 mongodb 服务，内容为</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cd</span> D:\Install\mongodb5\b<span class="cm-keyword">in</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongod <span class="cm-attribute">--config</span> D:\Install\mongos\rs4\mongodb.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>双击 start.bat 启动 s4 mongodb 服务</span></p><h5><a name="添加新节点" class="md-header-anchor"></a><span>添加新节点</span></h5><p><span>打开 cmd 依次执行以下命令</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 连接到主节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 27010为rs4的端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看副本集状态和成员信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/aDuL2TFVkOfhYIr.png" referrerpolicy="no-referrer" alt="image-20211106142855866"></p><h5><a name="验证添加新节点是否成功" class="md-header-anchor"></a><span>验证添加新节点是否成功</span></h5><p><span>依次执行以下命令</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27010</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 接受成为副本节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.secondaryOk()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切换到test 库</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use test</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查询 有数据则成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.user.find().count()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/2UYvmRw6MQKdlJi.png" referrerpolicy="no-referrer" alt="image-20211106143330468"></p><h5><a name="删除副本节点" class="md-header-anchor"></a><span>删除副本节点</span></h5><p><span>依次执行以下命令</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 连接到主节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 27010为rs4的端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看副本集状态和成员信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/xqDuf1EbVvdG8wi.png" referrerpolicy="no-referrer" alt="image-20211106143546575"></p><h5><a name="删除副本节点-注意事项" class="md-header-anchor"></a><span>删除副本节点 注意事项</span></h5><p><span>如果我们的副本节点一共只有三个节点（一主一副一仲裁），那么我们删除节点时</span><strong><span>不能直接删除</span></strong></p><p><span>如当我们副本集只有三个节点，我们要删除 27008 副本节点，如何实现？</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加 27010 节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost: 27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前副本集节点个数 4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除 27008 节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27008"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看副本集状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/X5xnKyTi64AUEzO.png" referrerpolicy="no-referrer" alt="image-20211108121439321"></p><h5><a name="删除节点错误示范" class="md-header-anchor"></a><span>删除节点错误示范***</span></h5><p><span>那如果直接删除27008节点会怎么样呢？</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前副本集节点个数 &nbsp; </span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除 27008 节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27008"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看副本集状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 138px;"></div><div class="CodeMirror-gutters" style="display: none; height: 138px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/qK2lcaeRsxjbF93.png" referrerpolicy="no-referrer" alt="image-20211108122007657"></p><p><span>上述代码执行成功后确实已经将 27008 节点成功删除，但是我们再去添加新节点或者删除 27009 节点时都是失败的。但是仍然可以操作数据库，这种可以修改当前的写关注。下面有</span></p><p><span>rs.add(&quot;&quot;)</span><span>	</span><span>添加节点无反应是直接删除 27008 节点造成的。</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/ErpfqtFZvnBDHP1.png" referrerpolicy="no-referrer" alt="image-20211108122822166"></p><h4><a name="单机-mongodb-如何变成副本集呢" class="md-header-anchor"></a><span>单机 mongodb 如何变成副本集呢？</span></h4><p><span>如 rs1 原本为单机 mongodb ，我们要怎样在 rs1 的数据基础上搭建集群呢？</span></p><p><span>其实很简单的，我们只需要在 rs1 的 mongodb.conf  文件加一项配置：replSet = testrs，然后再将 rs2、rs3 一起加进来即可</span></p><h4><a name="mongodb如何做差异备份呢" class="md-header-anchor"></a><span>mongodb如何做差异备份呢？</span></h4><p><span>虽然没有人这样做，但是如果非要这样做的话，我想应该也是很简单的。</span></p><p><span>我们只需要记住全量备份的时间戳A，后续的备份都用这个时间戳A来判断，一直到下一次全量备份如下：</span></p><p><span>第一次差异备份的时间段：时间戳A 至 第一次备份的当前时间</span></p><p><span>第二次差异备份的时间段：时间戳A 至 第二次备份的当前时间</span></p><p><span>第三次差异备份的时间段：时间戳A 至 第三次备份的当前时间</span></p><p><span>...</span></p><p>&nbsp;</p><h4><a name="其他问题" class="md-header-anchor"></a><span>其他问题</span></h4><h5><a name="this-node-was-not-started-with-the-replset-option" class="md-header-anchor"></a><span>This node was not started with the replSet option</span></h5><p><span>这个节点没有设置 replSet ，通常是你本地运行了一个端口为 27017 的单机 mongodb 程序，然后你的集群里面又有 27017 节点，所以要么改 27017 节点的端口，要么杀死 27017 的程序</span></p><h5><a name="failed-bad-option---oplog-mode-only-supported-on-full-dumps" class="md-header-anchor"></a><span>Failed: bad option: --oplog mode only supported on full dumps</span></h5><p><span>--oplog  仅支持全库备份</span></p><p><a href='https://stackoverflow.com/questions/23682867/mongodump-with-replica-set-with-oplog-throws-error-oplog-mode-is-only-supporte'><span>mongodb - mongodump with replica set with oplog throws error: &quot;oplog mode is only supported on full dumps&quot; - Stack Overflow</span></a></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/10/30/erFKjac613mdPiG.png" referrerpolicy="no-referrer" alt="image-20211030171446560"></p><h5><a name="failed-no-oplog-file-to-replay-make-sure-you-run-mongodump-with---oplog" class="md-header-anchor"></a><span>Failed: no oplog file to replay; make sure you run mongodump with --oplog</span></h5><p><span>没有 oplog 可以回放，所以这个 mongorestore  命令不要指定  --oplogReplay 参数。</span></p><p><span>--oplog 和 --oplogReplay 是一起出现的，当然了，增量备份不允许指定 --oplog 参数，但在全量备份指定 --oplog 参数情况下，还原增量备份却可以指定 --oplogReplay 参数</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongodump <span class="cm-attribute">--oplog</span> .....<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">#生成 oplog 文件</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongorestore <span class="cm-attribute">--oplogReplay</span> ....<span class="cm-tab" role="presentation" cm-text="	"> </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">#回放 oplog</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/10/30/U3qGkS4FbAnPcpK.png" referrerpolicy="no-referrer" alt="image-20211030171429805"></p><h5><a name="mongorestore-恢复失败插入主键冲突" class="md-header-anchor"></a><span>mongorestore 恢复失败。插入主键冲突</span></h5><p><span>mongorestore 指定 --drop 参数。当还原发生冲突，先删除冲突项再进行还原</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/10/30/JPvXKNAw2ZYs7qI.png" referrerpolicy="no-referrer" alt="image-20211030172336449"></p><h5><a name="not-master-and-slaveokfalse" class="md-header-anchor"></a><span>not master and slaveOk=false</span></h5><p><span>刚搭建好的副本集，副本节点要先执行 rs.secondaryOk()  命令才可以读取数据。</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/10/30/notumfLlSk1C87I.png" referrerpolicy="no-referrer" alt="image-20211030173858416"></p><h5><a name="not-master--notwritableprimary" class="md-header-anchor"></a><span>not master  NotWritablePrimary</span></h5><p><span>副本节点无法写入</span></p><h5><a name="new-config-is-rejected--caused-by--replsetreconfig-should-only-be-run-on-a-writable-primary-current-state-secondary" class="md-header-anchor"></a><span>New config is rejected :: caused by :: replSetReconfig should only be run on a writable PRIMARY. Current state SECONDARY;</span></h5><p><span>副本节点无法添加、删除节点</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/06/unhwzGvNl5MIi4a.png" referrerpolicy="no-referrer" alt="image-20211106142807403"></p><h5><a name="reconfig-attempted-to-install-a-config-that-would-change-the-implicit-default-write-concern-use-the-setdefaultrwconcern-command-to-set-a-cluster-wide-write-concern-and-try-the-reconfig-again	删除仲裁副）节点报错" class="md-header-anchor"></a><span>Reconfig attempted to install a config that would change the implicit default write concern. Use the setDefaultRWConcern command to set a cluster-wide write concern and try the reconfig again</span><span>	</span><span>删除仲裁（副）节点报错</span></h5><p><span>删除仲裁（副）节点报错，默认情况一主一副一仲裁下无法直接删除仲裁（副）节点</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 先修改写关注</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.adminCommand({</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"setDefaultRWConcern"</span> : <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-string">"defaultWriteConcern"</span> : {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string">"w"</span> : <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除仲裁节点 27009</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27009"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/tSAU81JxDjwRYpX.png" referrerpolicy="no-referrer" alt="image-20211108144519663"></p><h5><a name="如何将副节点转成仲裁节点仲裁节点转成副节点" class="md-header-anchor"></a><span>如何将副节点转成仲裁节点，仲裁节点转成副节点，</span></h5><p><strong><span>不能直接改配置文件</span></strong><span>，要先将该副节点移除，然后再以仲裁节点的身份加回来，这里仅演示 </span><strong><span>副节点转成仲裁节点</span></strong><span> 这两个都是一样的逻辑</span></p><p><span>New and old configurations differ in the setting of the arbiterOnly field for member localhost:27008; to make this change, remove then re-add the member</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/PqG6xmQ1f7BoSkU.png" referrerpolicy="no-referrer" alt="image-20211108145212638"></p><p><span>如三个节点（一主两副）将一个副节点 27008 转成仲裁节点。</span></p><ol start='' ><li><span>先加一个副本节点 27010</span></li><li><span>再移除副节点 27008（为什么不直接移除请看下面一个问题）</span></li><li><span>再将27008添加为仲裁节点（添加前应先把db文件夹删除了，可以减少磁盘空间）</span></li><li><span>最后删除新增的副本节点27010。</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前节点数 3</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加一个新副本节点 27010 &nbsp;  一定要是副本节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前节点数 4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除副本节点 27008</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27008"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加仲裁节点 27008</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.addArb(<span class="cm-string">"localhost:27008"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除新增的副本节点 27010</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27010"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 276px;"></div><div class="CodeMirror-gutters" style="display: none; height: 276px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/ETKnDC69AW8JSBL.png" referrerpolicy="no-referrer" alt="image-20211108155148239"></p><h5><a name="quorum-check-failed-because-not-enough-voting-nodes-responded-required-2-but-only-the-following-1-voting-nodes-responded-localhost27007-the-following-nodes-did-not-respond-affirmatively-localhost27009-failed-with-error-connecting-to-localhost27009-12700127009" class="md-header-anchor"></a><span>Quorum check failed because not enough voting nodes responded; required 2 but only the following 1 voting nodes responded: localhost:27007; the following nodes did not respond affirmatively: localhost:27009 failed with Error connecting to localhost:27009 (127.0.0.1:27009)</span></h5><p><span>三个节点（一主两副）移除副节点失败。移除了一个那么剩下两个节点，会出现平票的现象（1：1）。这时我们不要去改配置文件里面的投票数，应该再加一个节点（最好是添加副节点，其实大家都不建议用仲裁节点的），然后再将目标节点移除</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前节点数 3</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加一个新节点 27010</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.addArb(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前节点数 4</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 移除仲裁节点 27008</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27008"</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 184px;"></div><div class="CodeMirror-gutters" style="display: none; height: 184px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/ulPr29NJQv6VnyW.png" referrerpolicy="no-referrer" alt="image-20211108151143087"></p><h5><a name="修改配置文件投票数）报错caused-by--bson-field-votes-value-must-be--1-actual-value-2" class="md-header-anchor"></a><span>修改配置文件（投票数）报错：caused by :: BSON field &#39;votes&#39; value must be &lt;= 1, actual value &#39;2&#39;</span></h5><p><span>节点的投票数不能大于1</span></p><h5><a name="修改配置文件投票数）报错caused-by--priority-must-be-0-when-non-voting-votes0" class="md-header-anchor"></a><span>修改配置文件（投票数）报错：caused by :: priority must be 0 when non-voting (votes:0)</span></h5><p><span>节点的投票数如果为0，那么他的优先级也要设为0</span></p><h5><a name="删除仲裁节点报错rejecting-reconfig-where-the-new-config-has-a-psa-topology-and-the-secondary-is-electable-but-the-old-config-contains-only-one-writable-node" class="md-header-anchor"></a><span>删除仲裁节点报错：Rejecting reconfig where the new config has a PSA topology and the secondary is electable, but the old config contains only one writable node</span></h5><p><span>如在四个节点（一主一副两仲裁）副本集中删除 27008 仲裁节点（变成一主一副一仲裁） 。</span></p><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/osrRqdKbMvyH2ih.png" referrerpolicy="no-referrer" alt="image-20211108152856863"></p><p><span>只要加一个新的副本节点就可以解决了。</span></p><ol start='' ><li><span>先加一个副本节点27011</span></li><li><span>再删目标仲裁节点27008</span></li><li><span>再删除新加的副本节点27011。</span></li></ol><p><span>其实好多问题都是出现在偶数节点的情况，这也是大家</span><strong><span>不建议用偶数节点</span></strong><span>的原因。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 原节点数 4</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加副本节点 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27011"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除目标仲裁节点 27008</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27008"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除新加的副本节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27011"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 当前节点数 3 一主一副一仲裁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf().members.length</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/VeTr98O3GwKgco5.png" referrerpolicy="no-referrer" alt="image-20211108153217007"></p><h5><a name="mongodb备份的磁盘占用备份时间局域网）" class="md-header-anchor"></a><span>mongodb备份的磁盘占用，备份时间（局域网）。</span></h5><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/TUNBWeLEAj1F6cs.png" alt="image-20211108160706321" style="zoom:50%;" /></p><figure><table><thead><tr><th><span>总文件大小：750G</span></th><th><span>时间</span></th><th><span>备份文件大小</span></th></tr></thead><tbody><tr><td><span>单机 mongodump</span></td><td><span>36小时</span></td><td><span>800G</span></td></tr><tr><td><span>副本集 mongodump --oplog xxx</span></td><td><span>45个小时</span></td><td><span>1.2T</span></td></tr></tbody></table></figure><p><img src="../../Image/loading.gif" data-src="https://i.loli.net/2021/11/08/djJhQZeXD6UtpIw.png" alt="image-20211108161433801" style="zoom:50%;" /></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p><span>总数据大小：750G，在这个数据的基础上搭建副本集，一主一副一仲裁。</span></p><figure><table><thead><tr><th><span>总文件大小：750G</span></th><th><span>主节点服务器</span></th><th><span>副节点服务器</span></th><th><span>仲裁节点服务器</span></th></tr></thead><tbody><tr><td><span>全量备份前</span></td><td><span>750G</span></td><td><span>300M</span></td><td><span>300M</span></td></tr><tr><td><span>全量备份后</span></td><td><span>750G</span></td><td><span>400G</span></td><td><span>310M</span></td></tr></tbody></table></figure><p><span>不知道后面主节点和副节点服务器占用磁盘看见会不会基本持平，仲裁节点不需要耗费太大资源，所以预算少的话，一主一副一仲裁还是挺不错的方案。</span></p><h5><a name="其他-n385" class="md-header-anchor"></a><span>其他</span></h5><p><span>文件夹结构与相关命令 </span><a href='https://github.com/logerlink/mongoRepDemo'><span>logerlink/mongoRepDemo (github.com)</span></a></p><p><span>mongorestore 没测，本来只想整理备份与还原的内容，谁知越操作问题越多，最后都整的一锅粥了。</span></p><p><span>edg冠军了。</span></p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div>

</div>
</div>
</article>
</div>
<div class="btn-toTop"></div>
</div>
</body>
</html>
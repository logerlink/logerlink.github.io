<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"></link>
        <meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
        <title>mongodb如何避免长时间停留在 STARTUP2 状态？ - LogerLink .NET Blog</title>
        <meta name="description" content="mongodb如何避免长时间停留在 STARTUP2 状态">
        <link href='../../css/family.css' rel='stylesheet' type='text/css' />
        <script src="../../js/base.js" type="module"></script>
    </head>
    <body>
        <div class="container">
            <div class="col-left">
                <div class="wave"></div>
                <div class="category">
                </div>
            </div>
            <div class="col-right">
                <article>
                    <header>
                        <h1 class="title">
                            mongodb如何避免长时间停留在 STARTUP2 状态
                        </h1>
                        <div class="dateTime">
                            2021-12-16
                        </div>
                    </header>
                    <hr/>
                    <div class="content">
<div class='typora-export os-windows' >
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span class="btn-toggle">&gt;</span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n5"><a class="md-toc-inner" href="#故障演示">故障演示</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n16"><a class="md-toc-inner" href="#故障处理结果">故障处理结果</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n21"><a class="md-toc-inner" href="#案例重现">案例重现</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n22"><a class="md-toc-inner" href="#数据准备">数据准备</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n24"><a class="md-toc-inner" href="#搭建副本集">搭建副本集</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n26"><a class="md-toc-inner" href="#添加15g的数据还原备份）">添加15G的数据（还原备份）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n28"><a class="md-toc-inner" href="#过了一会儿40多分钟）还原完成">过了一会儿（40多分钟），还原完成</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n30"><a class="md-toc-inner" href="#查看数据情况oplogrs大小为9g">查看数据情况，oplog.rs大小为9G</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n32"><a class="md-toc-inner" href="#直接添加新节点测试">直接添加新节点测试</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n33"><a class="md-toc-inner" href="#添加新节点d">添加新节点D</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n38"><a class="md-toc-inner" href="#查看节点d状态">查看节点D状态</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n42"><a class="md-toc-inner" href="#查看window资源占用情况">查看window资源占用情况</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n47"><a class="md-toc-inner" href="#运行结果">运行结果</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n50"><a class="md-toc-inner" href="#如何避免长时间停留在-startup2-状态">如何避免长时间停留在 STARTUP2 状态？</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n52"><a class="md-toc-inner" href="#测试一收缩-oplogrs-大小无明显效果）">测试一：收缩 oplog.rs 大小（无明显效果）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n53"><a class="md-toc-inner" href="#移除节点d回到abc原始的三个节点">移除节点D，回到ABC原始的三个节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n55"><a class="md-toc-inner" href="#收缩-oplogrs-大小为-2000m">收缩 oplog.rs 大小为 2000M</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n59"><a class="md-toc-inner" href="#添加节点d不需要停止节点d服务不清空上一步骤的-dbpath-文件夹）">添加节点D（不需要停止节点D服务，不清空上一步骤的 dbpath 文件夹）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n63"><a class="md-toc-inner" href="#移除节点d回到abc原始的三个节点-n63">移除节点D，回到ABC原始的三个节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n65"><a class="md-toc-inner" href="#再次收缩-oplogrs-大小为2000m">再次收缩 oplog.rs 大小为2000M</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n69"><a class="md-toc-inner" href="#再次添加节点d停止节点d服务然后清空上一步骤的-dbpath-文件夹再启动节点d服务）">再次添加节点D（停止节点D服务，然后清空上一步骤的 dbpath 文件夹，再启动节点D服务）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n73"><a class="md-toc-inner" href="#将-oplog-文件大小还原为20g">将 oplog 文件大小还原为20G</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n76"><a class="md-toc-inner" href="#测试二将集群主节点转为单实例并清空其他节点的dbpath文件夹有用）">测试二：将集群主节点转为单实例并清空其他节点的dbpath文件夹（有用）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n78"><a class="md-toc-inner" href="#将集群服务所有节点）停止">将集群服务（所有节点）停止</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n80"><a class="md-toc-inner" href="#打开主节点a的-mongodbconf-删掉-replsettestrs-配置">打开主节点A的 mongodb.conf 删掉 replSet=testrs 配置</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n85"><a class="md-toc-inner" href="#直接删除-local-库然后停止节点a服务">直接删除 local 库，然后停止节点A服务</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n87"><a class="md-toc-inner" href="#打开主节点a的-mongodbconf-增加-replsettestrs-配置">打开主节点A的 mongodb.conf 增加 replSet=testrs 配置</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n90"><a class="md-toc-inner" href="#然后启动节点abc服务验证是否是未搭建的副本集">然后启动节点ABC服务，验证是否是未搭建的副本集。</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n93"><a class="md-toc-inner" href="#重新搭建集群并查看执行效果">重新搭建集群，并查看执行效果</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n97"><a class="md-toc-inner" href="#测试三将集群主节点转为单实例但不清空文件有用）">测试三：将集群主节点转为单实例但不清空文件（有用）</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n99"><a class="md-toc-inner" href="#停止节点abc服务并修改三个节点的配置">停止节点ABC服务并修改三个节点的配置</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n102"><a class="md-toc-inner" href="#单独进入abc三个节点服务器删掉local库">单独进入ABC三个节点服务器，删掉local库</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n104"><a class="md-toc-inner" href="#再次停止abc三个节点并修改三个节点的配置">再次停止ABC三个节点并修改三个节点的配置</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n107"><a class="md-toc-inner" href="#验证是否是未搭建的副本集">验证是否是未搭建的副本集</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n110"><a class="md-toc-inner" href="#重新搭建集群并查看执行效果-n110">重新搭建集群，并查看执行效果</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n114"><a class="md-toc-inner" href="#测试四绝对单实例">测试四：绝对单实例</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n116"><a class="md-toc-inner" href="#准备三个单实例">准备三个单实例</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n119"><a class="md-toc-inner" href="#停止abc三个节点修改配置文件">停止ABC三个节点，修改配置文件</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n122"><a class="md-toc-inner" href="#进到节点a的-mongodb-环境进行集群配置">进到节点A的 mongodb 环境进行集群配置</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n126"><a class="md-toc-inner" href="#其他问题">其他问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n127"><a class="md-toc-inner" href="#单实例-show-dbs-出现-not-master-and-slaveokfalse">单实例 show dbs 出现 not master and slaveOk=false</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n130"><a class="md-toc-inner" href="#如何重置集群环境">如何重置集群环境?</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n138"><a class="md-toc-inner" href="#移除副本节点后无法重新加回来了">移除副本节点后，无法重新加回来了</a></span></p></div><p><span>为什么 mongodb 集群的副本节点B状态一直处于STARTUP2？</span></p><p><span>简答：该副本节点B正在向主节点同步数据，过段时间同步完之后就会自动变成 SECONDARY 状态了。若副本节点处于 STARTUP2 状态，该节点可以进行投票（v5.0+就不可以了）但无法进行查询（命令查有时候是可以查出来的，但是集群不会把查询的命令分给副本节点B，因为此时节点B没同步完数据是不完整的）</span></p><p><img src="https://s2.loli.net/2021/12/14/oDG5C2Q4ISi3Mtp.png" referrerpolicy="no-referrer" alt="image-20211214185340567"></p><h3><a name="故障演示" class="md-header-anchor"></a><span>故障演示：mongodb版本v5.0</span></h3><p><span>A：主节点   1.5T 数据    oplog.rs 大小有 50G</span></p><p><span>B：副本节点</span><span>	</span><span>600G 数据</span></p><p><span>C：仲裁节点</span><span>	</span><span>2G 数据</span><span>	</span></p><p><span>集群一共由ABC三个节点组成，已运行1个月，有一天不知道脑子是抽了还是怎么的，把B节点的文件夹清空了，然后 </span><code>rs.remove(&#39;B&#39;)</code><span>将B节点移出集群，心想着等会再把B加回来就行了。</span></p><p><span>执行</span><code>rs.add(&#39;B&#39;)</code><span>后，再执行</span><code>rs.status()</code><span>，怎么B节点的状态不是 SECONDARY ？</span></p><p><img src="https://s2.loli.net/2021/12/14/vfTCxRmd9eAUVy5.png" referrerpolicy="no-referrer" alt="image-20211214152100616"></p><p><a href='https://docs.mongodb.com/manual/reference/replica-states/'><span>mongodb 集群状态详解 Replica Set Member States — MongoDB Manual</span></a></p><p><span>后面我又加入一个节点D，发现也是如此，查了一下，原来新加入的节点要将主节点的数据同步下来，等同步完成后，该节点才会投入工作。</span></p><p><span>我们可以查看B节点的文件夹大小就可知道同步的进度了，通常这个文件大小会不断增大的直到同步完成。</span></p><p><span>但是我记得我之前将这1T的数据搭建副本集是没有 STARTUP2 状态的，不过当时这1T的数据是在单机mongo实例上的，当时直接把这个单实例直接转成副本集了，不知道是不是这个原因。</span></p><h3><a name="故障处理结果" class="md-header-anchor"></a><span>故障处理结果</span></h3><p><span>上面我们讲到直接添加新副本节点，新节点同步数据需要耗费很长时间，状态一直停留在STARTUP2状态，主节点1.5T数据同步了48个小时都没完成，后面我用</span><a href='#测试二：将集群主节点转为单实例并清空其他节点的dbpath文件夹'><span>测试二</span></a><span> 处理成功，而且比之前同步要快很多，代价是oplog记录被我删了，所以在同步前或者同步后最好能执行一次全量备份，但是</span><strong><span>mongodump和mongorestore对于大数据备份很慢</span></strong><span>。直接看图吧</span></p><p><span>27008这个副本节点的状态变化：STARTUP—&gt;STARTUP2—&gt;RECOVERING—&gt;SECONDARY</span></p><p><span>整个过程（停留 STARTUP2 状态）花费了近13个小时，这个要比之前快了两倍</span></p><p><img src="https://s2.loli.net/2021/12/16/nAQSrLukoUOZslK.png" referrerpolicy="no-referrer" alt="image-20211216102253246"></p><h3><a name="案例重现" class="md-header-anchor"></a><span>案例重现</span></h3><h4><a name="数据准备" class="md-header-anchor"></a><span>数据准备</span></h4><p><span>搭建集群、还原数据</span></p><h5><a name="搭建副本集" class="md-header-anchor"></a><span>搭建副本集</span></h5><p><img src="https://s2.loli.net/2021/12/14/QHsPDNYq3BLznT7.png" referrerpolicy="no-referrer" alt="image-20211214154450641"></p><h5><a name="添加15g的数据还原备份）" class="md-header-anchor"></a><span>添加15G的数据（还原备份）</span></h5><p><img src="https://s2.loli.net/2021/12/14/9GTiySHInjBeDhO.png" referrerpolicy="no-referrer" alt="image-20211214155025875"></p><h5><a name="过了一会儿40多分钟）还原完成" class="md-header-anchor"></a><span>过了一会儿（40多分钟），还原完成</span></h5><p><img src="https://s2.loli.net/2021/12/14/h3DrfxaiXBqIzAP.png" referrerpolicy="no-referrer" alt="image-20211214163326725"></p><h5><a name="查看数据情况oplogrs大小为9g" class="md-header-anchor"></a><span>查看数据情况，oplog.rs大小为9G</span></h5><p><img src="https://s2.loli.net/2021/12/14/O4UKAHfmb9aZ2xl.png" referrerpolicy="no-referrer" alt="image-20211214165159005"></p><h4><a name="直接添加新节点测试" class="md-header-anchor"></a><span>直接添加新节点测试</span></h4><h5><a name="添加新节点d" class="md-header-anchor"></a><span>添加新节点D</span></h5><p><span>（建议新增一个节点测试，如果删除节点B，那么集群就只剩下2个节点了，很容易发生错误导致无法重新把副本节点B加回来，如下图的错误：rs.add()一直无响应，关于这个问题可以参考这个解决：</span><a href='#移除副本节点后无法重新加回来了'><span>移除副本节点后，无法重新加回来了</span></a><span>）</span></p><p><img src="https://s2.loli.net/2021/12/14/WVI8v6KwThCr3gz.png" referrerpolicy="no-referrer" alt="image-20211214173706553"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27010"</span>)<span class="cm-tab" role="presentation" cm-text="	">   </span><span class="cm-comment"># 添加新节点D</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><img src="C:\Users\loger\AppData\Roaming\Typora\typora-user-images\image-20211214181001252.png" referrerpolicy="no-referrer" alt="image-20211214181001252"></p><h5><a name="查看节点d状态" class="md-header-anchor"></a><span>查看节点D状态</span></h5><p><span>状态长时间停留在 STARTUP2 上，当前正在同步数据</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> rs.status().members[rs.status().members.length <span class="cm-attribute">-</span> <span class="cm-number">1</span>]</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><img src="C:\Users\loger\AppData\Roaming\Typora\typora-user-images\image-20211214181218688.png" referrerpolicy="no-referrer" alt="image-20211214181218688"></p><h5><a name="查看window资源占用情况" class="md-header-anchor"></a><span>查看window资源占用情况</span></h5><p><span>内存占满</span></p><p><img src="https://s2.loli.net/2021/12/14/eoI3cWY2uGPCwdO.png" referrerpolicy="no-referrer" alt="image-20211214181545940"></p><p><span>磁盘跑满</span></p><p><img src="https://s2.loli.net/2021/12/14/1lWaJMRANnvHC2h.png" referrerpolicy="no-referrer" alt="image-20211214181434018"></p><h5><a name="运行结果" class="md-header-anchor"></a><span>运行结果</span></h5><p><span>过了一会儿（数据：15G，oplog：9G 大概使用了10分钟）就自动变回 SECONDARY 状态了</span></p><p><img src="https://s2.loli.net/2021/12/14/iLtNk6cFIuXyBpR.png" referrerpolicy="no-referrer" alt="image-20211214182943654"></p><h3><a name="如何避免长时间停留在-startup2-状态" class="md-header-anchor"></a><span>如何避免长时间停留在 STARTUP2 状态？</span></h3><p><span>那有没有什么方法快速一点呢？避免长时间停留在 STARTUP2 状态呢？</span></p><h4><a name="测试一收缩-oplogrs-大小无明显效果）" class="md-header-anchor"></a><span>测试一：收缩 oplog.rs 大小（无明显效果）</span></h4><h4><a name="移除节点d回到abc原始的三个节点" class="md-header-anchor"></a><span>移除节点D，回到ABC原始的三个节点</span></h4><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27010"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h5><a name="收缩-oplogrs-大小为-2000m" class="md-header-anchor"></a><span>收缩 oplog.rs 大小为 2000M</span></h5><p><span>参考：</span><a href='https://segmentfault.com/a/1190000039787311'><span>Mongodb在线修改oplog大小 - SegmentFault 思否</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use local</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前oplog的大小</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.oplog.rs.stats().maxSize</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 收缩oplog的大小为2000M，最小为990M</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.adminCommand({replSetResizeOplog: <span class="cm-number">1</span>, size: <span class="cm-number">2000</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前复制集信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.getReplicationInfo()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/14/e1tZarP2Tc6UWXQ.png" referrerpolicy="no-referrer" alt="image-20211214191851636"></p><h5><a name="添加节点d不需要停止节点d服务不清空上一步骤的-dbpath-文件夹）" class="md-header-anchor"></a><span>添加节点D（不需要停止节点D服务，不清空上一步骤的 dbpath 文件夹）</span></h5><p><span>然后查看状态，居然没有长时间停留在 STARTUP2 状态上，很快就转为 SECONDARY 状态了，那是不是说明收缩 oplog.rs 是有效果的呢？我们再往下看</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加节点D</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点D的状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status().members[rs.status().members.length <span class="cm-attribute">-</span> <span class="cm-number">1</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/14/i9RtSbkTUJHydqo.png" referrerpolicy="no-referrer" alt="image-20211214192451022"></p><h5><a name="移除节点d回到abc原始的三个节点-n63" class="md-header-anchor"></a><span>移除节点D，回到ABC原始的三个节点</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.remove(<span class="cm-string">"localhost:27010"</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h5><a name="再次收缩-oplogrs-大小为2000m" class="md-header-anchor"></a><span>再次收缩 oplog.rs 大小为2000M</span></h5><p><span> 参考：</span><a href='https://segmentfault.com/a/1190000039787311'><span>Mongodb在线修改oplog大小 - SegmentFault 思否</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use local</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前oplog的大小</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.oplog.rs.stats().maxSize</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 收缩oplog的大小为2000M，最小为990M</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.adminCommand({replSetResizeOplog: <span class="cm-number">1</span>, size: <span class="cm-number">2000</span>})</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前复制集信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.getReplicationInfo()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/14/Msp3zmKXkUnaNW1.png" referrerpolicy="no-referrer" alt="image-20211214193041746"></p><h5><a name="再次添加节点d停止节点d服务然后清空上一步骤的-dbpath-文件夹再启动节点d服务）" class="md-header-anchor"></a><span>再次添加节点D（停止节点D服务，然后清空上一步骤的 dbpath 文件夹，再启动节点D服务）</span></h5><p><span>然后查看状态。通过下图我们可以看到由 STARTUP2 转向 SECONDARY 也是花了将近10分钟（数据：15G，oplog：2G），</span><strong><span>所以这个 STARTUP2  状态应该和oplog 文件大小没有太大关系</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加节点D</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.add(<span class="cm-string">"localhost:27010"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点D的状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status().members[rs.status().members.length <span class="cm-attribute">-</span> <span class="cm-number">1</span>]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/14/bMyZGODoe9ztCcx.png" referrerpolicy="no-referrer" alt="image-20211214194512604"></p><h5><a name="将-oplog-文件大小还原为20g" class="md-header-anchor"></a><span>将 oplog 文件大小还原为20G</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.adminCommand({replSetResizeOplog: <span class="cm-number">1</span>, size: <span class="cm-number">20000</span>})</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/14/i6qVyNwMCnG3hUl.png" referrerpolicy="no-referrer" alt="image-20211214194933279"></p><h4><a name="测试二将集群主节点转为单实例并清空其他节点的dbpath文件夹有用）" class="md-header-anchor"></a><span>测试二：将集群主节点转为单实例并清空其他节点的dbpath文件夹（有用）</span></h4><p><span>执行一次</span><a href='#数据准备'><span>数据准备</span></a><span>并搭建集群环境：节点ABC</span></p><h5><a name="将集群服务所有节点）停止" class="md-header-anchor"></a><span>将集群服务（所有节点）停止</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 等待执行结束就好了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">db.shutdownServer()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><h5><a name="打开主节点a的-mongodbconf-删掉-replsettestrs-配置" class="md-header-anchor"></a><span>打开主节点A的 mongodb.conf 删掉 replSet=testrs 配置</span></h5><p><span>仅启动主节点A服务，以单实例启动，BC节点不要启动</span></p><p><img src="https://s2.loli.net/2021/12/15/1SXPMm3VAtk9gK5.png" referrerpolicy="no-referrer" alt="image-20211215110205061"></p><p><span>进到节点A的 mongodb 环境，我们可以发现数据并未改变，而且 oplog.rs 大小也没有变小。</span></p><p><img src="https://s2.loli.net/2021/12/14/va9hR3wgfOMYdku.png" referrerpolicy="no-referrer" alt="image-20211214203911206"></p><h5><a name="直接删除-local-库然后停止节点a服务" class="md-header-anchor"></a><span>直接删除 local 库，然后停止节点A服务</span></h5><p><img src="https://s2.loli.net/2021/12/14/M4wrEHic3v1aAQ9.png" referrerpolicy="no-referrer" alt="image-20211214213830819"></p><h5><a name="打开主节点a的-mongodbconf-增加-replsettestrs-配置" class="md-header-anchor"></a><span>打开主节点A的 mongodb.conf 增加 replSet=testrs 配置</span></h5><p><span>再将节点B、C的dbpath文件夹和 mongodb.log 文件清空（一定要</span><strong><span>清空这两个副本节点的数据</span></strong><span>，不然主节点A启动后状态会变成 STARTUP2 状态）</span></p><p><img src="https://s2.loli.net/2021/12/15/7fOJGaB3dLq1vRC.png" referrerpolicy="no-referrer" alt="image-20211215110458034"></p><h5><a name="然后启动节点abc服务验证是否是未搭建的副本集" class="md-header-anchor"></a><span>然后启动节点ABC服务，验证是否是未搭建的副本集。</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#进入到 mongodb环境</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 测试是否是未搭建的mongo复制集：执行下面这两条命令会报错</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/dNWylSe8UQfZM3P.png" referrerpolicy="no-referrer" alt="集群未初始化"></p><h5><a name="重新搭建集群并查看执行效果" class="md-header-anchor"></a><span>重新搭建集群，并查看执行效果</span></h5><p><span>搭建完后并检测节点状态，如下图我们看到整个集群差不多5分钟（数据：15G，oplog：无）就初始化同步完成了，这个速度要比</span><a href='#测试一收缩-oplogrs-大小无明显效果）'><strong><span>上面的测试一</span></strong></a><span>快一倍。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切到admin库</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义变量  这里的host和_id 要和配置文件一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cfg</span><span class="cm-operator">=</span>{ _id:<span class="cm-string">"testrs"</span>, members:[ {_id:0,host:<span class="cm-string">'localhost:27007'</span>,priority:2}, {_id:1,host:<span class="cm-string">'localhost:27008'</span>,priority:1}, {_id:2,host:<span class="cm-string">'localhost:27009'</span>,arbiterOnly:true}] };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.initiate(cfg)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点配置 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 找到StartUp2的节点 我这边是索引为1的节点 然后监听这个节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status().members[1]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 253px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/Ex14VARQFLdfaXl.png" referrerpolicy="no-referrer" alt="集群初始化同步完成"></p><h4><a name="测试三将集群主节点转为单实例但不清空文件有用）" class="md-header-anchor"></a><span>测试三：将集群主节点转为单实例但不清空文件（有用）</span></h4><p><span>执行一次</span><a href='#数据准备'><span>数据准备</span></a><span>并搭建集群环境：节点ABC</span></p><h5><a name="停止节点abc服务并修改三个节点的配置" class="md-header-anchor"></a><span>停止节点ABC服务并修改三个节点的配置</span></h5><p><span>打开节点ABC的 mongodb.conf ，删掉 replSet=testrs 配置，再启动ABC节点.</span></p><p><img src="https://s2.loli.net/2021/12/15/g9Rn1boXaYxwWPJ.png" referrerpolicy="no-referrer" alt="image-20211215142903703"></p><h5><a name="单独进入abc三个节点服务器删掉local库" class="md-header-anchor"></a><span>单独进入ABC三个节点服务器，删掉local库</span></h5><p><img src="https://s2.loli.net/2021/12/15/gaP4mKnpdovE7SB.png" referrerpolicy="no-referrer" alt="image-20211215143258386"></p><h5><a name="再次停止abc三个节点并修改三个节点的配置" class="md-header-anchor"></a><span>再次停止ABC三个节点并修改三个节点的配置</span></h5><p><span>打开节点ABC的 mongodb.conf ，添加 replSet=testrs 配置，再启动ABC节点</span></p><p><img src="https://s2.loli.net/2021/12/15/wa2V8e5LW4vU9zJ.png" referrerpolicy="no-referrer" alt="image-20211215143454761"></p><h5><a name="验证是否是未搭建的副本集" class="md-header-anchor"></a><span>验证是否是未搭建的副本集</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#进入到 mongodb环境</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">mongo localhost:27007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 测试是否是未搭建的mongo复制集：执行下面这两条命令会报错</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.conf()</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/mNDTBxhqpFjAPkn.png" referrerpolicy="no-referrer" alt="image-20211215141602511"></p><h5><a name="重新搭建集群并查看执行效果-n110" class="md-header-anchor"></a><span>重新搭建集群，并查看执行效果</span></h5><p><span>搭建完后并检测节点状态如下图我们看到整个集群差不多5分钟（数据：15G，oplog：无）就初始化同步完成了，这个速度和 </span><a href='#测试二将集群主节点转为单实例并清空其他节点的dbpath文件夹有用）'><strong><span>上面的测试二</span></strong></a><span>  相差无几，不过这个操作会比较简单一点</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切到admin库</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义变量  这里的host和_id 要和配置文件一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cfg</span><span class="cm-operator">=</span>{ _id:<span class="cm-string">"testrs"</span>, members:[ {_id:0,host:<span class="cm-string">'localhost:27007'</span>,priority:2}, {_id:1,host:<span class="cm-string">'localhost:27008'</span>,priority:1}, {_id:2,host:<span class="cm-string">'localhost:27009'</span>,arbiterOnly:true}] };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.initiate(cfg)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点配置 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 找到StartUp2的节点 我这边是索引为1的节点 然后监听这个节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status().members[1]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 253px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/hLoIm7ycqVv5nQJ.png" referrerpolicy="no-referrer" alt="image-20211215144233011"></p><h4><a name="测试四绝对单实例" class="md-header-anchor"></a><span>测试四：绝对单实例</span></h4><p><span>执行一次</span><a href='#数据准备'><span>数据准备</span></a><span>，无需搭建集群</span></p><h5><a name="准备三个单实例" class="md-header-anchor"></a><span>准备三个单实例</span></h5><p><span>成功启动后，查询只有节点A有数据，BC无数据</span></p><p><img src="https://s2.loli.net/2021/12/15/9KeMwZ1lNybREFL.png" referrerpolicy="no-referrer" alt="image-20211215161751301"></p><h5><a name="停止abc三个节点修改配置文件" class="md-header-anchor"></a><span>停止ABC三个节点，修改配置文件</span></h5><p><span>打开ABC节点的 mongodb.conf 增加 replSet 的配置，然后重启节点ABC服务</span></p><p><img src="https://s2.loli.net/2021/12/15/wa2V8e5LW4vU9zJ.png" referrerpolicy="no-referrer" alt="image-20211215143454761"></p><h5><a name="进到节点a的-mongodb-环境进行集群配置" class="md-header-anchor"></a><span>进到节点A的 mongodb 环境进行集群配置</span></h5><p><span>如下图，差不多4分钟左右就可以了，</span><strong><span>也没快多少</span></strong><span>。所以为什么之前那个1T的数据那么快就同步完了，是怎么实现的，目前也没测试出来</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切到admin库</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义变量  这里的host和_id 要和配置文件一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cfg</span><span class="cm-operator">=</span>{ _id:<span class="cm-string">"testrs"</span>, members:[ {_id:0,host:<span class="cm-string">'localhost:27007'</span>,priority:2}, {_id:1,host:<span class="cm-string">'localhost:27008'</span>,priority:1}, {_id:2,host:<span class="cm-string">'localhost:27009'</span>,arbiterOnly:true}] };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.initiate(cfg)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点配置 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 找到StartUp2的节点 我这边是索引为1的节点 然后监听这个节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.status().members[1]</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 253px;"></div><div class="CodeMirror-gutters" style="display: none; height: 253px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/QmErOCSpbf2gPeH.png" referrerpolicy="no-referrer" alt="image-20211215163322505"></p><h3><a name="其他问题" class="md-header-anchor"></a><span>其他问题</span></h3><h4><a name="单实例-show-dbs-出现-not-master-and-slaveokfalse" class="md-header-anchor"></a><span>单实例 show dbs 出现 not master and slaveOk=false</span></h4><p><span>你此时并不是&quot;单实例&quot;，我可以猜一下你刚才的操作：你是不是直接把所有节点下的 dbpath 文件夹清空了以为这样就可以重置集群环境了。你可以打开你的 mongodb.conf 看看是不是还有 replSet 的配置，有的话把它删了，再重启 mongodb 服务，就可以进到 mongodb 环境执行了。如果你还想搭建副本集，这时你再加上 replSet 的配置，然后重启服务，重新配置副本集了</span></p><p><img src="https://s2.loli.net/2021/12/15/MHJ54bycURqlrvj.png" referrerpolicy="no-referrer" alt="image-20211215145615831"></p><h4><a name="如何重置集群环境" class="md-header-anchor"></a><span>如何重置集群环境?</span></h4><p><span>集群：ABC节点</span></p><p><span>停止ABC节点服务，清空ABC节点下的 dbpath 文件夹和 mongodb.log 文件，如果想保留主节点的数据那就不要清空主节点的 dbpath 文件夹.</span></p><p><img src="https://s2.loli.net/2021/12/15/5sC3frF47LzogJn.png" referrerpolicy="no-referrer" alt="image-20211215151044050"></p><p><span>打开节点A的 mongodb.conf 删掉 replSet 的配置，重启 mongodb 服务，进到节点A的 mongodb 环境，再次停止节点A服务，打开节点A的 mongodb.conf 加上replSet 的配置，启动ABC三个节点的服务，这样就可以重新配置副本集了</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 切到admin库</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">use admin</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 定义变量  这里的host和_id 要和配置文件一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cfg</span><span class="cm-operator">=</span>{ _id:<span class="cm-string">"testrs"</span>, members:[ {_id:0,host:<span class="cm-string">'localhost:27007'</span>,priority:2}, {_id:1,host:<span class="cm-string">'localhost:27008'</span>,priority:1}, {_id:2,host:<span class="cm-string">'localhost:27009'</span>,arbiterOnly:true}] };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 初始化节点配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.initiate(cfg)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 161px;"></div><div class="CodeMirror-gutters" style="display: none; height: 161px;"></div></div></div></pre><p>&nbsp;</p><p><img src="https://s2.loli.net/2021/12/15/z6g9oXRsKBhT48f.png" referrerpolicy="no-referrer" alt="image-20211215151402436"></p><h4><a name="移除副本节点后无法重新加回来了" class="md-header-anchor"></a><span>移除副本节点后，无法重新加回来了</span></h4><p><span>移除副本节点后，无法重新加回来了，rs.add() 一直卡住了，我们打开 log 文件可以看到错误信息：</span></p><p><span>&quot;codeName&quot;:&quot;NewReplicaSetConfigurationIncompatible&quot;,&quot;errmsg&quot;:&quot;Rejecting reconfig where the new config has a PSA topology and the secondary is electable, but the old config contains only one writable node&quot;}</span></p><p><img src="https://s2.loli.net/2021/12/15/M1AELT8NQYjylOU.png" referrerpolicy="no-referrer" alt="image-20211215170422784"></p><p><span>解决方案：</span></p><p><span>参考</span><a href='https://docs.mongodb.com/manual/reference/method/rs.reconfigForPSASet/'><span>rs.reconfigForPSASet() — MongoDB Manual</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 获取当前配置</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cfg <span class="cm-operator">=</span> rs.conf()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修改当前配置的成员信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cfg[<span class="cm-string">"members"</span>] <span class="cm-operator">=</span> [</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"_id"</span> : <span class="cm-number">0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"host"</span> : <span class="cm-string">"localhost:27007"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"arbiterOnly"</span> : <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"buildIndexes"</span> : <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"hidden"</span> : <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"priority"</span> : <span class="cm-number">2</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"tags"</span> : {},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"secondaryDelaySecs"</span> : NumberLong(<span class="cm-string">"0"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"votes"</span> : <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"_id"</span> : <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"host"</span> : <span class="cm-string">"localhost:27008"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"arbiterOnly"</span> : <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"buildIndexes"</span> : <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"hidden"</span> : <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"priority"</span> : <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"tags"</span> : {},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"secondaryDelaySecs"</span> : NumberLong(<span class="cm-string">"0"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"votes"</span> : <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"_id"</span> : <span class="cm-number">2</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"host"</span> : &nbsp;<span class="cm-string">"localhost:27009"</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"arbiterOnly"</span> : <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"buildIndexes"</span> : <span class="cm-atom">true</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"hidden"</span> : <span class="cm-atom">false</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"priority"</span> : <span class="cm-number">0</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"tags"</span> : {},</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"secondaryDelaySecs"</span> : NumberLong(<span class="cm-string">"0"</span>),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-string">"votes"</span> : <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 使配置生效</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rs.reconfigForPSASet(1, cfg)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 920px;"></div><div class="CodeMirror-gutters" style="display: none; height: 920px;"></div></div></div></pre><p><img src="https://s2.loli.net/2021/12/15/ZDUwYgXh6oqrI27.png" referrerpolicy="no-referrer" alt="image-20211215171213893"></p><p>&nbsp;</p></div>


</div>
</div>
</article>
</div>
<div class="btn-toTop"></div>
</div>
</body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"></link>
        <meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
        <title>redis整理03——redis数据持久化、主从模式、主从模式+哨兵机制以及分片集群 - LogerLink .NET Blog</title>
        <meta name="keywords" content="redis,数据持久化,主从模式,哨兵,分片"/>
        <meta name="description" content="redis数据持久化RDB和AOF。redis主从模式、主从模式+哨兵机制以及分片集群演示">
        <link href='../../css/family.css' rel='stylesheet' type='text/css' />
        <script src="../../js/base.js" type="module"></script>
    </head>
    <body>
        <div class="container">
            <div class="col-left">
                <div class="wave"></div>
                <div class="category">
                </div>
            </div>
            <div class="col-right">
                <article>
                    <header>
                        <h1 class="title">
                            redis整理03——redis数据持久化、主从模式、主从模式+哨兵机制以及分片集群
                        </h1>
                        <div class="dateTime">
                            2024-09-16
                        </div>
                    </header>
                    <hr/>
                    <div class="content">
<div class='typora-export os-windows' >
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span class="btn-toggle">&gt;</span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n2"><a class="md-toc-inner" href="#说明">说明</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n6"><a class="md-toc-inner" href="#单点redis的问题">单点redis的问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n17"><a class="md-toc-inner" href="#redis持久化">redis持久化</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n21"><a class="md-toc-inner" href="#redis配置文件">redis配置文件</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n28"><a class="md-toc-inner" href="#rdb">RDB</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n42"><a class="md-toc-inner" href="#aof">AOF</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n69"><a class="md-toc-inner" href="#主从模式---replica">主从模式—Replica</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n71"><a class="md-toc-inner" href="#主从模式图解">主从模式图解</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n76"><a class="md-toc-inner" href="#配置文件redisconf">配置文件redis.conf</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n80"><a class="md-toc-inner" href="#7001------主节点">7001——主节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n83"><a class="md-toc-inner" href="#7002------从节点">7002——从节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n86"><a class="md-toc-inner" href="#7003------从节点">7003——从节点</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n89"><a class="md-toc-inner" href="#主从演示">主从演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n93"><a class="md-toc-inner" href="#c代码演示">c#代码演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n107"><a class="md-toc-inner" href="#故障演示">故障演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n118"><a class="md-toc-inner" href="#一键部署主从模式">一键部署主从模式</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n122"><a class="md-toc-inner" href="#哨兵机制---sentinel">哨兵机制—Sentinel</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n125"><a class="md-toc-inner" href="#哨兵机制图解">哨兵机制图解</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n127"><a class="md-toc-inner" href="#哨兵三大功能">哨兵三大功能</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n147"><a class="md-toc-inner" href="#配置文件sentinelconf">配置文件sentinel.conf</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n150"><a class="md-toc-inner" href="#s1-7005">s1-7005</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n153"><a class="md-toc-inner" href="#s2-7006">s2-7006</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n156"><a class="md-toc-inner" href="#s3-7007">s3-7007</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n159"><a class="md-toc-inner" href="#哨兵及故障演示">哨兵及故障演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n224"><a class="md-toc-inner" href="#更多哨兵常用命令">更多哨兵常用命令</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n226"><a class="md-toc-inner" href="#c代码演示-n226">c#代码演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n247"><a class="md-toc-inner" href="#常见问题">常见问题</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n290"><a class="md-toc-inner" href="#一键启动哨兵">一键启动哨兵</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n294"><a class="md-toc-inner" href="#一键关闭哨兵">一键关闭哨兵</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n297"><a class="md-toc-inner" href="#分片集群---cluster">分片集群—Cluster</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n300"><a class="md-toc-inner" href="#分片集群图解">分片集群图解</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n312"><a class="md-toc-inner" href="#配置文件clusterconf">配置文件cluster.conf</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n314"><a class="md-toc-inner" href="#一键部署关闭集群">一键部署关闭集群</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n319"><a class="md-toc-inner" href="#创建集群">创建集群</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n328"><a class="md-toc-inner" href="#分片集群演示">分片集群演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n340"><a class="md-toc-inner" href="#故障演示-n340">故障演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n356"><a class="md-toc-inner" href="#c代码演示-n356">c#代码演示</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n362"><a class="md-toc-inner" href="#redis集群常见命令------cluster">redis集群常见命令——cluster</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n366"><a class="md-toc-inner" href="#插槽相关">插槽相关</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n371"><a class="md-toc-inner" href="#节点相关">节点相关</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n393"><a class="md-toc-inner" href="#故障转移">故障转移</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n402"><a class="md-toc-inner" href="#redis集群常见命令------redis-cli">redis集群常见命令——redis-cli</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n411"><a class="md-toc-inner" href="#节点相关-n411">节点相关</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n416"><a class="md-toc-inner" href="#插槽相关-n416">插槽相关</a></span><span role="listitem" class="md-toc-item md-toc-h6" data-ref="n427"><a class="md-toc-inner" href="#其他">其他</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n433"><a class="md-toc-inner" href="#常见问题-n433">常见问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n472"><a class="md-toc-inner" href="#总结">总结</a></span></p></div><h4><a name="说明" class="md-header-anchor"></a><span>说明</span></h4><p><span>linux(contos)、redis7.0+、.net core6.0+、docker</span></p><p><span>记录一下redis数据持久化、主从同步、哨兵机制、分片集群相关内容，使用docker部署</span></p><p><span>为了方便，本文是在同一台机器上演示的集群，正常情况下要在不同的机器部署节点，真别傻乎乎的在同一个机器部署集群，集群性能没有任何提升</span></p><h4><a name="单点redis的问题" class="md-header-anchor"></a><span>单点redis的问题</span></h4><p><span>单点redis实例可处理每秒数万到数十万的请求，一些小项目已经足够。但是如果业务比较复杂——并发更高、数据量更大，单点redis可能会出现以下问题：</span></p><ul><li><span>数据丢失——修改RDB、AOF的存储配置</span></li><li><span>并发能力不足——搭建主从集群，实现读写分离。master主节点写数据、从节点读取数据</span></li><li><span>故障恢复——添加哨兵机制，健康检测，故障恢复</span></li><li><span>存储能力——搭建分片集群，每个分片存储不同的数据</span></li></ul><h4><a name="redis持久化" class="md-header-anchor"></a><span>redis持久化</span></h4><p><span>redis持久化数据可分为</span><strong><span>RDB</span></strong><span>和</span><strong><span>AOF</span></strong><span>两种方式，不指定任何配置时默认使用RDB持久化的方式，两者各有各的优势，也可以结合两者使用。</span></p><p><span>redis容器内部没有配置文件，需要自己映射或者把配置内容写道</span><code>docker run</code><span>命令，建议使用配置文件启动</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker pull redis:7.0</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 创建目录并复制conf文件并进入目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-rdb-aof/conf &amp;&amp; <span class="cm-builtin">cp</span> redis7.conf test-redis-rdb-aof/conf/redis7.conf &amp;&amp; <span class="cm-builtin">cd</span> test-redis-rdb-aof</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动redis挂载磁盘并使用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">6380</span>:6379 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--name</span> test-redis-rdb-aof \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-rdb-aof/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-rdb-aof/conf/redis7.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis-server /etc/redis/redis.conf 指定(挂载的)配置文件启动redis</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看test-的容器信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker <span class="cm-builtin">ps</span> | <span class="cm-builtin">grep</span> test-</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 进入容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker exec <span class="cm-attribute">-it</span> id <span class="cm-builtin">bash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 连接redis</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis命令：设置rediskey缓存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">MSET name Tom age <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis命令：查看redis的rdb、aof配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CONFIG <span class="cm-builtin">get</span> save dbfilename appendonly</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 538px;"></div><div class="CodeMirror-gutters" style="display: none; height: 538px;"></div></div></div></pre><h5><a name="redis配置文件" class="md-header-anchor"></a><span>redis配置文件</span></h5><p><span>redis7.0的配置文件详解——</span><a href='https://raw.githubusercontent.com/redis/redis/7.0/redis.conf'><span>redis-7.0.conf</span></a><span>，默认的配置文件是开启RDB持久化方式，禁用AOF持久化方式</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240818210525734.png" referrerpolicy="no-referrer" alt="image-20240818210525734"></p><p><strong><span>redis重点关注配置</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定 Redis 服务器监听的 IP 地址。 127.0.0.1 表示 localhost，::1 表示 IPv6 localhost。0.0.0.1 外网</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">127</span>.0.0.1 <span class="cm-attribute">-</span>::1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 服务器监听的端口号，默认是 6379。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志级别，可选择 debug, verbose, notice, warning, error, fatal。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">loglevel notice</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件路径。如果为空，则不记录日志。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###RDB 相关配置 ##### ##### ####</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#启用RDB，并设置什么时候保存一次</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># save 3600 1 300 100 60 10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dbfilename dump.rdb</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 数据文件所在的目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir ./</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###AOF 相关配置 ##### ##### ####</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭 AOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfilename <span class="cm-string">"appendonly.aof"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appenddirname <span class="cm-string">"appendonlydir"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件同步频率，单位秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfsync everysec</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在 AOF 日志文件记录时间戳。 &nbsp;  # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-timestamp-enabled no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###慢查询设置 ##### ##### ####</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 记录慢查询的时间阈值，单位毫秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slowlog-log-slower-than <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 慢查询日志最大长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slowlog-max-len <span class="cm-number">128</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 717px;"></div><div class="CodeMirror-gutters" style="display: none; height: 717px;"></div></div></div></pre><p><span>redis7.0配置文件详解，去掉注释了有需要请查看官方原版文件，更多配置文件请查看：</span><a href='https://redis.io/docs/latest/operate/oss_and_stack/management/config/'><span>Redis conf</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ##### ###服务器基本设置</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定 Redis 服务器监听的 IP 地址。 127.0.0.1 表示 localhost，::1 表示 IPv6 localhost。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">127</span>.0.0.1 <span class="cm-attribute">-</span>::1</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用保护模式，只能从本机连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 服务器监听的端口号，默认是 6379。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># TCP 连接队列长度，决定了服务器可以同时处理多少个连接请求</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp-backlog <span class="cm-number">511</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 客户端连接的超时时间，单位秒。 0 表示永不过期。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">timeout <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># TCP 长连接保持心跳的时间间隔，单位秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">tcp-keepalive <span class="cm-number">300</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 是否以守护进程运行。 yes 表示以守护进程运行，no 表示以前台进程运行。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 进程 ID 文件路径。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">pidfile /var/run/redis_6379.pid</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ##### ##日志设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志级别，可选择 debug, verbose, notice, warning, error, fatal。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">loglevel notice</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件路径。如果为空，则不记录日志。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 数据库数量。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">databases <span class="cm-number">16</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ##### ##其他设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动时是否显示 Redis 版本信息。 # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">always-show-logo no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置进程标题。  # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">set-proc-title <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 进程标题模板。 &nbsp; # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">proc-title-template <span class="cm-string">"{title} {listen-addr} {server-mode}"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在后台保存数据库文件失败时，阻止写入操作。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">stop-writes-on-bgsave-error <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用 RDB 文件压缩。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdbcompression <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在 RDB 文件中添加校验和。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdbchecksum <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dbfilename dump.rdb</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除同步文件。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdb-del-sync-files no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 数据文件所在的目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir ./</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ##### ##### 复制设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 允许从服务器返回旧数据。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replica-serve-stale-data <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 从服务器只读模式。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replica-read-only <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 磁盘less 复制模式。  # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">repl-diskless-sync <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 磁盘less 复制延迟时间，单位秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">repl-diskless-sync-delay <span class="cm-number">5</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 磁盘less 复制最大副本数。# 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">repl-diskless-sync-max-replicas <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 磁盘less 加载模式。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">repl-diskless-load disabled</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 禁用 TCP 节点延迟。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">repl-disable-tcp-nodelay no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 从节点优先级，默认都是100，越高则越容易被选为主节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replica-priority <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 内存设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">acllog-max-len <span class="cm-number">128</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟释放内存。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">lazyfree-lazy-eviction no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟过期。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">lazyfree-lazy-expire no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟删除服务器。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">lazyfree-lazy-server-del no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟刷新。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replica-lazy-flush no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟删除用户。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">lazyfree-lazy-user-del no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟刷新用户。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">lazyfree-lazy-user-flush no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 调整内存分配优先级。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">oom-score-adj no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 内存分配优先级值。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">oom-score-adj-values <span class="cm-number">0</span> <span class="cm-number">200</span> <span class="cm-number">800</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 禁用 Transparent Huge Pages。 # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">disable-thp <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用 AOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfilename <span class="cm-string">"appendonly.aof"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appenddirname <span class="cm-string">"appendonlydir"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件同步频率，单位秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfsync everysec</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在重写 AOF 日志文件时不进行同步。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">no-appendfsync-on-rewrite no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 自动重写 AOF 日志文件百分比。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">auto-aof-rewrite-percentage <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 自动重写 AOF 日志文件最小大小，单位 MB。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">auto-aof-rewrite-min-size 64mb</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 加载截断的 AOF 日志文件。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-load-truncated <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在 AOF 日志文件开头添加 RDB 预备语。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-use-rdb-preamble <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在 AOF 日志文件记录时间戳。# 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-timestamp-enabled no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###慢查询设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 记录慢查询的时间阈值，单位毫秒。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slowlog-log-slower-than <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 慢查询日志最大长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slowlog-max-len <span class="cm-number">128</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ####其他设置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 延迟监控阈值。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">latency-monitor-threshold <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 通知事件。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">notify-keyspace-events <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 哈希表最大列表长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hash-max-listpack-entries <span class="cm-number">512</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 哈希表最大值长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hash-max-listpack-value <span class="cm-number">64</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 列表最大大小。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">list-max-listpack-size <span class="cm-attribute">-2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 列表压缩深度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">list-compress-depth <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集合最大元素数量。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">set-max-intset-entries <span class="cm-number">512</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># zset 最大列表长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">zset-max-listpack-entries <span class="cm-number">128</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># zset 最大值长度。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">zset-max-listpack-value <span class="cm-number">64</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># hll 稀疏最大字节数。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hll-sparse-max-bytes <span class="cm-number">3000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 流节点最大字节数。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">stream-node-max-bytes <span class="cm-number">4096</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 流节点最大条目数。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">stream-node-max-entries <span class="cm-number">100</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用主动哈希。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">activerehashing <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 客户端输出缓冲区大小。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">client-output-buffer-limit normal <span class="cm-number">0</span> <span class="cm-number">0</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 复制客户端输出缓冲区大小。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">client-output-buffer-limit replica 256mb 64mb <span class="cm-number">60</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 订阅客户端输出缓冲区大小。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">client-output-buffer-limit pubsub 32mb 8mb <span class="cm-number">60</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 心跳频率，单位 Hz。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">hz <span class="cm-number">10</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 动态调整心跳频率。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dynamic-hz <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用增量文件同步。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-rewrite-incremental-fsync <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用增量文件同步。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">rdb-save-incremental-fsync <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用 jemalloc 后台线程。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">jemalloc-bg-thread <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置节点密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># requirepass mypassword</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 设置主节点密码，请保证主从节点的密码一致</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># masterauth mypassword</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 从节点中执行，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># replicaof masterip masterport</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 3629px;"></div><div class="CodeMirror-gutters" style="display: none; height: 3629px;"></div></div></div></pre><h5><a name="rdb" class="md-header-anchor"></a><span>RDB</span></h5><p><span>RDB：Redis Database，定时对整个内存做快照，宕机时恢复数据快、迁移方便、自动压缩文件体积小但是丢失数据较多（两次备份期间未持久化的数据将全部丢失），做快照时占用大量CPU和内存资源</span></p><p><span>准备RDB配置文件</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###RDB 相关配置 ##### ##### ####</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#启用RDB，并设置什么时候保存一次 在3600秒内有一次key变更、300秒内有100次key变更、...则保存</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">3600</span> <span class="cm-number">1</span> <span class="cm-number">300</span> <span class="cm-number">100</span> <span class="cm-number">60</span> <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># RDB文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dbfilename dump.rdb</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Redis 数据文件所在的目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir ./</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><span>使用RDB持久化配置运行redis</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-rdb/conf &amp;&amp; <span class="cm-builtin">cd</span> test-redis-rdb</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> conf/redis7-rdb.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动redis挂载磁盘并使用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">6380</span>:6379 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--name</span> test-redis-rdb \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-rdb/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-rdb/conf/redis7-rdb.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis-server /etc/redis/redis.conf 指定(挂载的)配置文件启动redis</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240817172426180.png" referrerpolicy="no-referrer" alt="image-20240817172426180"></p><p><span>由以下的redis日志可以看出，启用rdb持久化时，正常退出会保存rdb文件（配置文件dbfilename），启动redis会加载rdb文件</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240817173155061.png" referrerpolicy="no-referrer" alt="image-20240817173155061"></p><p><code>docker stop、docker restart</code><span> 命令都会保存一次rdb文件、</span><code>docker kill、docker pause</code><span> 命令或突然关机、宕机时不会保存rdb文件，这就会导致数据丢失</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240817174323024.png" referrerpolicy="no-referrer" alt="image-20240817174323024"></p><p><span>除此之外，我们还可以使用</span><code>SAVE、BGSAVE</code><span>这两个命令主动保存rdb文件、key的变更频率达到</span><code>3600 1 300 100 60 10000</code><span>也会触发保存文件</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240817181638252.png" referrerpolicy="no-referrer" alt="image-20240817181638252"></p><p><span>总结：启用rdb持久化时，正常退出会保存rdb文件、启动时会加载rdb文件。所以有了rdb文件，迁移数据是很简单的。但是rdb文件的保存是不固定的，所以宕机时可能会丢失部分数据。我们可以修改save配置提高保存rdb文件的频率，但是不建议这样做。因为每次都是全量保存（先做快照再替换旧rdb文件），需要占用大量cpu和内存资源</span></p><h5><a name="aof" class="md-header-anchor"></a><span>AOF</span></h5><p><span>AOF：Append Only File，记录每一次执行的redis命令，宕机恢复数据较慢（恢复数据时要重新执行这些命令）、文件体积较大但是数据相对完整可做到最多只会丢失一秒的数据(推荐使用everysec配置)，主要消耗磁盘IO资源，不会大量占用cpu和内存资源（不过AOF重写还是会占用消耗cpu和内存资源）</span></p><p><span>准备AOF配置文件</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">##### ##### ###AOF 相关配置 ##### ##### ####</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭rdb，或者指定频率低一点 save 86000 1 =&gt; 每天至少有一个key变更则备份一次</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-string">""</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启用 AOF</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件名称。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfilename <span class="cm-string">"appendonly.aof"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件目录。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appenddirname <span class="cm-string">"appendonlydir"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># AOF 日志文件同步频率。everysec、always、no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendfsync everysec</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在 AOF 日志文件记录时间戳。 &nbsp;  # 与6.0有区别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">aof-timestamp-enabled no</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 291px;"></div><div class="CodeMirror-gutters" style="display: none; height: 291px;"></div></div></div></pre><p><span>使用AOF持久化配置运行redis</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-aof/conf &amp;&amp; <span class="cm-builtin">cd</span> test-redis-aof</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> conf/redis7-aof.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动redis挂载磁盘并使用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">6380</span>:6379 \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--name</span> test-redis-aof \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-aof/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-aof/conf/redis7-aof.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis-server /etc/redis/redis.conf 指定(挂载的)配置文件启动redis</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240817192341758.png" referrerpolicy="no-referrer" alt="image-20240817192341758"></p><p><span>AOF 日志文件同步频率参数取值有三个选项：everysec、always、no，推荐使用everysec。</span></p><ul><li><p><span>always，每次执行写操作都将命令写入磁盘（1秒有十次写操作，则写入十次）。这是最安全的选项，性能最差（IO磁盘写入）</span></p></li><li><p><strong><span>everysec</span></strong><span>，每秒将数据写入磁盘（1秒有十次写操作，则写入一次）。这是较为安全的选项，推荐使用，降低性能（IO磁盘写入）</span></p></li><li><p><span>no，不将数据写入磁盘，最不安全的选项，性能最高</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240818204359382.png" referrerpolicy="no-referrer" alt="image-20240818204359382"></p></li></ul><p><span>不开启RDB，仍然可以通过</span><code>SAVE、BGSAVE</code><span>命令保存RDB文件，重启容器，我们在日志可以看到，退出容器前会再次（写入）同步AOF文件，启动容器时也会加载AOF文件</span></p><p><strong><span>AOF重写</span></strong></p><p><span>随着数据量越来越多，AOF文件不断增大，可以通过以下配置控制 AOF 重写，将 AOF 文件中的冗余数据和不必要的记录删除，从而减小 AOF 文件的大小，提高读写性能</span></p><ul><li><code>no-appendfsync-on-rewrite</code><span> 是否禁用在 AOF 重写过程中对磁盘的同步操作。为yes的话，重写时Redis 将不会将数据立即写入磁盘，而是将数据缓存在内存中，可以提高AOF重写的速度，但是也会有数据丢失的风险</span></li><li><code>auto-aof-rewrite-percentage</code><span> 当 AOF 文件的大小增长到这个百分比时，Redis 会自动启动 AOF 重写过程。</span></li><li><code>auto-aof-rewrite-min-size</code><span>: 当 AOF 文件的大小超过这个字节数时，Redis 会自动启动 AOF 重写过程</span></li></ul><p><span>总结：启用AOF持久化时，会将我们执行的每一条命令按一定的频率写入文件中，推荐使用everysec配置。随着数据增大，AOF文件不断增大，大到一定程度会对AOF文件进行重写，缩小文件大小从而提高读写性能。虽然有重写，但AOF文件体积也要远远大于RDB文件。不过写入AOF文件仅占用IO磁盘资源，而且还可以控制数据丢失范围在一秒以内，</span><strong><span>相对于RDB持久化方式AOF持久化方式占用cpu内存资源小，数据更安全</span></strong></p><h4><a name="主从模式---replica" class="md-header-anchor"></a><span>主从模式—Replica</span></h4><p><span>接下来我们来处理单点redis读并发能力不足的问题。举个例子，假如一台redis实例A能抗下每秒1万次读并发请求，那并发量提高一倍，我们可不可以再增加一台redis实例B，处理另外一万次读并发请求呢？答案肯定是可以的，不可以的话就不会问的那么刻意了...那应该怎么实现呢？</span></p><h5><a name="主从模式图解" class="md-header-anchor"></a><span>主从模式图解</span></h5><p><span>主从模式，自动实现读写分离</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240824152839293.png" referrerpolicy="no-referrer" alt="image-20240824152839293"></p><p><span>数据同步原理，参考：</span><a href='https://www.bilibili.com/video/BV1cr4y1671t'><span>高级篇-分布式缓存-08-Redis主从-主从的全量同步原理</span><em><span>哔哩哔哩</span></em><span>bilibili</span></a></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240824151253438.png" referrerpolicy="no-referrer" alt="image-20240824151253438"></p><h5><a name="配置文件redisconf" class="md-header-anchor"></a><span>配置文件redis.conf</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="ini" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="ini"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -::1  0.0.0.0外网可访问</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">bind 0.0.0.0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port 6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定节点密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">requirepass 123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">masterauth 123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 永久指定主从关系，重启后仍可用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># replicaof 0.0.0.0 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启rdb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">save 3600 1 300 100 60 10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭AOF </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">appendonly no</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><p><span>公网服务器还需要设置安全组开放指定端口，</span><strong><span>谨慎操作</span></strong></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240820232212867.png" referrerpolicy="no-referrer" alt="image-20240820232212867"></p><h5><a name="7001------主节点" class="md-header-anchor"></a><span>7001——主节点</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放7001端口，真正的服务器还得在服务器商控制台开放7001端口。测试环境请忽略</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7001</span>/tcp <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">6379</span>/tcp <span class="cm-attribute">--permanent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/7001/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> test-redis-replica/7001/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span>:6379 <span class="cm-attribute">--name</span> test-redis-7001 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/conf/redis-re.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 哨兵下使用，需要更改映射并添加写权限，避免主从切换时出现无权限更新配置文件错误，更推荐使用这种方式启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#docker run -d -p 7003:6379 --name test-redis-7003 --restart=always \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/data:/data \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/conf:/etc/redis/conf \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># chmod 777 /home/redis-test/test-redis-replica/7003/conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前机器的ip</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ip a | <span class="cm-builtin">grep</span> eth0 <span class="cm-comment"># 取出ip</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 515px;"></div><div class="CodeMirror-gutters" style="display: none; height: 515px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240820233036608.png" referrerpolicy="no-referrer" alt="image-20240820233036608"></p><h5><a name="7002------从节点" class="md-header-anchor"></a><span>7002——从节点</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放端口7002</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7002</span>/tcp <span class="cm-attribute">--permanent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/7002/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> test-redis-replica/7002/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 替换 replicaof 的ip为7001机器的ip（可以使用公网IP，测试环境可以使用ip -a 查出来的IP），记住要开放7001端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sed</span> <span class="cm-attribute">-i</span> <span class="cm-string">'s/# replicaof 0.0.0.0 7001/replicaof 119.45.100.200 7001/'</span> test-redis-replica/7002/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7002</span>:6379 <span class="cm-attribute">--name</span> test-redis-7002 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7002/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7002/conf/redis-re.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 哨兵下使用，需要更改映射并添加写权限，避免主从切换时出现无权限更新配置文件错误，更推荐使用这种方式启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#docker run -d -p 7003:6379 --name test-redis-7003 --restart=always \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/data:/data \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/conf:/etc/redis/conf \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># chmod 777 /home/redis-test/test-redis-replica/7003/conf</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 515px;"></div><div class="CodeMirror-gutters" style="display: none; height: 515px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240820234349981.png" referrerpolicy="no-referrer" alt="image-20240820234349981"></p><h5><a name="7003------从节点" class="md-header-anchor"></a><span>7003——从节点</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放端口7003</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7003</span>/tcp <span class="cm-attribute">--permanent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/7003/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> test-redis-replica/7003/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 替换 replicaof 的ip为7001机器的ip（可以使用公网IP，测试环境可以使用ip -a 查出来的IP），记住要开放7001端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">sed</span> <span class="cm-attribute">-i</span> <span class="cm-string">'s/# replicaof 0.0.0.0 7001/replicaof 10.206.0.13 7001/'</span> test-redis-replica/7003/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7003</span>:6379 <span class="cm-attribute">--name</span> test-redis-7003 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7003/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7003/conf/redis-re.conf:/etc/redis/redis.conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-server /etc/redis/redis.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 哨兵下使用，需要更改映射并添加写权限，避免主从切换时出现无权限更新配置文件错误，更推荐使用这种方式启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#docker run -d -p 7003:6379 --name test-redis-7003 --restart=always \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/data:/data \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  -v /home/redis-test/test-redis-replica/7003/conf:/etc/redis/conf \</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># chmod 777 /home/redis-test/test-redis-replica/7003/conf</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 493px;"></div><div class="CodeMirror-gutters" style="display: none; height: 493px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240820234604950.png" referrerpolicy="no-referrer" alt="image-20240820234604950"></p><h5><a name="主从演示" class="md-header-anchor"></a><span>主从演示</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看主从节点信息</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">info replication</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>主节点可读写，从节点仅可读，所以我们可以把读的请求分给从节点处理</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240821000258602.png" referrerpolicy="no-referrer" alt="image-20240821000258602"></p><h5><a name="c代码演示" class="md-header-anchor"></a><span>c#代码演示</span></h5><p><span>以下演示一下c#代码如何连接并使用</span><strong><span>主从模式</span></strong><span>，源码参考：</span><a href='https://github.com/logerlink/RedisTest/commit/043a31e6b6d7c4a389f35ab75602420f1f90cb80'><span>redis 兼容主从复制 · logerlink/RedisTest@043a31e (github.com)</span></a></p><p><span>redis主从模式连接字符串</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="json"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"ConnectionStrings"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"Redis"</span>: <span class="cm-string">"119.45.100.100:7001,119.45.100.100:7002,119.45.100.100:7003,password=123456"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>redis 帮助类改造——</span><code>CommandFlags.PreferReplica</code><span>优先从节点读取数据</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 设置 key 并保存字符串（如果 key 已存在，则覆盖值）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisKey"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisValue"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="expiry"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">bool</span> <span class="cm-def">StringSet</span>(<span class="cm-variable-3">string</span> <span class="cm-variable">redisKey</span>, <span class="cm-variable-3">string</span> <span class="cm-variable">redisValue</span>, <span class="cm-variable-3">TimeSpan</span><span class="cm-operator">?</span> <span class="cm-variable">expiry</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span class="cm-variable">AddKeyPrefix</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">_db</span>.<span class="cm-variable">StringSet</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">redisValue</span>, <span class="cm-variable">expiry</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 获取字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisKey"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="expiry"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span><span class="cm-operator">?</span> <span class="cm-variable">StringGet</span>(<span class="cm-variable-3">string</span> <span class="cm-variable">redisKey</span>, <span class="cm-variable-3">TimeSpan</span><span class="cm-operator">?</span> <span class="cm-variable">expiry</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span class="cm-variable">AddKeyPrefix</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">_db</span>.<span class="cm-variable">StringGet</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">CommandFlags</span>.<span class="cm-variable">PreferReplica</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 我们只需要在相关的读操作后面添加 CommandFlags.PreferReplica 参数，自动优先从节点读取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 写操作无需此参数，因为主从模式下，只有主节点可读写，从节点都是仅可读的</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="display: none; height: 560px;"></div></div></div></pre><p><span>具体使用</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// redis 简单演示</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">void</span> <span class="cm-variable">RedisReplicaTest</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">key</span> <span class="cm-operator">=</span> <span class="cm-string">"redis_key"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_redis</span>.<span class="cm-variable">StringSet</span>(<span class="cm-variable">key</span>, <span class="cm-string">"Hello world"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaTest 设置缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaTest 设置缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">data</span> <span class="cm-operator">=</span> <span class="cm-variable">_redis</span>.<span class="cm-variable">StringGet</span>(<span class="cm-string">"redis_key"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaTest 读取缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaTest 读取缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 582px;"></div><div class="CodeMirror-gutters" style="display: none; height: 582px;"></div></div></div></pre><p><span>如下图，</span></p><p><span>所有节点存活时，读取缓存均成功——主写从读</span></p><p><span>仅关闭主节点后或者仅关闭主节点和从节点1后，读取缓存成功，写缓存失败——主写失败，从读成功</span></p><p><span>关闭所有节点（一主两从），读写缓存均失败</span></p><p><span>仅启动主节点时，读取缓存均成功——主写主读，又变成&quot;单实例redis&quot;了</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240824113440888.png" referrerpolicy="no-referrer" alt="image-20240824113440888"></p><h5><a name="故障演示" class="md-header-anchor"></a><span>故障演示</span></h5><p><span>从节点脱离主节点后，主节点Id会发生改变。若从节点再次链接主节点，则会进行全量同步主节点的数据，保证数据统一</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 脱离主节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SLAVEOF NO ONE</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 加入主节点成为master的从节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replicaof host ip</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">slaveof host ip</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240821231601371.png" referrerpolicy="no-referrer" alt="image-20240821231601371"></p><p><span>从节点异常断开连接，正常启动后，由于节点Id没有改变，所以会自动根据偏移量同步主节点的数据，保证数据统一</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240822001806958.png" referrerpolicy="no-referrer" alt="image-20240822001806958"></p><p><span>超过半数的节点（此处两个从节点）断开连接后，主节点仍可用（可读写）。若此时继续处理高并发，全部节点断开连接，那肯定就不可用了</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240822234421566.png" referrerpolicy="no-referrer" alt="image-20240822234421566"></p><p><strong><span>主节点宕机断开连接，从节点不影响读取数据</span></strong><span>，但是无法设置缓存（因为他不是主节点），那我们得想办法让其中一台正常的机器升级为主节点.</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240823000625637.png" referrerpolicy="no-referrer" alt="image-20240823000625637"></p><p><span>若原有集群含有大量数据，此时新增一个从节点，这个从节点大概多久能进行工作呢？从节点要完全复制主节点的数据才能开始工作</span></p><h5><a name="一键部署主从模式" class="md-header-anchor"></a><span>一键部署主从模式</span></h5><p><span>测试环境下，单个机器部署多个redis节点，一键部署主从模式，方便测试。将以下命令写进replica-start.sh文件，并执行即可——</span><a href='https://github.com/logerlink/RedisTest/blob/main/redis-bash/replica-start.sh'><span>replica-start.sh </span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">chomd <span class="cm-operator">+</span>x ./replica-start.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/7001/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-replica/7001/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-replica/7001/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定节点密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 永久指定主从关系，重启后仍可用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># replicaof 0.0.0.0 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启rdb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">3600</span> <span class="cm-number">1</span> <span class="cm-number">300</span> <span class="cm-number">100</span> <span class="cm-number">60</span> <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭AOF </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span>:6379 <span class="cm-attribute">--name</span> test-redis-7001 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7002 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/7002/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-replica/7002/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-replica/7002/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定节点密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 永久指定主从关系，重启后仍可用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replicaof <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启rdb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">3600</span> <span class="cm-number">1</span> <span class="cm-number">300</span> <span class="cm-number">100</span> <span class="cm-number">60</span> <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭AOF </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7002</span>:6379 <span class="cm-attribute">--name</span> test-redis-7002 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7002/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7002/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/7003/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-replica/7003/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-replica/7003/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">6379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定节点密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 永久指定主从关系，重启后仍可用</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">replicaof <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启rdb</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">save <span class="cm-number">3600</span> <span class="cm-number">1</span> <span class="cm-number">300</span> <span class="cm-number">100</span> <span class="cm-number">60</span> <span class="cm-number">10000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 关闭AOF </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">appendonly no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7003</span>:6379 <span class="cm-attribute">--name</span> test-redis-7003 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7003/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7003/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1859px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1859px;"></div></div></div></pre><h4><a name="哨兵机制---sentinel" class="md-header-anchor"></a><span>哨兵机制—Sentinel</span></h4><p><span>上面的主从模式虽然可以实现读写分离，但是仍有个隐患——主节点宕机之后，整个集群无法写数据。那有没有办法让主节点&quot;自动复活&quot;之类的操作呢？答案肯定也是有的。</span></p><p><span>我们可以安排一个小工头去监控整个集群工作情况，若主节点无法正常工作，则让另一个节点代替主节点工作，保证读写正常。当然了，一个小工头能力也有限，如果小工头也宕机罢工不干了，那就没人来监控了，所以我们也可以添加多个小工头一起来进行监控整个集群工作情况</span></p><h5><a name="哨兵机制图解" class="md-header-anchor"></a><span>哨兵机制图解</span></h5><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240908193544925.png" referrerpolicy="no-referrer" alt="image-20240908193544925"></p><h5><a name="哨兵三大功能" class="md-header-anchor"></a><span>哨兵三大功能</span></h5><p><span>Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障转移，主要起到</span><strong><span>监控、自动故障转移、通知</span></strong><span>三个功能</span></p><p><strong><span>监控</span></strong><span>：哨兵会不断检查主节点和从节点是否正常工作。</span></p><p><span>心跳机制，每秒发送ping命令，若节点不回复，则认为该实例</span><strong><span>主观下线</span></strong><span>（sdown）。若超过指定数量（quorum）的哨兵都认为该实例主观下线，则认为该实例</span><strong><span>客观下线</span></strong><span>（odown，已确认宕机）</span></p><p><strong><span>自动故障转移</span></strong><span>：若主节点宕机，哨兵会自动选择一个从节点升级为主节点，前一个主节点恢复后会变成从节点</span></p><p><strong><span>选择从节点的选举依据</span></strong></p><ol start='' ><li><span>首先判断从节点与主节点断开的时间长短，若超过指定值（down-after-milliseconds * 10），则直接排除该从节点</span></li><li><span>第二步判断节点的slave-priority值，越小优先级越高，0表示不参加选举</span></li><li><span>第三步判断从节点的</span><strong><span>offset</span></strong><span>，越大说明数据越新，优先级越高（最重要）</span></li><li><span>最后判断从节点的运行Id（启动时自动生成的），越小优先级越高</span></li></ol><p><strong><span>如何实现故障转移？</span></strong></p><p><span>哨兵选中一个从节点，并发送</span><code>slaveof NO ONE</code><span>命令给该节点执行，让其成为主节点</span></p><p><span>哨兵会给剩下的从节点发送</span><code>slaveof 从IP 从端口</code><span>命令，让其成为新主节点的从节点，并开始同步master数据</span></p><p><span>最后，哨兵会将故障节点标记为从节点，加入</span><code>slaveof 从IP 从端口</code><span>命令到配置文件，等故障节点恢复后自动成为主节点的从节点</span></p><p><strong><span>通知</span></strong><span>：集群发生故障时，Redis哨兵通过使用pub/sub机制向客户端发送切换通知，客户端通过订阅哨兵的消息来接收通知并重新连接到新的主节点，实现了高可用性和可靠性的Redis部署</span></p><h5><a name="配置文件sentinelconf" class="md-header-anchor"></a><span>配置文件sentinel.conf</span></h5><p><span>我们只需要在原有的主从模式下添加哨兵集群即可，注意是使用</span><code>redis-sentinel xx.conf</code><span>启动哨兵而且</span><strong><span>哨兵集群无需主从复制</span></strong><span>，以下是通用配置文件</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="ini" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="ini"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">bind 0.0.0.0</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 端口，默认26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port 26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最重要的。监控主节点获取主节点和从节点(info replication)的信息  2表示quorum，建议设置为哨兵节点个数的一半并向上取整</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel monitor masterName 119.45.100.200 7001 2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主从模式主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel auth-pass masterName 123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 故障转移，选举master时使用。从节点与主节点断开时间长短指定值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel down-after-milliseconds masterName 10000 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定 Sentinel 在主节点不可达后，尝试将从节点切换为主节点的时间限制（毫秒）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#sentinel failover-timeout masterName 50000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定从节点为7002、7003。docker环境下最好手动指定从节点，避免哨兵找不到从节点（docker根据主节点找到的从节点端口都是6379）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel known-replica masterName 119.45.100.200 7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">sentinel known-replica masterName 119.45.100.200 7003</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 336px;"></div><div class="CodeMirror-gutters" style="display: none; height: 336px;"></div></div></div></pre><h5><a name="s1-7005" class="md-header-anchor"></a><span>s1-7005</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放7005端口</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7005</span>/tcp <span class="cm-attribute">--permanent</span> &amp;&amp; firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/s7005/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> /home/redis-test/test-redis-replica/s7005/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7005</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7005 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7005/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7005/conf:/etc/redis \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># -v /home/redis-test/test-redis-replica/s7005/conf:/etc/redis docker挂载配置文件所在的目录，不要映射指定redis-sentinel.conf文件，不然会发出警告：而且哨兵也无法正常工作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 警告：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Could not rename tmp config file (Device or resource busy)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># WARNING: Sentinel was not able to save the new configuration on disk!!!: Device or resource busy</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240825151808267.png" referrerpolicy="no-referrer" alt="image-20240825151808267"></p><h5><a name="s2-7006" class="md-header-anchor"></a><span>s2-7006</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放7006端口</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7006</span>/tcp <span class="cm-attribute">--permanent</span> &amp;&amp; firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/s7006/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> /home/redis-test/test-redis-replica/s7006/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7006</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7006 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7006/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7006/conf:/etc/redis \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240825151756838.png" referrerpolicy="no-referrer" alt="image-20240825151756838"></p><h5><a name="s3-7007" class="md-header-anchor"></a><span>s3-7007</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放7007端口</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7007</span>/tcp <span class="cm-attribute">--permanent</span> &amp;&amp; firewall-cmd <span class="cm-attribute">--reload</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> test-redis-replica/s7007/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># vim补充上面的配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">vim</span> /home/redis-test/test-redis-replica/s7007/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 启动容器</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7007</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7007 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7007/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7007/conf:/etc/redis \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240825152128588.png" referrerpolicy="no-referrer" alt="image-20240825152128588"></p><h5><a name="哨兵及故障演示" class="md-header-anchor"></a><span>哨兵及故障演示</span></h5><p><span>分别成功启动主从模式和哨兵机制，模拟主节点宕机，我们查看哨兵leader的日志可以看到故障转移全过程</span></p><ol start='' ><li><code>+monitor ...</code><span>哨兵启动，监控原主节点7001</span></li><li><code>+slave slave ...</code><span>哨兵自动连接上7001下的从节点。有个问题需要注意，docker环境下会自动连接6379端口作为从节点，忽略即可</span></li><li><code>+sentinel sentinel ...</code><span>识别两个哨兵，组成哨兵集群，用于一起监控主节点是否下线。</span></li><li><code>+sdown ...</code><span>主节点7001主观下线。</span></li><li><code>+odown ...</code><span>若超过quorum个哨兵都认为7001主观下线(sdown)，则视为客观下线(odown)</span></li><li><code>+try failover ...</code><span>尝试对7001进行故障转移</span></li><li><code>+vote-for-leader ...</code><span>哨兵集群投票选举哨兵leader，来负责本次故障转移操作</span></li><li><code>+elected-leader ...</code><span>哨兵leader赢得选取</span></li><li><code>+failover-state-select-slave ...</code><span>哨兵leader开始寻找可升级的从节点</span></li><li><code>+selected-slave ...</code><span>leader选择7003作为新的主节点</span></li><li><code>+failover-state-send-slaveof-noone slave ...</code><span>哨兵leader向7003节点发送</span><code>slaveof no one</code><span> 脱离主从，成为单实例(master)</span></li><li><code>+failover-state-wait-promotion ...</code><span>等待其他哨兵确认7003新主节点</span></li><li><code>+promoted-slave ...</code><span>其他哨兵更新哨兵配置文件，确认新主节点成功</span></li><li><code>+failover-state-reconf-slaves ...</code><span>故障转移状态切换到了 </span><code>reconf-slaves</code><span> 状态</span></li><li><code>+slave-reconf-sent ...</code><span>哨兵leader向其他从节点发送</span><code>slaveof</code><span>命令让其跟随新的主节点</span></li><li><code>+failover-end-for-timeout ...</code><span>故障转移因超时而终止，超时时间可调整</span><code>failover-timeout</code><span>配置 。虽然超时对结果不影响，但是</span><strong><span>超时期间，从节点无法拿到新主节点的新数据</span></strong><span>，待超时后从节点才会从新主节点上同步数据</span></li><li><code>+failover-end ...</code><span>故障转移结束</span></li><li><code>+slave-reconf-sent-be ...</code><span>哨兵leader发送slaveof命令成功</span></li><li><code>+switch-master ...</code><span>哨兵选择新的主节点，并监控新主节点</span></li><li><code>+slave slave</code><span>哨兵自动连接新主节点下的所有从节点，包括故障节点</span></li><li><code>-failover-abort-no-good-slave ...</code><span> 若出现这个指令，说明当前没有从节点可升级为主节点，终止故障转移。这时我们需要看一下主节点是否正常，可以参考故障转移不成功的例子</span></li></ol><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904163625992.png" referrerpolicy="no-referrer" alt="image-20240904163625992"></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904183059724.png" referrerpolicy="no-referrer" alt="image-20240904183059724"></p><p><span>查看redis7002、7003节点日志，从节点7003已经成功升级为主节点，从节点7002也跟着成为7003的从节点，并开始同步主节点数据</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905161021438.png" referrerpolicy="no-referrer" alt="image-20240905161021438"></p><p><span>此时我们再去看redis主从节点和哨兵的配置文件，发现已经被修改</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904184828859.png" referrerpolicy="no-referrer" alt="image-20240904184828859"></p><p><span>查看新主节点7003的info信息，7003已升级为主节点</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905162808629.png" referrerpolicy="no-referrer" alt="image-20240905162808629"></p><p><span>但是故障主节点7001的配置文件未被更改，如果故障节点7001修复后重启，还是主节点吗？</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904185729042.png" referrerpolicy="no-referrer" alt="image-20240904185729042"></p><p><span>重启后我们查看哨兵日志和7001节点日志，发现7001直接变成7003的从节点，而且7001的配置文件也被更改了</span></p><p><span>虽然故障转移成功后7001的配置文件未被更改，但是故障转移期间哨兵已经将故障节点标记为从节点，所以</span><strong><span>故障节点修复后重启会变成从节点</span></strong><span>并从新的主节点同步数据</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904191416509.png" referrerpolicy="no-referrer" alt="image-20240904191416509"></p><p><span>一主两从三哨兵的模式下，主节点宕机后，新主节点也宕机，此时仍旧支持故障转移并访问，若所有的redis节点都宕机，哨兵无法找到可用的节点故障转移失败，过段时间（failover-timeout）继续尝试故障转移，直到成功为止</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905165042011.png" referrerpolicy="no-referrer" alt="image-20240905165042011"></p><p><span>一主两从三哨兵的模式下，从节点宕机主节点正常的情况下 ，哨兵不会进行故障转移</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905165933781.png" referrerpolicy="no-referrer" alt="image-20240905165933781"></p><p><span>我们也可以</span><strong><span>手动触发故障转移</span></strong><span>，手动触发一般不会出现超时情况，因为此时7001仍可用</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL FAILOVER &lt;master-name&gt;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905175338366.png" referrerpolicy="no-referrer" alt="image-20240905175338366"></p><h5><a name="更多哨兵常用命令" class="md-header-anchor"></a><span>更多哨兵常用命令</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL help</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前主节点masterName信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL MASTER masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看主节点masterName下的所有从节点 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL SLAVES masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL REPLICAS masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看主节点是否满足quorum。达到客观下线</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL CKQUORUM masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前哨兵监控的所有主节点，说明哨兵是可以同时监控多个集群的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL MASTERS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前哨兵Id</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL MYID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看其他哨兵</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL SENTINELS masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 监控主节点 MONITOR 主节点名称 ip port quorum</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL MONITOR masterName <span class="cm-number">119</span>.45.x.x <span class="cm-number">7003</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 取消监控主节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL REMOVE masterName</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修改监控主节点配置  SENTINEL SET masterName key value</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL SET masterName quorum <span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># sentinel 配置相关</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL CONFIG SET &lt;param&gt; &lt;value&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL CONFIG GET &lt;param&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 手动触发故障转移</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">SENTINEL FAILOVER masterName</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="display: none; height: 560px;"></div></div></div></pre><h5><a name="c代码演示-n226" class="md-header-anchor"></a><span>c#代码演示</span></h5><p><span>以下演示一下c#代码如何连接并使用</span><strong><span>主从模式+哨兵机制</span></strong><span>，源码参考：</span><a href='https://github.com/logerlink/RedisTest/commit/6d1589f2b2f4c4d5a778c77719c4e466018cfbb6'><span>使用哨兵 · logerlink/RedisTest@6d1589f (github.com)</span></a></p><p><span>redis主从模式+哨兵机制连接字符串，只需加上serviceName即可，注意需要redis主从的密码，而且连接的是</span><strong><span>哨兵集群地址</span></strong><span>。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="json"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"ConnectionStrings"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"Redis"</span>: <span class="cm-string">"119.45.100.100:7005,119.45.100.100:7006,119.45.100.100:7007,password=123456,serviceName=masterName"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><span>redis 帮助类改造——</span><code>CommandFlags.PreferReplica</code><span>优先从节点读取数据</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 设置 key 并保存字符串（如果 key 已存在，则覆盖值）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisKey"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisValue"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="expiry"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">bool</span> <span class="cm-def">StringSet</span>(<span class="cm-variable-3">string</span> <span class="cm-variable">redisKey</span>, <span class="cm-variable-3">string</span> <span class="cm-variable">redisValue</span>, <span class="cm-variable-3">TimeSpan</span><span class="cm-operator">?</span> <span class="cm-variable">expiry</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span class="cm-variable">AddKeyPrefix</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">_db</span>.<span class="cm-variable">StringSet</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">redisValue</span>, <span class="cm-variable">expiry</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 获取字符串</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="redisKey"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="expiry"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span><span class="cm-operator">?</span> <span class="cm-variable">StringGet</span>(<span class="cm-variable-3">string</span> <span class="cm-variable">redisKey</span>, <span class="cm-variable-3">TimeSpan</span><span class="cm-operator">?</span> <span class="cm-variable">expiry</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">redisKey</span> <span class="cm-operator">=</span> <span class="cm-variable">AddKeyPrefix</span>(<span class="cm-variable">redisKey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">_db</span>.<span class="cm-variable">StringGet</span>(<span class="cm-variable">redisKey</span>, <span class="cm-variable">CommandFlags</span>.<span class="cm-variable">PreferReplica</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 我们只需要在相关的读操作后面添加 CommandFlags.PreferReplica 参数，自动优先从节点读取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 写操作无需此参数，因为主从模式下，只有主节点可读写，从节点都是仅可读的</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 560px;"></div><div class="CodeMirror-gutters" style="display: none; height: 560px;"></div></div></div></pre><p><span>具体使用</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// redis 主从模式+哨兵简单演示</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">void</span> <span class="cm-variable">RedisReplicaSentinelTest</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">key</span> <span class="cm-operator">=</span> <span class="cm-string">"redis_sentinel_key"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">success</span> <span class="cm-operator">=</span> &nbsp;<span class="cm-variable">_redis</span>.<span class="cm-variable">StringSet</span>(<span class="cm-variable">key</span>, <span class="cm-string">"Hello world"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">success</span>) <span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaSentinelTest 设置缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> <span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaSentinelTest 设置缓存失败"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaSentinelTest 设置缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">data</span> <span class="cm-operator">=</span> <span class="cm-variable">_redis</span>.<span class="cm-variable">StringGet</span>(<span class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaSentinelTest 读取缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisReplicaSentinelTest 读取缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 605px;"></div><div class="CodeMirror-gutters" style="display: none; height: 605px;"></div></div></div></pre><p><span>程序执行如下图：</span></p><ol start='' ><li><span>主从模式和哨兵均正常，读写缓存成功</span></li><li><span>模拟主节点宕机的同时，立即执行程序，设置缓存失败，读取正常。原因：故障转移需要时间未完成，主节点无法工作，导致设置缓存失败</span></li><li><span>模拟主节点宕机，故障转移成功，7002升级为新的主节点，读写缓存成功。主从切换成功，会修改配置文件，此时会触发 </span><code>IConnectionMultiplexer.ConfigurationChanged</code><span> 事件</span></li><li><span>分别模拟三个哨兵宕机，对程序不影响，读写缓存成功。注意，若启动程序前，哨兵全部宕机，此时是无法连接redis节点的</span></li><li><span>模拟新主节点7002宕机，由于哨兵不可用，无法自动实现故障转移，主节点不可用，设置缓存失败，但从节点仍可读取</span></li></ol><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240908192537750.png" referrerpolicy="no-referrer" alt="image-20240908192537750"></p><h5><a name="常见问题" class="md-header-anchor"></a><span>常见问题</span></h5><p><span>故障转移不一定会成功，如果主节点发生故障，</span><strong><span>哨兵没有找到合适的从节点可升级为主节点，此时会终止故障转移</span></strong><span>，并等待一段时间后（failover-timeout  默认6分钟）继续重试升级从节点为主节点的操作</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment"># +failover-state-select-slave master masterName 119.45.100.200 7001  <span class="cm-tab" role="presentation" cm-text="	">  </span># 查找从节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment"># -failover-abort-no-good-slave master masterName 119.45.100.200 7001<span class="cm-tab" role="presentation" cm-text="	">   </span># 终止故障转移，未找到合适的从节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment"># Next failover delay: I will not start a failover before Tue Aug 27 07:18:33<span class="cm-tab" role="presentation" cm-text="	">   </span># 我等会还会重试故障转移操作的</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240825164100790.png" referrerpolicy="no-referrer" alt="image-20240825164100790"></p><p><span>故障转移不成功，原因排查——</span><strong><span>主从模式是否设置密码</span></strong><span>？若有密码则加上</span><code>sentinel auth-pass &lt;password&gt;</code><span>并保证密码正确</span></p><p><span>故障转移不成功，原因排查——</span><strong><span>docker环境下，哨兵未找到主从模式的从节点</span></strong><span>，如下我们推演一下执行过程</span></p><ol start='' ><li><span>使用docker，正常启动主从模式后添加两个哨兵</span></li><li><span>模拟主节点7001宕机，此时哨兵应该自动选取新的主节点，但是没有成功，哨兵选取新的主节点失败</span></li><li><span>我们查看哨兵日志，发现主节点7001主观下线且客观下线（满足quorum）</span></li><li><span>接着哨兵尝试投票选取主节点，但是</span><span style="color:red"><span>又选中了主节点7001故障节点</span></span></li><li><span>紧接着哨兵终止故障转移，原因是没有找到可用的节点。那为什么没有找到可用节点呢？明明还有两个正常的从节点</span></li><li><span>继续往上查看更久远的日志，发现哨兵启动后，监控主节点（+monitor master...），并连接两个从节点（+slave slave ...）但是</span><span style="color:red"><span>连接从节点失败（+sdown slave ...）</span></span><span>。</span></li><li><span>定位到原因：</span><strong><span>原来连接从节点失败且主节点故障</span></strong><span>，导致哨兵自动故障转移操作被终止，无法完成主从切换。</span></li></ol><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +monitor master masterName 119.45.100.200 7001 quorum 2</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* <span class="cm-operator">+</span>slave slave <span class="cm-number">119</span>.45.100.200:6379 <span class="cm-number">119</span>.45.100.200 <span class="cm-number">6379</span> @ masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* Sentinel new configuration saved on disk</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* <span class="cm-operator">+</span>slave slave <span class="cm-number">172</span>.17.0.1:6379 <span class="cm-number">172</span>.17.0.1 <span class="cm-number">6379</span> @ masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* Sentinel new configuration saved on disk</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* <span class="cm-operator">+</span>sentinel sentinel 39ab47f6ced85979a624c0b7c7c731c61725e3a1 <span class="cm-number">172</span>.17.0.5 <span class="cm-number">26379</span> @ masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* Sentinel new configuration saved on disk</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +sdown slave 119.45.100.200:6379 119.45.100.200 6379 @ masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +sdown slave 172.17.0.1:6379 172.17.0.1 6379 @ masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +sdown master masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +odown master masterName 119.45.100.200 7001 #quorum 2/2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +new-epoch 1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +try-failover master masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">* Sentinel new configuration saved on disk</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +vote-for-leader a70da4c0d5d93bc79f47e0c2a5d99b8d759b2b8b 1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 39ab47f6ced85979a624c0b7c7c731c61725e3a1 voted for a70da4c0d5d93bc79f47e0c2a5d99b8d759b2b8b 1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +elected-leader master masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># +failover-state-select-slave master masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># -failover-abort-no-good-slave master masterName 119.45.100.200 7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># Next failover delay: I will not start a failover before Tue Aug 27 10:31:07 2024</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240827184610125.png" referrerpolicy="no-referrer" alt="image-20240827184610125"></p><p><span>那为什么哨兵连接从节点失败呢？我们先看一下监控主节点后的日志——哎，这两个从节点，为什么端口都是6379呢？我们设定的端口不是7001主节点，7002、7003为从节点吗？</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240829161219185.png" referrerpolicy="no-referrer" alt="image-20240829161219185"></p><p><span>我们再看一下哨兵s7007的配置文件，查看哨兵自动生成的配置，我们发现自动生成连接从节点命令</span><code>sentinel known-replica masterName 从ip 从端口</code><span>，但是</span><strong><span>端口不正确，所以导致哨兵连接从节点失败</span></strong></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240829171052072.png" referrerpolicy="no-referrer" alt="image-20240829171052072"></p><p><span>出现这个问题的原因：哨兵监控主节点，并通过</span><code>info</code><span>命令获取到从节点信息(ip:port)，从而自动识别从节点。但是在docker环境下执行</span><code>info</code><span>命令拿到的端口是docker内部的端口而不是外部映射的端口，如图</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240905171327204.png" referrerpolicy="no-referrer" alt="image-20240905171327204"></p><p><span>我们只需要把两个从节点真正的地址追加到哨兵配置文件即可</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># sentinel known-replica masterName 119.45.100.200 7002</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># sentinel known-replica masterName 119.45.100.200 7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">printf <span class="cm-string">"sentinel known-replica masterName 119.45.100.200 7002 \nsentinel known-replica masterName 119.45.100.200 7003 \n"</span> &gt;&gt; /home/redis-test/test-redis-replica/s7007/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">printf <span class="cm-string">"sentinel known-replica masterName 119.45.100.200 7002 \nsentinel known-replica masterName 119.45.100.200 7003 \n"</span> &gt;&gt; /home/redis-test/test-redis-replica/s7006/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重启哨兵服务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker <span class="cm-builtin">restart</span> test-redis-s-7006 test-redis-s-7007</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 模拟主节点7001宕机</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker <span class="cm-builtin">kill</span> test-redis-7001</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240829230142588.png" referrerpolicy="no-referrer" alt="image-20240829230142588"></p><p><span>到此，哨兵可自动完成切换，哨兵切换的同时也会修改哨兵的配置文件，如下，监听主节点和连接从节点的地址都发生改变</span>
<img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240829230635157.png" referrerpolicy="no-referrer" alt="image-20240829230635157"></p><p><span>当然，为了方便，</span><strong><span>在使用docker搭建哨兵模式时，也可以直接把从节点写到我们的配置文件</span></strong><span>中</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定从节点为7002、7003</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7003</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><span>哨兵故障转移后，redis节点日志出现权限不足无法修改配置文件的情况</span></p><p><span style="color:red"><span># Could not create tmp config file (Permission denied)      # CONFIG REWRITE failed: Permission denied</span></span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240827171927731.png" referrerpolicy="no-referrer" alt="image-20240827171927731"></p><p><span>这种情况一般是docker挂载直接映射配置文件导致的，我们</span><strong><span>修改成映射配置文件所在的目录并给该目录添加写权限</span></strong><span>即可</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span>:6379 <span class="cm-attribute">--name</span> test-redis-7001 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/7001/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-re.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># -v /home/redis-test/test-redis-replica/7001/conf:/etc/redis/conf  映射配置文件所在的目录，redis-re.conf 名称要写对</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-replica/7001/conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904154920599.png" referrerpolicy="no-referrer" alt="image-20240904154920599"></p><p><span>故障转移后更新配置文件成功如下</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240904155455918.png" referrerpolicy="no-referrer" alt="image-20240904155455918"><span> </span></p><h5><a name="一键启动哨兵" class="md-header-anchor"></a><span>一键启动哨兵</span></h5><p><span>测试环境下，单个机器部署多个哨兵节点，一键部署，方便测试。将以下命令写进sentinel-start.sh文件，并执行即可——</span><a href='https://github.com/logerlink/RedisTest/blob/main/redis-bash/sentinel-start.sh'><span>sentinel-start.sh</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">chomd <span class="cm-operator">+</span>x ./sentinel-start.sh</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 22px;"></div><div class="CodeMirror-gutters" style="display: none; height: 22px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#### s7005</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/s7005/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-replica/s7005/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 端口，默认26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最重要的。监控主节点获取主节点和从节点(info replication)的信息  2表示quorum，建议设置为哨兵节点个数的一半并向上取整</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel monitor masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主从模式主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel auth-pass masterName <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 故障转移，选举master时使用。从节点与主节点断开时间长短指定值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel down-after-milliseconds masterName <span class="cm-number">10000</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel failover-timeout masterName <span class="cm-number">50000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定从节点为7002、7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7005</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7005 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7005/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7005/conf:/etc/redis:rw \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#### s7006</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/s7006/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-replica/s7006/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 端口，默认26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最重要的。监控主节点获取主节点和从节点(info replication)的信息  2表示quorum，建议设置为哨兵节点个数的一半并向上取整</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel monitor masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主从模式主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel auth-pass masterName <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 故障转移，选举master时使用。从节点与主节点断开时间长短指定值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel down-after-milliseconds masterName <span class="cm-number">10000</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel failover-timeout masterName <span class="cm-number">50000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定从节点为7002、7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7006</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7006 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7006/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7006/conf:/etc/redis:rw \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#### s7007</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-replica/s7007/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt;/home/redis-test/test-redis-replica/s7007/conf/redis-sentinel.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 端口，默认26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">26379</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 最重要的。监控主节点获取主节点和从节点(info replication)的信息  2表示quorum，建议设置为哨兵节点个数的一半并向上取整</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel monitor masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7001</span> <span class="cm-number">2</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 主从模式主节点的密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel auth-pass masterName <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 故障转移，选举master时使用。从节点与主节点断开时间长短指定值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel down-after-milliseconds masterName <span class="cm-number">10000</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel failover-timeout masterName <span class="cm-number">50000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定从节点为7002、7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">sentinel known-replica masterName <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7007</span>:26379 <span class="cm-attribute">--name</span> test-redis-s-7007 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7007/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-replica/s7007/conf:/etc/redis:rw \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-sentinel /etc/redis/redis-sentinel.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1814px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1814px;"></div></div></div></pre><h5><a name="一键关闭哨兵" class="md-header-anchor"></a><span>一键关闭哨兵</span></h5><p><span>测试环境下，单个机器部署多个哨兵节点，一键关闭主从+哨兵，方便测试。将以下命令写进stop-all.sh文件，并执行即可——</span><a href='https://github.com/logerlink/RedisTest/blob/main/redis-bash/stop-all.sh'><span>stop-all.sh</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">rm</span> <span class="cm-attribute">-rf</span> /home/redis-test/test-redis-replica</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> /home/redis-test/test-redis-replica</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker <span class="cm-builtin">rm</span> <span class="cm-attribute">-f</span> test-redis-7001 test-redis-7002 test-redis-7003 test-redis-s-7005 test-redis-s-7006 test-redis-s-7007</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><h4><a name="分片集群---cluster" class="md-header-anchor"></a><span>分片集群—Cluster</span></h4><p><span>主从模式+哨兵机制可以很好的帮助我们提高redis并发能力和故障恢复，实现高并发高可用的效果。但还有一个问题，随着业务量增大，数据会越来越大。由于主从模式是通过复制来实现数据一致的，相当于三台机器保存同一份大文件（如总数据大小100G，使用主从复制，A、B、C三台机器均保存100G文件）这样才能在不同的机器读取到相同数据。显而易见，这种方式数据冗余比较多，而且三台机器都要使用更大的存储空间和内存来保存数据。而且主从模式+哨兵，很难扩容，节点越多越复杂</span></p><p><span>我们可不可以实现三台机器各自保存一部分数据呢？（如总数据大小100G，A机器保存40G，B、C机器各保存30G）而且还要支持在不同的机器读取到相同数据。当然可以，redis分片集群支持分片保存数据。</span></p><h5><a name="分片集群图解" class="md-header-anchor"></a><span>分片集群图解</span></h5><p><span>redis分片集群可用来</span><strong><span>解决海量数据存储和高并发写问题</span></strong><span>。分片集群有以下特点</span></p><ul><li><span>一个分片集群有多个master节点，每个master节点存储不同的数据</span></li><li><span>每个master都可以有多个slave节点，用于故障转移主从切换</span></li><li><span>不再需要哨兵监控，每个master通过ping检测彼此健康状态</span></li></ul><p><span>Redis默认使用虚拟槽分区，Redis会预先给每个主节点分配16384个插槽（slot），每个节点负责一定区间的slot（如 A：0-5460，B：5461-10922，C： 10923-16383）。存储和读取缓存时，自动对 key 使用 </span><strong><span>CRC16 算法计算再对16384取余，得到一个slot的值</span></strong><span>，并根据slot值寻找并路由到相应节点，然后在该节点上存储或读取数据。当有新的节点加入或者移除的时候，通过迁移槽以及其对应的数据，可以很方便的进行动态扩容或缩容</span></p><p><span>注意分片集群不是只能存储16384个key，slot值仅仅是用来确认操作节点。不同的key计算出相同的slot不会互相覆盖</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240909180122928.png" referrerpolicy="no-referrer" alt="image-20240909180122928"></p><h5><a name="配置文件clusterconf" class="md-header-anchor"></a><span>配置文件cluster.conf</span></h5><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="ini" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="ini"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">port 6379</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">bind 0.0.0.0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cluster-enabled yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cluster-config-file conf/nodes.conf</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">cluster-node-timeout 5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">dir data/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行 使用docker启动，不要指定yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">daemonize no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">protected-mode no</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-def">logfile logs/run.log</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 381px;"></div><div class="CodeMirror-gutters" style="display: none; height: 381px;"></div></div></div></pre><h5><a name="一键部署关闭集群" class="md-header-anchor"></a><span>一键部署关闭集群</span></h5><p><span>测试环境下，单个机器部署多个redis节点，一键部署主从模式，方便测试。将以下命令写进replica-start.sh文件，并执行即可——</span><a href='https://github.com/logerlink/RedisTest/blob/main/redis-bash/cluster-start.sh'><span>cluster-start.sh</span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 一键部署7001-7006节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7001/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7001/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7001/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span>:7001 <span class="cm-attribute">-p</span> <span class="cm-number">17001</span>:17001 <span class="cm-attribute">--name</span> test-cluster-7001 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7001/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7001/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7001/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7002/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7002/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7002/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17002</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7002</span>:7002 <span class="cm-attribute">-p</span> <span class="cm-number">17002</span>:17002 <span class="cm-attribute">--name</span> test-cluster-7002 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7002/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7002/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7002/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7003/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7003/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7003/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17003</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7003</span>:7003 <span class="cm-attribute">-p</span> <span class="cm-number">17003</span>:17003 <span class="cm-attribute">--name</span> test-cluster-7003 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7003/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7003/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7003/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7004</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7004/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7004/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7004/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7004</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17004</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7004</span>:7004 <span class="cm-attribute">-p</span> <span class="cm-number">17004</span>:17004 <span class="cm-attribute">--name</span> test-cluster-7004 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7004/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7004/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7004/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7005</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7005/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7005/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7005/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7005</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17005</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7005</span>:7005 <span class="cm-attribute">-p</span> <span class="cm-number">17005</span>:17005 <span class="cm-attribute">--name</span> test-cluster-7005 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7005/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7005/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7005/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">#####  7006</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> <span class="cm-attribute">-p</span> /home/redis-test/test-redis-cluster/7006/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">chmod</span> <span class="cm-number">777</span> /home/redis-test/test-redis-cluster/7006/conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">cat</span> &lt;&lt; EOF &gt; /home/redis-test/test-redis-cluster/7006/conf/redis-cluster.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">port <span class="cm-number">7006</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># bind 127.0.0.1 -:1  0.0.0.0外网可访问</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">bind <span class="cm-number">0</span>.0.0.0</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开启集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-enabled <span class="cm-builtin">yes</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定集群配置文件，无需创建，自动生成</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-config-file /etc/redis/conf/nodes.conf</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 节点心跳超时事件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-node-timeout <span class="cm-number">5000</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 持久化文件存放目录</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">dir /data/</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 后台运行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">daemonize no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 保护模式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">protected-mode no</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 日志文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">logfile /data/logs/run.log</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指定密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">requirepass <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">masterauth <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster-announce-bus-port <span class="cm-number">17006</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">EOF</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker run <span class="cm-attribute">-d</span> <span class="cm-attribute">-p</span> <span class="cm-number">7006</span>:7006 <span class="cm-attribute">-p</span> <span class="cm-number">17006</span>:17006 <span class="cm-attribute">--name</span> test-cluster-7006 <span class="cm-attribute">--restart</span><span class="cm-operator">=</span>always \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7006/data:/data \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7006/conf:/etc/redis/conf \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-attribute">-v</span> /home/redis-test/test-redis-cluster/7006/logs:/data/logs \</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  redis:7.0 redis-server /etc/redis/conf/redis-cluster.conf</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 4861px;"></div><div class="CodeMirror-gutters" style="display: none; height: 4861px;"></div></div></div></pre><p><a href='https://github.com/logerlink/RedisTest/blob/main/redis-bash/stop-cluster.sh'><span>stop-cluster.sh </span></a></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="bash"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="bash"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-meta">#!/bin/bash</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 一键关闭7001-7006节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">rm</span> <span class="cm-attribute">-rf</span> /home/redis-test/test-redis-cluster</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-builtin">mkdir</span> /home/redis-test/test-redis-cluster</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">for</span> port <span class="cm-keyword">in</span> <span class="cm-quote">$(seq 7001 7006)</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">do</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  docker <span class="cm-builtin">rm</span> <span class="cm-attribute">-f</span> test-cluster-<span class="cm-def">${port}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">done</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><h5><a name="创建集群" class="md-header-anchor"></a><span>创建集群</span></h5><p><span>创建集群之前，防火墙先开放端口：节点端口7001-7010，总线端口17001-17010。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 记得开放端口</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">7001</span><span class="cm-attribute">-7010</span>/tcp <span class="cm-attribute">--permanent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 开放总线端口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--zone</span><span class="cm-operator">=</span>public <span class="cm-attribute">--add-port</span><span class="cm-operator">=</span><span class="cm-number">17001</span><span class="cm-attribute">-17010</span>/tcp <span class="cm-attribute">--permanent</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">firewall-cmd <span class="cm-attribute">--reload</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>公网服务器还需要设置安全组开放指定端口，</span><strong><span>谨慎操作</span></strong></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910160856066.png" referrerpolicy="no-referrer" alt="image-20240910160856066"></p><p><span>部署并启动6个节点后，还需要手动执行相应命令创建集群，将所有节点关联起来</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 随便进入一个节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">docker exec <span class="cm-attribute">-it</span> test-cluster-7001 <span class="cm-builtin">bash</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 创建集群 执行后输入yes，输入其他的话会直接终止创建集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">--cluster</span> create <span class="cm-attribute">--cluster-replicas</span> <span class="cm-number">1</span> <span class="cm-number">119</span>.45.100.200:7001 <span class="cm-number">119</span>.45.100.200:7002 <span class="cm-number">119</span>.45.100.200:7003 <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-number">119</span>.45.100.200:7005 <span class="cm-number">119</span>.45.100.200:7006 <span class="cm-attribute">-a</span> <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --cluster-replicas 1 表示集群的副本数量为1，master默认是1，两个节点一组。这里一共6个节点，6/2=3，一共三个master节点。默认前三个为master节点，后三个为副本节点。注意，这里主从没有固定的对应关系，7001的从节点可能是7004、7005、7006三个其中一个，一切要看实际分配方案，也可以创建集群后通过 redis-cli -p 7001 cluster nodes 查看集群状态查看</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 没有从节点可以不指定--cluster-replicas，或者指定为--cluster-replicas 0即可</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># -a 123456 指定密码</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910171349651.png" referrerpolicy="no-referrer" alt="image-20240910171349651"></p><p><span>注意，Redis5.0之后，集群管理操作已经集成到了redis-cli中，我们只需要redis-cli命令即可管理集群。Redis5.0之前，需安装redis-trib.rb才能管理集群</span></p><h5><a name="分片集群演示" class="md-header-anchor"></a><span>分片集群演示</span></h5><p><span>演示之前我们先了解一下插槽，Redis会预先分配16384个插槽给每个主节点，每个主节点负责一定区间的slot。redis会根据key的</span><strong><span>有效部分</span></strong><span>自动计算插槽值，再找到对应的节点进行读写数据。意味着我们无需刻意知道数据与哪个插槽绑定，更不需要知道数据在哪个节点上</span></p><p><span>redis数据</span><strong><span>key不是和节点绑定，而是与插槽绑定</span></strong><span>，方便扩容缩容迁移数据，若数据key和节点绑定，节点宕机无法恢复，那意味着数据就永久丢失了。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910180734013.png" referrerpolicy="no-referrer" alt="image-20240910180734013"></p><p><span>redis分片集群可以连接从节点写入数据，不过最终写入操作还是由主节点执行（从节点只计算插槽并路由）</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915145827903.png" referrerpolicy="no-referrer" alt="image-20240915145827903"></p><p><span>注意在redis集群中，</span><code>keys * 、flushdb、flushall</code><span>只能操作当前节点的数据，不能操作整个集群的数据。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910184336241.png" referrerpolicy="no-referrer" alt="image-20240910184336241"></p><p><span>一条命令有时无法同时操作多个key（如DEL、SINTER...）判断依据是key的有效部分。若这些key有效部分相同则允许操作，若不一致则会报错：</span><span style="color:red"><span>(error) CROSSSLOT Keys in request don&#39;t hash to the same slot</span></span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910185952502.png" referrerpolicy="no-referrer" alt="image-20240910185952502"></p><p><span>redis分片集群默认只有1个数据库，无法执行</span><code>select db</code><span>选择数据库，否则报错：</span><span style="color:red"><span>(error) ERR SELECT is not allowed in cluster mode</span></span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910184609164.png" referrerpolicy="no-referrer" alt="image-20240910184609164"></p><h5><a name="故障演示-n340" class="md-header-anchor"></a><span>故障演示</span></h5><p><span>redis三主三从分片集群，如果某个主节点宕机后，该主节点的下的从节点会自动选举升级为新主节点，代替故障主节点工作</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911124524993.png" referrerpolicy="no-referrer" alt="image-20240911124524993"></p><p><span>我们可以查看一下新主节点7006的日志和当前集群状态</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911125825630.png" referrerpolicy="no-referrer" alt="image-20240911125825630"></p><p><span>redis三主三从分片集群，如果某个主节点宕机后，故障转移完成后，新主节点再次宕机，此时整个集群将不可用，报错：</span><span style="color:red"><span>(error) CLUSTERDOWN The cluster is down</span></span><span>。难道redis分片集群最少需要三个主节点才能正常工作吗？继续往下看</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911142723096.png" referrerpolicy="no-referrer" alt="image-20240911142723096"></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911130655038.png" referrerpolicy="no-referrer" alt="image-20240911130655038"></p><p><span>redis三主三从分片集群，升级为四主四从，如果某个主节点宕机后，故障转移完成后，新主节点再次宕机，此时集群仍不可用，报错：</span><span style="color:red"><span>(error) CLUSTERDOWN The cluster is down</span></span><span>。说明</span><strong><span>当某个主节点宕机且该主节点不存在可用从节点时会导致集群不可用</span></strong></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911151401599.png" referrerpolicy="no-referrer" alt="image-20240911151401599"></p><p><span>redis三主三从分片集群，如果超过半数的主节点宕机，集群不可用，报错：</span><span style="color:red"><span>(error) CLUSTERDOWN The cluster is down</span></span><span>。说明</span><strong><span>当集群中超过半数的主节点宕机，会导致集群不可用</span></strong><span>，即使故障主节点下存在可用的从节点。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911152948673.png" referrerpolicy="no-referrer" alt="image-20240911152948673"></p><p><span>redis三主三从分片集群，若某个主节点宕机后，完成故障转移后，另一个主节点才宕机，待完成故障转移，此时集群仍可用。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911154310912.png" referrerpolicy="no-referrer" alt="image-20240911154310912"></p><p><span>redis三主三从分片集群，若某个主节点宕机后，</span><strong><span>完成故障转移后，故障主节点恢复后会直接变成从节点</span></strong><span>，并从新主节点同步数据</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911160617808.png" referrerpolicy="no-referrer" alt="image-20240911160617808"></p><h5><a name="c代码演示-n356" class="md-header-anchor"></a><span>c#代码演示</span></h5><p><span>以下演示一下c#代码如何连接并使用分片集群，源码参考：</span><a href='https://github.com/logerlink/RedisTest/commit/9c84c6d027459d27b911c99050a48224e882ab14'><span>分片集群 · logerlink/RedisTest@9c84c6d (github.com)</span></a></p><p><span>redis分片集群连接字符串</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="json"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="json"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-string">"ConnectionStrings"</span>: {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-string cm-property">"Redis"</span>: <span class="cm-string">"119.45.100.100:7001,119.45.100.100:7002,119.45.100.100:7003,119.45.100.100:7004,119.45.100.100:7005,119.45.100.100:7006,password=123456"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">  },</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><span>redis 帮助类改造——</span><code>CommandFlags.PreferReplica</code><span>优先从节点读取数据</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// redis 分片集群简单演示</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">void</span> <span class="cm-variable">RedisClusterTest</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">key</span> <span class="cm-operator">=</span> <span class="cm-string">"redis_cluster_key_"</span> <span class="cm-operator">+</span> <span class="cm-variable-3">Guid</span>.<span class="cm-variable">NewGuid</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">success</span> <span class="cm-operator">=</span> <span class="cm-variable">_redis</span>.<span class="cm-variable">StringSet</span>(<span class="cm-variable">key</span>, <span class="cm-string">"Hello world"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">success</span>) <span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisClusterTest 设置缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> <span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisClusterTest 设置缓存失败"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisClusterTest 设置缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">data</span> <span class="cm-operator">=</span> <span class="cm-variable">_redis</span>.<span class="cm-variable">StringGet</span>(<span class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogInformation</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisClusterTest 读取缓存成功"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">ex</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_logger</span>.<span class="cm-variable">LogError</span>(<span class="cm-variable">$</span><span class="cm-string">"RedisClusterTest 读取缓存失败，{ex.Message}"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 605px;"></div><div class="CodeMirror-gutters" style="display: none; height: 605px;"></div></div></div></pre><h5><a name="redis集群常见命令------cluster" class="md-header-anchor"></a><span>redis集群常见命令——cluster</span></h5><p><span>redis集群创建成功，我们可以使用cluster的相关命令查看和操作集群，需要进入redis环境中执行</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看帮助信息</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster help</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群连接信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster LINKS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群信息 在redis中查看</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster info</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 134px;"></div><div class="CodeMirror-gutters" style="display: none; height: 134px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911162022937.png" referrerpolicy="no-referrer" alt="image-20240911162022937"></p><h6><a name="插槽相关" class="md-header-anchor"></a><span>插槽相关</span></h6><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看插槽分配情况</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cluster slots</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915170250691.png" referrerpolicy="no-referrer" alt="image-20240915170250691"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 计数当前节点某个插槽有多少个key</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER COUNTKEYSINSLOT &lt;slot&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看当前节点插槽槽位上的所有key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;COUNT&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群中key的槽位，可以跨节点查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER KEYSLOT &lt;key&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 清除当前节点预分配的所有槽位，若该节点存在数据，需要先清除，否则报错：(error) ERR DB must be empty to perform CLUSTER FLUSHSLOTS</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 仅撤销当前节点的插槽，撤销插槽后，插槽未分配会导致该节点不可用。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER FLUSHSLOTS</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 以下这些命令不知道怎么使用，组合在一起完全看不到效果，只能在同一个节点撤销插槽和分配插槽有什么用？？？建议使用redis-cli reshard命令来分配插槽</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 撤销插槽。仅撤销当前节点的插槽，撤销插槽后，插槽未分配会导致该节点不可用。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER DELSLOTS &lt;slot&gt;...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 撤销一批插槽 slot1-slot2。仅撤销当前节点的插槽，撤销插槽后，插槽未分配会导致该节点不可用。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER DELSLOTSRANGE &lt;slot1&gt; &lt;slot2&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指派插槽。不能跨节点指派，那有什么用？</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER ADDSLOTS &lt;slot&gt;...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 指派一批插槽 slot1-slot2.不能跨节点指派，那有什么用？</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER ADDSLOTSRANGE &lt;slot1&gt; &lt;slot2&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 470px;"></div><div class="CodeMirror-gutters" style="display: none; height: 470px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915165622727.png" referrerpolicy="no-referrer" alt="image-20240915165622727"></p><h6><a name="节点相关" class="md-header-anchor"></a><span>节点相关</span></h6><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点Id</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER MYID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看主节点的副本节点 node-id：节点Id，可通过CLUSTER MYID、CLUSTER NODES查看node-id。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 要在主节点执行，否则报错：(error) ERR The specified node is not a master</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER REPLICAS &lt;node-id&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群的所有节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER NODES</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群分片情况 包括插槽、节点信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER SHARDS</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 202px;"></div><div class="CodeMirror-gutters" style="display: none; height: 202px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915170137687.png" referrerpolicy="no-referrer" alt="image-20240915170137687"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 将指定节点加入集群</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 默认添加进来的就是主节点，但是不会自动分配插槽，我们仍可以在这个新节点中执行 CLUSTER REPLICATE 主节点Id 将其变为从节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER MEET &lt;node_ip&gt; &lt;node_port&gt; [bus_port]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 配置从节点复制主节点。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 注意要在即将变成从节点的节点上执行,且这个节点没有数据也没有分配插槽，否则报错：(error) ERR To set a master the node must be empty and without assigned slots.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER REPLICATE &lt;nodeId&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 从集群中移除节点。逻辑删除，并不是真正的移除，过一会又回来了（不明白有什么用）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 不能移除自身，否则报错：(error) ERR I tried hard but I can't forget myself。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 从节点也不能移除其主节点，否则报错：(error) ERR Can't forget my master!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER FORGET &lt;node_id&gt;</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 246px;"></div><div class="CodeMirror-gutters" style="display: none; height: 246px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915150503689.png" referrerpolicy="no-referrer" alt="image-20240915150503689"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重置节点，遗忘该节点已知的其他所有节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER RESET</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><span>CLUSTER RESET用于重置节点，遗忘该节点已知的其他所有节点，撤销指派给该节点的所有槽，并清空节点内部的槽-节点映射。</span></p><p><span>重置之前主节点不可存在任何key（从节点不受限制）否则报错：</span><span style="color:red"><span>(error) ERR CLUSTER RESET can&#39;t be called with master nodes containing keys。</span></span></p><p><span>可选参数HARD、SOFT，默认SOFT配置。如果执行的是HARD重置，那么该节点会创建一个新节点ID，并将节点的纪元和配置纪元都设置为0</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911184414484.png" referrerpolicy="no-referrer" alt="image-20240911184414484"></p><p><span>重置主节点后，集群状态显示ok，表示可用，7003节点失联。但是集群有些插槽不可用，读写数据时，redis计算key的slot值刚好落到已重置主节点之前的槽位，会报错这两种错误：</span></p><ol start='' ><li><span style="color:red"><span>(error) CLUSTERDOWN Hash slot not served </span></span><span>（指定SOFT参数会出这个错误）。</span><strong><span>解决方案</span></strong><span>：连接另一个可用节点7001进去集群执行</span><code>CLUSTER MEET 119.45.100.200 7003 17003</code><span>将重置节点7003重新加入集群，再连接重置节点7003进入集群执行</span><code>CLUSTER ADDSLOTSRANGE 10923 16383</code><span>添加全部插槽（不添加全部插槽仍然是失败的）</span></li><li><span style="color:red"><span>Could not connect to Redis at :0: Name or service not known</span></span><span>（指定HARD参数会出这个错误），未重置的其他主节点不受影响，正常读写。</span><strong><span>解决方案</span></strong><span>：连接另一个可用节点7001进去集群执行</span><code>CLUSTER MEET 119.45.100.200 7003 17003</code><span>将重置节点7003重新加入集群，并执行</span><code>CLUSTER FORGET 原7003强重置前的节点Id</code><span>让集群忘记旧节点Id，再连接重置节点7003进入集群执行</span><code>CLUSTER ADDSLOTSRANGE 10923 16383</code><span>添加全部插槽（不添加全部插槽仍然是失败的）</span></li></ol><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911185201501.png" referrerpolicy="no-referrer" alt="image-20240911185201501"></p><p><span>重置从节点后，集群状态显示fail不可用，该节点7006会变成主节点，但不可直接使用也不影响整个集群，其他节点正常读写数据。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911231705392.png" referrerpolicy="no-referrer" alt="image-20240911231705392"></p><p><span>重置从节点7006后，我们想让该节点分配插槽存储数据应该怎么处理呢？此时使用redis-cli的</span><code>check、fix、reshard、rebalance</code><span>命令都会出现一个错误：</span><span style="color:red;"><span>[ERR] Nodes don&#39;t agree about configuration!</span></span><span>。我们只需要</span><strong><span>手动将节点7006移出集群，再将7006加入集群</span></strong><span>即可</span></p><p><span>我们可以先观察一下节点状态、集群状态是否正常，如果正常则观察所有节点的配置文件（集群自动生成和维护那个文件）看看是否正常，不正常则手动修改该配置文件。如果两个问题都正常则连接另一个可用节点7002，执行</span><code>redis-cli -c -a 123456 -p 7002 --cluster del-node 119.45.100.200:7002 7006节点Id</code><span>移除7006节点，再执行</span><code>redis-cli -c -a 123456 -p 7002 --cluster add-node 119.45.100.200:7006 119.45.100.200:7002</code><span>添加7006节点到集群中，再执行</span><code>reshard或rebalance</code><span>就可以分配插槽了。这个场景下不要用</span><code>cluster meet</code><span>加入节点7006，也不要使用</span><code>cluster ADDSLOTS</code><span>分配插槽，否则报错：</span><span style="color:red"><span>(error) ERR Slot xxx is already busy</span></span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240916163829996.png" referrerpolicy="no-referrer" alt="image-20240916163829996"></p><h6><a name="故障转移" class="md-header-anchor"></a><span>故障转移</span></h6><p><span>手动故障转移，在从节点上执行，将从节点升级为新的主节点，而原来的主节点降级为从节点。缺省参数FORCE：强制执行，TAKEOVER：更加强制执行</span></p><p><span>无法在主节点执行手动故障转移，否则报错：</span><span style="color:red;"><span>（ERR）You should send CLUSTER FAILOVER to a replica</span></span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 手动故障转移</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">CLUSTER FAILOVER</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 正常（默认）：从节点与主节点交互，复制偏移量、发起选举、统计选票、赢得选举、升级为主节点并更新配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># FORCE：直接发起选举、统计选票、赢得选举、升级为主节点并更新配置</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># TAKEOVER:直接升级为主节点并更新配置</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 112px;"></div><div class="CodeMirror-gutters" style="display: none; height: 112px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911171122094.png" referrerpolicy="no-referrer" alt="image-20240911171122094"></p><p><span>指定FORCE、TAKEOVER的故障转移流程，如下</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240911171945652.png" referrerpolicy="no-referrer" alt="image-20240911171945652"></p><p><span>故障转移大致流程图如下。关于故障转移更多信息请参考：</span><a href='https://www.cnblogs.com/gqtcgq/p/7247041.html' target='_blank' class='url'>https://www.cnblogs.com/gqtcgq/p/7247041.html</a><span>；</span><a href='https://developer.aliyun.com/article/638627' target='_blank' class='url'>https://developer.aliyun.com/article/638627</a></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240916145250305.png" referrerpolicy="no-referrer" alt="image-20240916145250305"></p><h5><a name="redis集群常见命令------redis-cli" class="md-header-anchor"></a><span>redis集群常见命令——redis-cli</span></h5><p><span>使用redis-cli的相关命令查看和操作集群，不需要进入redis环境中执行</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># redis-cli 集群帮助</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">--cluster</span> help</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 创建集群</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">--cluster</span> create <span class="cm-attribute">--cluster-replicas</span> <span class="cm-number">0</span> <span class="cm-number">119</span>.45.100.200:7001 <span class="cm-number">119</span>.45.100.200:7002 <span class="cm-number">119</span>.45.100.200:7003 &nbsp;<span class="cm-attribute">-a</span> <span class="cm-number">123456</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 连接集群 -c：cluster -a 指定密码，也可以不用-a，先连接再执行auth 123456命令。不指定-c可能会报错：(error) MOVED 3300 119.45.100.200:7001</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-c</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span> <span class="cm-attribute">-a</span> <span class="cm-number">123456</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 179px;"></div><div class="CodeMirror-gutters" style="display: none; height: 179px;"></div></div></div></pre><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群节点信息和状态 -a 指定密码</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-c</span> <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">-p</span> <span class="cm-number">7001</span> cluster nodes</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910173529733.png" referrerpolicy="no-referrer" alt="image-20240910173529733"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看集群插槽、节点信息，使用--cluster不能用-c</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> info <span class="cm-number">119</span>.45.100.200 <span class="cm-number">7002</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915171439579.png" referrerpolicy="no-referrer" alt="image-20240915171439579"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 集群验证及监控 查看key分布情况、节点、插槽信息</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> check <span class="cm-number">119</span>.45.100.200:7001</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 45px;"></div><div class="CodeMirror-gutters" style="display: none; height: 45px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915223502590.png" referrerpolicy="no-referrer" alt="image-20240915223502590"></p><h6><a name="节点相关-n411" class="md-header-anchor"></a><span>节点相关</span></h6><p><span>删除节点，有数据不允许删除节点，否则报错：</span><span style="color:red;"><span>[ERR] Node 119.45.100.200:7004 is not empty! Reshard data away and try again.</span></span></p><p><span>添加节点，默认添加为主节点，但不会自动为新节点分配插槽</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 删除节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> del-node <span class="cm-number">119</span>.45.100.200:7004 &lt;nodeId&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加节点 --cluster-slave 添加为从节点 --cluster-master-id &lt;id&gt; 指定主节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> add-node <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-number">119</span>.45.100.200:7005 <span class="cm-attribute">--cluster-slave</span> <span class="cm-attribute">--cluster-master-id</span> &lt;master-nodeId&gt;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 添加节点格式：redis-cli -a 123456 --cluster add-node 新节点 任意一个可用旧节点 --cluster-slave --cluster-master-id 主节点Id</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 157px;"></div><div class="CodeMirror-gutters" style="display: none; height: 157px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915175516534.png" referrerpolicy="no-referrer" alt="image-20240915175516534"></p><h6><a name="插槽相关-n416" class="md-header-anchor"></a><span>插槽相关</span></h6><p><span>重新分配插槽，仅能重新分配插槽给主节点，否则（选择receiveId时）报错：</span><span style="color:red;"><span>The specified node (e65ee025151ea6c5f3a1049adfc25d1aa4cad77a) is not known or not a master, please retry.</span></span><span>不管该节点有无数据，都可以进行重新分配插槽</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重新分配插槽，迁移插槽、迁移数据到某个主节点。</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> reshard <span class="cm-number">119</span>.45.100.200:7004</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 执行后按图示操作。有两种方式——下图2.1或2.2</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 67px;"></div><div class="CodeMirror-gutters" style="display: none; height: 67px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915191708318.png" referrerpolicy="no-referrer" alt="image-20240915191708318"></p><p><span>需要注意的是</span><strong><span>若将某个节点1的插槽全部迁移至另一个节点2，则节点1将会变成节点2的从节点</span></strong><span>。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915211523203.png" referrerpolicy="no-referrer" alt="image-20240915211523203"></p><p><span>那过段时间我又想给这个节点1分配插槽呢？我们可以</span><strong><span>手动将节点1删除，再以主节点的身份加入集群，这样就可以重新分配插槽了</span></strong><span>。这里不要使用</span><code>forget和reset</code><span>命令删除从节点，反正我没成功过</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915212629807.png" referrerpolicy="no-referrer" alt="image-20240915212629807"></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重新分配插槽达到一种平衡，默认规则，可连接任意一个节点</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> rebalance <span class="cm-number">119</span>.45.100.200:7004</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重新分配插槽达到一种平衡， --cluster-use-empty-masters：给空节点分配点数据 &nbsp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> rebalance <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-attribute">--cluster-use-empty-masters</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 重新分配插槽达到一种平衡，指定权重，权重越大分配的插槽就越多 --cluster-weight &lt;nodeId1=w1...nodeIdN=wN&gt; 指定权重</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> rebalance <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-attribute">--cluster-weight</span> <span class="cm-def">6257746a752df0799e849b16caa4f0220ea6fab6</span><span class="cm-operator">=</span><span class="cm-number">1</span> <span class="cm-def">9463bd5f730db14452cc9e698662079ec390cf5b</span><span class="cm-operator">=</span><span class="cm-number">5</span> <span class="cm-def">57a4c58d2bee85b6b522b0d6c25cd6597cc4d36b</span><span class="cm-operator">=</span><span class="cm-number">5</span> <span class="cm-def">4eec057c64b27187ecbe44b2664e5632d6232385</span><span class="cm-operator">=</span><span class="cm-number">1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --cluster-simulate：模拟运行，不会真正执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> rebalance <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-attribute">--cluster-simulate</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 224px;"></div><div class="CodeMirror-gutters" style="display: none; height: 224px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915221508787.png" referrerpolicy="no-referrer" alt="image-20240915221508787"></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915222638000.png" referrerpolicy="no-referrer" alt="image-20240915222638000"></p><h6><a name="其他" class="md-header-anchor"></a><span>其他</span></h6><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 修复集群</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --cluster-search-multiple-owners:是否修复多个拥有者的槽位。当集群中的槽位在迁移过程中，出现意外时，使用fix可使用该参数。fix功能，redis内部在槽位的某些异常情况下会交互式的询问操作者是否同意它的修复策略，一般情况下，默认即可</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># --cluster-fix-with-unreachable-masters:是否修复不可达的主节点上的槽位。例如，集群中某个主节点就是坏掉了，也没有故障转移成功。此时如何恢复该主节点上的所有槽位呢，这时就可以使用该参数，会将处于该主节点上的所有槽位恢复到存活的主节点上（之前的数据会丢失，仅仅是恢复了槽位）</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> fix <span class="cm-number">119</span>.45.100.200:7004 <span class="cm-attribute">--cluster-search-multiple-owners</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 在集群中执行redis命令 --cluster-only-masters：仅主节点执行，--cluster-only-replicas：仅从节点执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 如每个都执行keys * 命令</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> call <span class="cm-number">119</span>.45.100.200:7004 keys \*</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 整个集群的cluster-node-timeout时间，单位毫秒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> set-timeout <span class="cm-number">119</span>.45.100.200:7004 </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 导入数据 --cluster-replace 出现重复key时强行替换targetIP的key；--cluster-copy保留fromIP的数据，默认删除；建议使用redis-shake 迁移数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> import targetIP:6379 <span class="cm-attribute">--cluster-from</span> fromIP:6379 <span class="cm-attribute">--cluster-replace</span> <span class="cm-attribute">--cluster-copy</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 备份集群rdp文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">--cluster</span> backup <span class="cm-number">119</span>.45.100.200:7004 ./outputDir</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 403px;"></div><div class="CodeMirror-gutters" style="display: none; height: 403px;"></div></div></div></pre><p><span>redis-cli的</span><code>check, fix, reshard, del-node, set-timeout, info, rebalance, call, import, backup</code><span>命令</span><strong><span>可以指定集群内的任意一个节点执行，可以的话建议使用不重要的节点执行这些命令</span></strong></p><p><span>redis-cli可以和cluster的一些命令结合使用，如下</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="shell"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看节点Id</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-c</span> <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">-p</span> <span class="cm-number">7002</span> cluster MYID</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment"># 查看a key的插槽</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">redis-cli <span class="cm-attribute">-c</span> <span class="cm-attribute">-a</span> <span class="cm-number">123456</span> <span class="cm-attribute">-p</span> <span class="cm-number">7002</span> cluster KEYSLOT a</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 90px;"></div><div class="CodeMirror-gutters" style="display: none; height: 90px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240915231107520.png" referrerpolicy="no-referrer" alt="image-20240915231107520"></p><h4><a name="常见问题-n433" class="md-header-anchor"></a><span>常见问题</span></h4><p><strong><em><span>使用docker启动redis，容器一直处于重启状态？</span></em></strong></p><p><span>把</span><code>daemonize yes</code><span>后台运行改成</span><code>daemonize no</code><span>即可，亲测有效。修改docker</span><code>--restart</code><span>参数不管用</span></p><p><strong><em><span>创建集群时，报错：</span><span style="color:red"><span>[ERR] Node 119.45.100.200:7001 NOAUTH Authentication required？</span></span></em></strong></p><p><span>redis-cli指定-a加上密码即可，</span><code>redis-cli --cluster ... -a &lt;password&gt;</code></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910171829864.png" referrerpolicy="no-referrer" alt="image-20240910171829864"></p><p><strong><em><span>创建集群后一直处于Waiting for the cluster to join状态？</span></em></strong></p><p><span>大多两个原因：集群的节点端口没有开放；集群的节点总线端口没有开放。集群总线端口用于集群之间互相通信</span></p><p><span>还有一个原因：同一个机器创建多个节点创建集群并且使用docker运行redis时，各个节点的配置文件的节点端口和总线端口不要一致（如都是6379、16379）否则可能连不上。搞了半天原来是这个原因</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240910154631767.png" referrerpolicy="no-referrer" alt="image-20240910154631767"></p><p><strong><em><span>如何更安全的设置密码？使用 -a 提示：Warning: Using a password with &#39;-a&#39; or &#39;-u&#39; option on the command line interface may not be safe.</span></em></strong></p><p><span>若集群设置密码，我们可以使用</span><code>--no-auth-warning</code><span>参数取消不安全警告；也可以连接集群后，在redis内部使用</span><code>auth password</code><span>指定密码。但是有些</span><code>redis-cli --cluster</code><span>一定要加上-a指定密码才可以执行</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240916164759615.png" referrerpolicy="no-referrer" alt="image-20240916164759615"></p><p><strong><em><span>如何让一批不同的key落到同一个节点上？</span></em></strong></p><p><span>redis会根据key的</span><strong><span>有效部分</span></strong><span>自动计算插槽值，再找到对应的节点进行读写数据</span></p><ul><li><span>key包含“{}”且“{}”包含一个字符，则“{}”中的内容视为有效部分；</span></li><li><span>key不包含“{}”，则整个key视为有效部分</span></li></ul><p><span>这个有效部分有妙用，可以起到分组的作用，如我们想让一批key全部落到同一个节点上，我们</span><strong><span>只需要让这些key的有效部分相同，就可以让这些key有相同的插槽，从而达到让一批不同的key落到同一个节点上</span></strong><span>。如abc、{abc}name、{abc}info、{abc}age，这些key的有效部分相同——abc，所以都会落到同一个节点上</span></p><p><strong><em><span>Redis集群是最多有16384个分片吗</span></em></strong></p><p><span>不一定，但是多出来的分片可能分配不到槽位，因为默认情况下，最多只有16384个槽位。建议</span><strong><span>分片最多不超过1000个节点</span></strong></p><p><strong><em><span>为什么是16384个槽位</span></em></strong></p><p><span>插槽不是越多越好，因为</span><strong><span>插槽位太多，会浪费带宽，压缩比高</span></strong><span>。</span></p><p><span>插槽使用位图这样的数据结构表示，16384(16k,个数基本够用)个slots，需要的是2kb大小，如果给定的slots数量更多了，则需要消耗更多的空间，假如65536 那么他就是(8kb) 心跳包是周期性通信的(非常频繁，吃网络带宽)</span></p><p><strong><em><span>redis数据分片算法</span></em></strong></p><p><span>主流的数据分片算法有：</span></p><ol start='' ><li><strong><span>哈希取模</span></strong><span>——hash(key) % n。实现简单，但是对扩缩容不友好</span></li><li><strong><span>一致性哈希算法</span></strong><span>——65535个操作。扩缩容时只影响该节点附近的节点，影响节点较少</span></li><li><strong><span>哈希槽分区算法</span></strong><span>——crc16(key)%16384。16384固定值，数据与插槽绑定而非机器，方便扩缩容，数据分布均匀</span></li></ol><p><span>redis使用的是哈希槽分区算法，相较于一致性哈希算法，哈希槽分区算法数据分布更均匀，可手动调整插槽的分配情况</span></p><p><span>更多请参考：</span></p><p><a href='https://blog.csdn.net/weixin_45433817/article/details/136994475'><span>Redis第10讲——Redis数据分片的三种算法_redis分片规则-CSDN博客</span></a></p><p><a href='https://developer.aliyun.com/article/1529903'><span>Redis集群,集群的概念 三种主流分片方式-阿里云开发者社区 (aliyun.com)</span></a></p><h4><a name="总结" class="md-header-anchor"></a><span>总结</span></h4><p><span>redis支持很多功能，单实例redis并发读能力不行，我们可以搭建主从集群（Replica），实现读写分离，缓解读压力。但是主从集群无法自动故障恢复，又在主从集群的基础上添加哨兵机制实现健康检测，故障恢复。然而主从+哨兵仍有不足，我们还可以搭建分片集群缓解高并发写和存储大量数据。但是我们会发现学习成本也越来越大，尤其是redis分片集群，经常会冷不丁的就报错：ERR...完全出乎意料，简单总结一下吧</span></p><figure><table><thead><tr><th><span>redis</span></th><th><span>优点</span></th><th><span>缺点</span></th></tr></thead><tbody><tr><td><span>单实例</span></td><td><span>易，机器成本小，简单方便快捷</span></td><td><span>读写并发不足，读写没有高可用</span></td></tr><tr><td><span>主从模式</span></td><td><span>中，支持高并发读，读高可用</span></td><td><span>写并发不足，写没有高可用，机器成本较大，多个节点数据冗余</span></td></tr><tr><td><span>主从模式+哨兵机制</span></td><td><span>较难，支持高并发读，读写高可用</span></td><td><span>写并发不足，多个节点数据冗余，机器成本大，在主从的基础上增加机器部署哨兵，然而哨兵又不能存储数据（不过哨兵机器的性能配置可以降低）</span></td></tr><tr><td><span>分片集群</span></td><td><span>难，支持高并发读写，读写高可用，存储大量数据</span></td><td><span>维护困难，机器成本大，扩缩容简单</span></td></tr></tbody></table></figure></div>

</div>
</div>
</article>
</div>
<div class="btn-toTop"></div>
</div>
</body>

</html>
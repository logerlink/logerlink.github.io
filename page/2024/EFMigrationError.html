<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"></link>
        <meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
        <title>EF CodeFirst迁移错误：Column names in each table must be unique - LogerLink .NET Blog</title>
        <meta name="description" content="EF CodeFirst迁移错误：Column names in each table must be unique">
        <link href='../../css/family.css' rel='stylesheet' type='text/css' />
        <script src="../../js/base.js" type="module"></script>
    </head>
    <body>
        <div class="container">
            <div class="col-left">
                <div class="wave"></div>
                <div class="category">
                </div>
            </div>
            <div class="col-right">
                <article>
                    <header>
                        <h1 class="title">
                            EF CodeFirst迁移错误：Column names in each table must be unique
                        </h1>
                        <div class="dateTime">
                            2024-01-26
                        </div>
                    </header>
                    <hr/>
                    <div class="content">
<div class='typora-export os-windows' >
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span class="btn-toggle">&gt;</span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n29"><a class="md-toc-inner" href="#问题">问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n10"><a class="md-toc-inner" href="#如何解决">如何解决</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n13"><a class="md-toc-inner" href="#问题定位">问题定位</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n17"><a class="md-toc-inner" href="#验证">验证</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n21"><a class="md-toc-inner" href="#处理">处理</a></span><span role="listitem" class="md-toc-item md-toc-h5" data-ref="n25"><a class="md-toc-inner" href="#验证解决">验证解决</a></span></p></div><h4 id='问题'><span>问题</span></h4><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126161843021.png" referrerpolicy="no-referrer" alt="image-20240126161843021"></p><p><span>EF迁移，执行</span><code>update-database</code><span>时报错：</span><span style="color:red"><span>Microsoft.Data.SqlClient.SqlException (0x80131904): Column names in each table must be unique. Column name &#39;Address&#39; in table &#39;xxx_xxx_StaffInfo&#39; is specified more than once.</span></span></p><p><span>提示很明显不能添加相同的列（表），一般有两种可能</span></p><ol start='' ><li><span>手动再数据库表新增了一列，然后又使用EF迁移新增一列</span></li><li><span>EF已经迁移过了，但是在迁移表中不存该记录，导致重复迁移</span></li></ol><h4 id='如何解决'><span>如何解决</span></h4><p><span>针对第一种情况很少见，若真的出现这种情况，我们要先观察是否已经存在数据，不存在则直接删除。存在的话可能要做个备份再删除，等待迁移后再恢复数据即可</span></p><p><span>第二种情况往往比较常见，一般是我们更换数据库连接或者误删除迁移表的迁移记录而导致的问题。下面给大家演示如何处理，核心：往迁移表添加迁移记录</span></p><h5 id='问题定位'><span>问题定位</span></h5><p><span>查看历史Migration，看看错误提示的字段（</span><strong><span>Address</span></strong><span>）在哪个Migration中，也可以根据控制台错误提示快速定位是哪个Migration出的问题</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126161843021.png" referrerpolicy="no-referrer" alt="image-20240126161843021"></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126150741422.png" referrerpolicy="no-referrer" alt="image-20240126150741422"></p><h5 id='验证'><span>验证</span></h5><p><span>找到指定Migration，在迁移表中查找该Migration的文件名，发现未找到该记录，那便是这个问题了</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SELECT</span> MigrationId<span class="cm-punctuation">,</span> ProductVersion</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">FROM</span> TestDb<span class="cm-variable-2">.dbo</span>.<span class="cm-bracket">[</span>__EFMigrationsHistory<span class="cm-bracket">]</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">where</span> MigrationId <span class="cm-operator">=</span> <span class="cm-string">'20210622082655_07xxxxxxxxxxfoAddField'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126150941645.png" referrerpolicy="no-referrer" alt="image-20240126150941645"></p><h5 id='处理'><span>处理</span></h5><p><span>接下来我们往迁移表手动添加一条迁移记录，保证MigrationId要正确即可</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> TestDb<span class="cm-variable-2">.dbo</span>.<span class="cm-bracket">[</span>__EFMigrationsHistory<span class="cm-bracket">]</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">(</span>MigrationId<span class="cm-punctuation">,</span>ProductVersion<span class="cm-bracket">)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">VALUES</span> </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-bracket">(</span><span class="cm-string">'20210622082655_07xxxxxxxxxxfoAddField'</span><span class="cm-punctuation">,</span><span class="cm-string">'3.1.2'</span><span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126151346210.png" referrerpolicy="no-referrer" alt="image-20240126151346210"></p><h5 id='验证解决'><span>验证解决</span></h5><p><span>再次执行迁移，成功</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="shell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="shell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">update-database</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/2024/image-20240126151502979.png" referrerpolicy="no-referrer" alt="image-20240126151502979"></p></div></div>

</div>
</div>
</article>
</div>
<div class="btn-toTop"></div>
</div>
</body>

</html>
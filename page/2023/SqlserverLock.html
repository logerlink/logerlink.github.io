<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <link rel="stylesheet" type="text/css" href="../../css/base.css"></link>
        <meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
        <title>简单记录Sql Server常见锁类型</title>
        <meta name="description" content="简单记录Sql server加锁，更新锁，乐观锁，悲观锁，EF加锁">
        <link href='../../css/family.css' rel='stylesheet' type='text/css' />
        <script src="../../js/base.js" type="module"></script>
    </head>
    <body>
        <div class="container">
            <div class="col-left">
                <div class="wave"></div>
                <div class="category">
                </div>
            </div>
            <div class="col-right">
                <article>
                    <header>
                        <h1 class="title">
                            简单记录Sql Server常见锁类型
                        </h1>
                        <div class="dateTime">
                            2023-08-17
                        </div>
                    </header>
                    <hr/>
                    <div class="content">
<div class='typora-export os-windows' >
<div id='write'  class=''><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n3"><a class="md-toc-inner" href="#splock-查看锁">sp_lock 查看锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n79"><a class="md-toc-inner" href="#sql-server加锁语句">Sql Server加锁语句</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n82"><a class="md-toc-inner" href="#sql-server常见锁">Sql Server常见锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n102"><a class="md-toc-inner" href="#rowlock------行锁------read-committed">ROWLOCK——行锁——READ COMMITTED</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n113"><a class="md-toc-inner" href="#rowlock------行锁2------repeatable-read">ROWLOCK——行锁2——REPEATABLE READ</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n132"><a class="md-toc-inner" href="#tablock------表锁------read-committed">TABLOCK——表锁——READ COMMITTED</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n143"><a class="md-toc-inner" href="#tablock------表锁2------repeatable-read">TABLOCK——表锁2——REPEATABLE READ</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n162"><a class="md-toc-inner" href="#updlock------更新锁">UPDLOCK——更新锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n180"><a class="md-toc-inner" href="#xlock------排它锁">XLOCK——排它锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n196"><a class="md-toc-inner" href="#tablockx------表的排他锁">TABLOCKX——表的排他锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n212"><a class="md-toc-inner" href="#nolock------没有锁">NOLOCK——没有锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n226"><a class="md-toc-inner" href="#holdlock------共享锁">HOLDLOCK——共享锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n242"><a class="md-toc-inner" href="#悲观锁和乐观锁">悲观锁和乐观锁 </a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n247"><a class="md-toc-inner" href="#场景及问题">场景及问题</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n259"><a class="md-toc-inner" href="#悲观锁-1">悲观锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n272"><a class="md-toc-inner" href="#乐观锁-1">乐观锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n291"><a class="md-toc-inner" href="#net-core代码使用锁">.Net Core代码使用锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n295"><a class="md-toc-inner" href="#准备数据">准备数据</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n302"><a class="md-toc-inner" href="#悲观锁-2">悲观锁</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n310"><a class="md-toc-inner" href="#乐观锁-2">乐观锁</a></span></p></div><p><span>闲来无聊，撸撸Sql Server锁</span></p><h3 id='splock-查看锁'><span>sp_lock 查看锁</span></h3><p><span>我们可以使用</span><code>sp_lock</code><span>语句查看Sql Server当前存在哪些锁。</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230726155330008.png" referrerpolicy="no-referrer" alt="image-20230726155330008"></p><p><span>参考：</span><a href='https://blog.csdn.net/hahawujin/article/details/80109105'><span>SQLSERVER各种锁——实例</span><em><span>sqlserver sp_lock</span></em><span>飞行的数据的博客-CSDN博客</span></a></p><ul><li><p><strong><span>spid</span></strong><span>：进程id。可以使用kill spid来杀死进程释放锁。</span></p></li><li><p><strong><span>dbid</span></strong><span>：数据库id</span></p></li><li><p><span>Objid：数据库内对象id</span></p></li><li><p><span>Indid：持有锁的索引标识号。</span></p></li><li><p><strong><span>type</span></strong><span>：锁的资源类型。</span></p><ul><li><strong><span>RID</span></strong><span>：行锁——表中单个行的锁，由行标识符 (RID) 标识。</span></li><li><strong><span>KEY</span></strong><span>：索引内保护可串行事务中一系列键的锁。</span></li><li><strong><span>PAG</span></strong><span>：数据页或索引页的锁。</span></li><li><strong><span>TAB</span></strong><span>：表锁——TAB = 整个表（包括所有数据和索引）的锁。</span></li><li><strong><span>DB</span></strong><span>：数据库的锁</span></li><li><span>EXT：对某区的锁</span></li><li><span>FIL：数据库文件的锁</span></li><li><span>APP：执行的应用程序资源的锁</span></li><li><span>MD：元数据或目录信息的锁。</span></li><li><span>HBT：堆或 B 树索引的锁。在 SQL Server 中此信息不完整。</span></li><li><span>AU：分配单元的锁。在 SQL Server 中此信息不完整。</span></li></ul></li><li><p><strong><span>mode</span></strong><span>：请求锁的类型</span></p><ul><li><span>Sch-S：架构稳定性。确保在任何会话持有对架构元素（例如表或索引）的架构稳定性锁时，不删除该架构元素</span></li><li><span>Sch-M：架构修改。必须由要更改指定资源架构的任何会话持有。确保没有其他会话正在引用所指示的对象。</span></li><li><strong><span>S</span></strong><span>：共享。授予持有锁的会话对资源的共享访问权限。</span></li><li><strong><span>U</span></strong><span>： 更新。指示对最终可能更新的资源获取的更新锁。用于防止一种常见的死锁，这种死锁在多个会话锁定资源以便稍后对资源进行更新时发生。</span></li><li><strong><span>X</span></strong><span>：排他。授予持有锁的会话对资源的独占访问权限。</span></li><li><strong><span>IS</span></strong><span>：意向共享。指示有意将 S 锁放置在锁层次结构中的某个从属资源上。</span></li><li><strong><span>IU</span></strong><span>：意向更新。指示有意将 U 锁放置在锁层次结构中的某个从属资源上。</span></li><li><strong><span>IX</span></strong><span>：意向排他。指示有意将 X 锁放置在锁层次结构中的某个从属资源上。</span></li><li><span>SIU：共享意向更新。指示对有意在锁层次结构中的从属资源上获取更新锁的资源进行共享访问。</span></li><li><span>SIX：共享意向排他。指示对有意在锁层次结构中的从属资源上获取排他锁的资源进行共享访问。</span></li><li><span>UIX：更新意向排他。指示对有意在锁层次结构中的从属资源上获取排他锁的资源持有的更新锁。</span></li><li><span>BU：大容量更新。用于大容量操作。</span></li><li><span>...</span></li></ul></li><li><p><span>status：锁的状态</span></p><ul><li><span>CNVRT：锁正在从另一种模式进行转换，但是转换被另一个持有锁（模式相冲突）的进程阻塞。</span></li><li><strong><span>GRANT</span></strong><span>：已获取锁。</span></li><li><strong><span>WAIT</span></strong><span>：等待获取锁。锁可能被另一个持有锁（模式相冲突）的进程阻塞。</span></li></ul></li></ul><h3 id='sql-server加锁语句'><span>Sql Server加锁语句</span></h3><p><span>Sql Server加锁语句，尽量使用</span><strong><span>WITH(锁)</span></strong><span>形式，直接写锁有时不管用</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><span><span>​</span>x</span></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>UPDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> ...</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>ROWLOCK<span class="cm-punctuation">,</span>UPDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> ...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>UPDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom'</span> <span class="cm-keyword">where</span> ...</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><h3 id='sql-server常见锁'><span>Sql Server常见锁</span></h3><ul><li><span>ROWLOCK：行锁。</span></li><li><span>TABLOCK：表锁。</span></li><li><span>UPDLOCK：更新锁。</span></li><li><span>XLOCK：排它锁。</span></li><li><span>TABLOCKX：表的排他锁。</span></li><li><span>NOLOCK：没有锁。</span></li><li><span>HOLDLOCK：共享锁。 </span></li><li><span>PAGLOCK：在通常使用单个表锁的地方采用页锁。</span></li></ul><p><span>接下来我们来演示添加锁之后，对表内数据进行增删改查，看看有什么影响。</span></p><p><span>数据库隔离级别：READ COMMITTED（默认）</span></p><h4 id='rowlock------行锁------read-committed'><span>ROWLOCK——行锁——READ COMMITTED</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 事务1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>ROWLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Mike'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">18</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 461px;"></div><div class="CodeMirror-gutters" style="display: none; height: 461px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Mike'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">18</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：ROWLOCK——行锁，隔离级别为</span><code>READ COMMITTED</code><span>，与索引无关，当前事务执行中，其他事务或语句可立即查看、插入（新数据、注意唯一限定）、修改删除数据，相当于ROWLOCK单独使用，并没有起到 锁定数据的效果。在select语句中，不使用组合时，RowLock是没有意义的，一般会与</span><code>UPDLOCK</code><span>组合使用</span></p><h4 id='rowlock------行锁2------repeatable-read'><span>ROWLOCK——行锁2——REPEATABLE READ</span></h4><p><span>目前我们数据库的隔离级别是默认的——</span><code>READ COMMITTED</code><span>，此时我们改为更高级的隔离级别即</span><code>REPEATABLE READ</code><span>再重复上面的操作</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据库隔离级别</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- DBCC Useroptions</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改当前数据库的隔离级别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SET</span> <span class="cm-keyword">TRANSACTION</span> <span class="cm-keyword">ISOLATION</span> <span class="cm-keyword">LEVEL</span> <span class="cm-keyword">REPEATABLE</span> <span class="cm-keyword">READ</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 事务1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>ROWLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801183704106.png" referrerpolicy="no-referrer" alt="image-20230801183704106"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Mike'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">18</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、UPDLOCK、NOLOCK、HOLDLOCK立即执行，XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、UPDLOCK、NOLOCK、HOLDLOCK立即执行，XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 461px;"></div><div class="CodeMirror-gutters" style="display: none; height: 461px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801183833647.png" referrerpolicy="no-referrer" alt="image-20230801183833647"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Mike'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">18</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、UPDLOCK、NOLOCK、HOLDLOCK立即执行，XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、UPDLOCK、NOLOCK、HOLDLOCK立即执行，XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 461px;"></div><div class="CodeMirror-gutters" style="display: none; height: 461px;"></div></div></div></pre><p><span>小结：ROWLOCK——行锁，隔离级别为</span><code>REPEATABLE READ</code><span>，当前事务执行中，其他事务或语句可立即查看（带锁查询要分情况）、插入（新数据、注意唯一限定）数据，其他事务或语句对</span><strong><span>锁定行</span></strong><span>执行修改、删除操作需要等待当前事务提交（锁释放）后才会执行，对未锁定的数据可立即更新、删除。</span></p><p><span>本节演示完后，将数据库的隔离级别恢复至默认隔离级别——</span><code>READ COMMITTED</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SET</span> <span class="cm-keyword">TRANSACTION</span> <span class="cm-keyword">ISOLATION</span> <span class="cm-keyword">LEVEL</span> <span class="cm-keyword">READ</span> <span class="cm-keyword">COMMITTED</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h4 id='tablock------表锁------read-committed'><span>TABLOCK——表锁——READ COMMITTED</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 事务1</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>TABLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁,查看数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：TABLOCK——表锁，隔离级别为</span><code>READ COMMITTED</code><span>，与索引无关，当前事务执行中，其他事务或语句可立即查看、插入（新数据、注意唯一限定）、更新、删除数据，相当于TABLOCK单独使用，并没有起到 锁定数据的效果。</span></p><h4 id='tablock------表锁2------repeatable-read'><span>TABLOCK——表锁2——REPEATABLE READ</span></h4><p><span>目前我们数据库的隔离级别是默认的——</span><code>READ COMMITTED</code><span>，此时我们改为更高级的隔离级别即</span><code>REPEATABLE READ</code><span>重复上面的操作</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据库隔离级别</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- DBCC Useroptions</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改当前数据库的隔离级别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SET</span> <span class="cm-keyword">TRANSACTION</span> <span class="cm-keyword">ISOLATION</span> <span class="cm-keyword">LEVEL</span> <span class="cm-keyword">REPEATABLE</span> <span class="cm-keyword">READ</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>TABLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230803163158354.png" referrerpolicy="no-referrer" alt="image-20230803163158354"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230803164132563.png" referrerpolicy="no-referrer" alt="image-20230803164132563"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：TABLOCK——表锁，隔离级别为</span><code>REPEATABLE READ</code><span>，与索引无关，当前事务执行中，其他事务或语句可立即查看（带锁查询要分情况）数据，其他事务或语句对</span><strong><span>表内数据</span></strong><span>执行插入（新数据、注意唯一限定）、更新、删除需要等待当前事务提交（锁释放）后才会执行。</span></p><p><span>本节演示完后，将数据库的隔离级别恢复至默认隔离级别——</span><code>READ COMMITTED</code></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">SET</span> <span class="cm-keyword">TRANSACTION</span> <span class="cm-keyword">ISOLATION</span> <span class="cm-keyword">LEVEL</span> <span class="cm-keyword">READ</span> <span class="cm-keyword">COMMITTED</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h4 id='updlock------更新锁'><span>UPDLOCK——更新锁</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>UPDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230727113258872.png" referrerpolicy="no-referrer" alt="image-20230727113258872"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230727113759504.png" referrerpolicy="no-referrer" alt="image-20230727113759504"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：UPDLOCK——更新锁。</span></p><p><span>无索引的情况下，事务1查询会全表扫描（Table scan）导致扫描过的行都会被锁定，造成&quot;锁表&quot;现象。</span></p><p><span>无索引的情况下，当前事务执行中，其他事务或语句可立即查看（带锁查询要分情况）、插入数据（新数据、注意唯一限定），其他事务或语句对</span><strong><span>表内数据</span></strong><span>进行更新、删除操作需要等待当前事务提交（锁释放）后才会执行.</span></p><p><span>有索引的情况下，事务1查询不会进行全表扫描（Table scan）——不过我测试的时候还是走了全表扫描（Table scan），不知道是不是数据不够的原因。当前事务执行中，其他事务或语句可立即查看（带锁查询要分情况）、插入数据（新数据、注意唯一限定），其他事务或语句对</span><strong><span>锁定的数据</span></strong><span>进行更新、删除操作需要等待当前事务提交（锁释放）后才会执行，对未锁定的数据可立即更新、删除。</span></p><h4 id='xlock------排它锁'><span>XLOCK——排它锁</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>XLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801163725601.png" referrerpolicy="no-referrer" alt="image-20230801163725601"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>等待事务1完成后才执行，有时会立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801164523713.png" referrerpolicy="no-referrer" alt="image-20230801164523713"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>等待事务1完成后才执行，有时会立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、NOLOCK立即执行，TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：XLOCK——排它锁</span></p><p><span>与索引无关，当前事务执行中，其他事务或语句可立即查看（带锁查询要分情况）、插入数据（新数据、注意唯一限定），其他事务或语句对</span><strong><span>表内数据</span></strong><span>进行更新、删除操作需要等待当前事务提交（锁释放）后才会执行.</span></p><h4 id='tablockx------表的排他锁'><span>TABLOCKX——表的排他锁</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>TABLOCKX<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801173801576.png" referrerpolicy="no-referrer" alt="image-20230801173801576"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了NOLOCK立即执行，ROWLOCK、TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了NOLOCK立即执行，ROWLOCK、TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801175039905.png" referrerpolicy="no-referrer" alt="image-20230801175039905"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了NOLOCK立即执行，ROWLOCK、TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了NOLOCK立即执行，ROWLOCK、TABLOCK、UPDLOCK、XLOCK、TABLOCKX、HOLDLOCK都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：TABLOCKX——表的排他锁</span></p><p><span>与索引无关，当前事务执行中，其他事务或语句对</span><strong><span>表内数据</span></strong><span>进行查询（带锁查询要分情况）、插入（新数据、注意唯一限定）、更新、删除操作需要等待当前事务提交（锁释放）后才会执行.</span></p><h4 id='nolock------没有锁'><span>NOLOCK——没有锁</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">with</span><span class="cm-bracket">(</span>NOLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:20'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况，发现与事务执行之前没有差异，说明NoLOCK不会对任何数据（行表库）加锁。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁查看同一条数据，立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁查看不同数据，立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况，发现与事务执行之前没有差异，说明NOLOCK不会对任何数据（行表库）加锁。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁查看同一条数据，立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 带任意锁查看不同数据，立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：NOLOCK——没有锁</span></p><p><span>与索引无关，当前事务执行中，其他事务或语句对</span><strong><span>表内数据</span></strong><span>进行查询、插入（新数据、注意唯一限定）、更新、删除操作立即执行.</span></p><h4 id='holdlock------共享锁'><span>HOLDLOCK——共享锁</span></h4><p><span>新建一个查询窗口执行</span><code>事务1</code><span>，</span><code>waitfor delay</code><span>用于延长事务结束时间，在该事务结束之前我们还需要去执行一些语句。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>HOLDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> selectData</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 92px;"></div><div class="CodeMirror-gutters" style="display: none; height: 92px;"></div></div></div></pre><p><span>再新建一个查询窗口，执行</span><code>事务1</code><span>的同时，执行</span><code>语句1</code><span>。</span><code>事务1、语句1</code><span>执行完了之后，再次执行</span><code>事务1</code><span>，然后执行</span><code>语句2</code><span>，依次执行完所有语句，并观察执行效果。</span></p><p><strong><span>没有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801180543155.png" referrerpolicy="no-referrer" alt="image-20230801180543155"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>新增id非唯一非聚集索引</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">create</span> <span class="cm-keyword">index</span> idx_id</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">on</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">](</span>id<span class="cm-bracket">)</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><strong><span>有索引</span></strong><span>的情况下，各语句的执行效果：</span></p><p><span>在事务执行中时，我们可以先通过</span><code>sp_lock</code><span>查看当前锁的情况</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230801181112470.png" referrerpolicy="no-referrer" alt="image-20230801181112470"></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom81'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 修改其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Name <span class="cm-operator">=</span> <span class="cm-string">'Tom18'</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 插入新数据<span class="cm-tab" role="presentation" cm-text="	">    </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">INSERT</span> <span class="cm-keyword">INTO</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-bracket">([</span>Id<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Name<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Avatar<span class="cm-bracket">]</span><span class="cm-punctuation">,</span><span class="cm-bracket">[</span>Age<span class="cm-bracket">])</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-keyword">VALUES</span> <span class="cm-bracket">(</span><span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">,</span><span class="cm-string">'Tom'</span><span class="cm-punctuation">,</span><span class="cm-string">'5555555555'</span><span class="cm-punctuation">,</span><span class="cm-number">3</span><span class="cm-bracket">)</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除其他数据<span class="cm-tab" role="presentation" cm-text="	">   </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> Id <span class="cm-operator">=</span> <span class="cm-string">'57D50625-7559-42B9-933B-6684F8924A6C'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 删除同一条数据<span class="cm-tab" role="presentation" cm-text="	">  </span>等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">BEGIN</span> <span class="cm-keyword">TRANSACTION</span> deleteuser</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">delete</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span>dbo<span class="cm-bracket">]</span>.<span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ROLLBACK</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看数据<span class="cm-tab" role="presentation" cm-text="	"> </span>立即执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span><span class="cm-punctuation">;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看同一条数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 查看不同数据，除了ROWLOCK、TABLOCK、NOLOCK、HOLDLOCK立即执行，UPDLOCK、XLOCK、TABLOCKX都需要等待事务1完成后才执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>任意锁<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">&lt;&gt;</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 438px;"></div><div class="CodeMirror-gutters" style="display: none; height: 438px;"></div></div></div></pre><p><span>小结：HOLDLOCK——共享锁</span></p><p><span>与索引无关，当前事务执行中，其他事务或语句可立即查询（带锁查询要分情况）数据，其他事务或语句对</span><strong><span>表内数据</span></strong><span>执行插入（新数据、注意唯一限定）、更新、删除操作需要等待当前事务提交（锁释放）后才会执行.</span></p><h3 id='悲观锁和乐观锁'><span>悲观锁和乐观锁 </span></h3><p><span>悲观锁和乐观锁并不是指的&quot;某种锁&quot;，我更愿意理解为对待并发的&quot;处理态度&quot;。</span></p><p><span>一种执悲观的态度，认为并发是</span><strong><span>经常</span></strong><span>发生的。所以我要对数据加锁，在处理数据的这段时间，不允许别人修改该数据，从而保证每一个线程都能达到目的。由于需要</span><strong><span>加锁等待</span></strong><span>，</span><strong><span>并发的效率不高</span></strong><span>，适合</span><strong><span>并发不高</span></strong><span>的场景下使用，</span><strong><span>悲观锁一定会成功</span></strong><span>。</span></p><p><span>一种执乐观的态度，认为并发是</span><strong><span>极少</span></strong><span>发生的。所以我不需要对数据加锁，我只需要确定</span><strong><span>在我读取该数据到我修改该数据的这段时间内</span></strong><span>该数据有没有被修改过就行了。若未被修改，则修改该数据，若被修改了，则不修改该数据并告诉用户（重试）。乐观处理，无需加锁，</span><strong><span>并发的效率较高</span></strong><span>，适合</span><strong><span>高并发</span></strong><span>的场景下使用，</span><strong><span>乐观锁不一定成功</span></strong><span>(修改)。</span></p><p><span>参考：</span><a href='https://www.cnblogs.com/kongsq/p/5841397.html'><span>数据库对并发的处理-乐观锁与悲观锁 - 努力--坚持 - 博客园 (cnblogs.com)</span></a></p><h4 id='场景及问题'><span>场景及问题</span></h4><p><span>假如我们有一个事务用于查询并修改某条数据A，但是该事务可能要执行（等待）一段时间，在这段时间里，另一个事务或语句可能也要修改这条数据A（制造并发场景）。</span></p><p><span>我们有如下sql语句用于查询Age值，并更新Age值为 @age+1。正常情况下，若Age初始值为4，执行完该事务，Age值则变为5。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 查询Age值并赋值@age</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">declare</span> <span class="cm-variable-2">@age</span> <span class="cm-type">int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">=</span> Age <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 更新Age值为 @age+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 207px;"></div><div class="CodeMirror-gutters" style="display: none; height: 207px;"></div></div></div></pre><p><span>此时我们再准备一条sql语句，在执行事务updateAge的同时，执行update语句。正常情况下，若Age初始值为4，执行完该语句，Age值则变为5。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> Age <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>事务updateAge执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816161344130.png" referrerpolicy="no-referrer" alt="image-20230816161344130"></p><p><span>update语句执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816161443142.png" referrerpolicy="no-referrer" alt="image-20230816161443142"></p><p><span>我们观察一下事务updateAge执行情况：在执行事务updateAge的同时，执行update语句，update语句立即执行，Age值变为5。事务updateAge执行完后查询，Age的值也是5。那就有问题了是不是，因为我们执行了update语句和事务updateAge，都会去更改Age值，按理来说此时的Age的值应该是6（4+1+1），而不是5。相当于我们执行了两次更新操作，其中有一次更新是无效的，但是并没有提示用户。在我们看来两次更新操作都成功了，但是Age的值没有达到我们期望的值。</span></p><p><span>接下来我们分别演示一下使用悲观锁和乐观锁如何处理这个问题</span></p><h4 id='悲观锁-1'><span>悲观锁</span></h4><p><span>修改Age为初始值4</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-number">4</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>我们有如下sql语句用于查询Age值（加了</span><strong><span>更新锁</span></strong><span>），并更新Age值为 @age+1。正常情况下，若Age初始值为4，执行完该事务，Age值则变为5。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 悲观锁</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 查询Age值并赋值@age</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">declare</span> <span class="cm-variable-2">@age</span> <span class="cm-type">int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">=</span> Age <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">WITH</span><span class="cm-bracket">(</span>UPDLOCK<span class="cm-bracket">)</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 更新Age值为 @age+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 230px;"></div><div class="CodeMirror-gutters" style="display: none; height: 230px;"></div></div></div></pre><p><span>此时我们再准备一条sql语句，在执行事务updateAge的同时，执行update语句。正常情况下，若Age初始值为4，执行完该语句，Age值则变为5。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> Age <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>事务updateAge执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816162429664.png" referrerpolicy="no-referrer" alt="image-20230816162429664"></p><p><span>update语句执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816162507438.png" referrerpolicy="no-referrer" alt="image-20230816162507438"></p><p><span>我们观察一下事务updateAge执行情况：由于事务updateAge加了</span><code>UPDLOCK</code><span>锁，在执行事务updateAge的同时，执行update语句，update语句需要等待事务updateAge提交</span><strong><span>执行完毕（锁释放）后才会执行</span></strong><span>。事务updateAge执行完后查询，Age的值是5，update语句执行完后查询，Age的值是6（4+1+1），符合情况。</span></p><p><strong><span>悲观锁一定会成功</span></strong><span>，我们可以发现事务updateAge和update语句都依次成功执行了。</span></p><h4 id='乐观锁-1'><span>乐观锁</span></h4><p><span>修改Age为初始值4</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-number">4</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>由于乐观锁需要一个</span><strong><span>版本或时间戳字段</span></strong><span>的支持才能完成，我们需要先加一下这个字段。</span><strong><span>推荐使用时间戳字段</span></strong><span>，因为时间戳字段</span><strong><span>无法也无需</span></strong><span>手动更新，每次成功更新数据时间戳字段都会自动更新，版本字段需要每次更新数据的同时手动更新版本字段，比较麻烦。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">ALTER</span> <span class="cm-keyword">TABLE</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">ADD</span> TimesFlag <span class="cm-type">TIMESTAMP</span> <span class="cm-keyword">NOT</span> <span class="cm-atom">null</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>我们有如下sql语句用于查询Age值，并更新Age值为 @age+1，更新的时候加上时间戳判断条件。这还没完，事务的最后我们还需要获取当前事务被修改行数</span><code>@@ROWCOUNT</code><span>，</span><strong><span>若修改行数大于0，则表示修改成功，否则修改失败，提示用户</span></strong><span>(重试)。</span></p><p><span>正常情况下，若事务updateAge执行的这段时间内没有更新该数据，Age初始值为4，执行完该事务，Age值则变为5。</span></p><p><span>若事务updateAge执行的这段时间内有其他语句或者事务更新了该数据，那么该数据的时间戳就会发生改变，导致事务updateAge执行更新操作</span><strong><span>找不到数据</span></strong><span>（时间戳对不上），最终更新数据失败。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">-- 乐观锁</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Begin</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 查询Age值并赋值@age、查询TimesFlag并赋值@flag</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">declare</span> <span class="cm-variable-2">@age</span> <span class="cm-type">int</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">declare</span> <span class="cm-variable-2">@flag</span> <span class="cm-type">TIMESTAMP</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">=</span> Age<span class="cm-punctuation">,</span><span class="cm-variable-2">@flag</span> <span class="cm-operator">=</span> TimesFlag <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>waitfor delay <span class="cm-string">'00:00:10'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 更新Age值为 @age+1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-variable-2">@age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span> <span class="cm-keyword">and</span> TimesFlag <span class="cm-operator">=</span> <span class="cm-variable-2">@flag</span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 这里加了TimesFlag判断条件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">-- 获取被修改的行数，判断是否修改成功</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> <span class="cm-variable-2">@@ROWCOUNT</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">print</span> <span class="cm-string">'修改失败'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-builtin">print</span> <span class="cm-string">'修改成功'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">Commit</span> <span class="cm-keyword">Transaction</span> updateAge</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 392px;"></div><div class="CodeMirror-gutters" style="display: none; height: 392px;"></div></div></div></pre><p><span>此时我们再准备一条sql语句，在执行事务updateAge的同时，执行update语句。正常情况下，若Age初始值为4，执行完该语句，Age值则变为5。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> Age <span class="cm-operator">+</span> <span class="cm-number">1</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">select</span> <span class="cm-operator">*</span> <span class="cm-keyword">from</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>事务updateAge执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816173038341.png" referrerpolicy="no-referrer" alt="image-20230816173038341"></p><p><span>update语句执行结果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230816172438737.png" referrerpolicy="no-referrer" alt="image-20230816172438737"></p><p><span>我们观察一下事务updateAge执行情况：在执行事务updateAge的同时，执行update语句，update语句立即执行，Age值变为5。事务updateAge执行完后查询，Age的值也是5。</span></p><p><span>唉，怎么Age的值都是5，那不是跟原来一样的问题吗？</span></p><p><span>不不不，我们可以看一下事务updateAge执行结果图，里面是不是有一个</span><code>修改失败</code><span>的提示，在实际开发中我们可以把被修改行数</span><code>@@ROWCOUNT</code><span>作为事务是否成功执行的另一条件，若修改行数大于0，则表示修改成功，否则修改失败，提示用户(重试)。</span></p><p><span>乐观锁认为并发是极少发生的，</span><strong><span>乐观锁不一定成功</span></strong><span>(修改)，在此场景下，update语句执行成功了，但是事务updateAge并没有执行&quot;成功&quot;(修改)</span></p><h3 id='net-core代码使用锁'><span>.Net Core代码使用锁</span></h3><p><span>以悲观锁和乐观锁的场景，看看.Net Core如何使用锁。EF使用锁比较麻烦，需要借助</span><code>ExecuteSqlRaw</code><span>、</span><code>FromSqlRaw</code><span>方法来执行原生Sql语句来实现锁。</span></p><p><span>Nuget包版本</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230817120217918.png" referrerpolicy="no-referrer" alt="image-20230817120217918"></p><h4 id='准备数据'><span>准备数据</span></h4><p><span>准备三个接口：ChangeAgeByPCC（悲观锁）、ChangeAgeByOCC（乐观锁）、ChangeAgeNoLock（直接修改）</span></p><p><span>分别执行ChangeAgeByPCC、ChangeAgeByOCC接口，触发执行后接着执行ChangeAgeNoLock接口，观察各个接口执行的情况。</span></p><p><span>User实体类：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/// 用户信息</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">User</span> : <span class="cm-variable">BaseModel</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 用户名称</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [<span class="cm-variable">MaxLength</span>(<span class="cm-number">100</span>)]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [<span class="cm-variable">Required</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span> <span class="cm-variable">Name</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">private</span> <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 用户性别</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  [<span class="cm-variable">Required</span>]</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">int</span> <span class="cm-variable">Age</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">private</span> <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 用户头像</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span> <span class="cm-variable">Avatar</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">private</span> <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 时间戳</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">byte</span>[] <span class="cm-variable">TimesFlag</span> { <span class="cm-keyword">get</span>; <span class="cm-keyword">set</span>; }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">void</span> <span class="cm-variable">SetAvatar</span>(<span class="cm-variable-3">string</span> <span class="cm-variable">avatar</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Avatar</span> <span class="cm-operator">=</span> <span class="cm-variable">avatar</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">void</span> <span class="cm-variable">SetAge</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">age</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Age</span> <span class="cm-operator">=</span> <span class="cm-variable">age</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">override</span> <span class="cm-variable-3">string</span> <span class="cm-variable">ToString</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">$</span><span class="cm-string">"ID：{this.Id}，Avater：{this.Avatar}，Name：{this.Name}，Age：{this.Age}"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 922px;"></div><div class="CodeMirror-gutters" style="display: none; height: 922px;"></div></div></div></pre><p><span>ChangeAgeNoLock接口实现逻辑：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 直接修改Age数据后查询</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="userId"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span> <span class="cm-def">ChangeAgeNoLock</span>(<span class="cm-variable-3">Guid</span> <span class="cm-variable">userId</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 不要先查出来再修改，可能会造成死锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// http://localhost:5125/api/SqlTest/ChangeAgeNoLock?userId=08db1fba-affb-49bd-88ca-6a91fe1e1a03</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_db</span>.<span class="cm-variable">Database</span>.<span class="cm-variable">ExecuteSqlRaw</span>(<span class="cm-string">"update [User] set Age = Age + 1 where id ={0}"</span>, <span class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">user</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">User</span>.<span class="cm-variable">FirstOrDefault</span>(<span class="cm-variable">x</span> <span class="cm-operator">=&gt;</span> <span class="cm-variable">x</span>.<span class="cm-variable">Id</span> <span class="cm-operator">==</span> <span class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">user</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) <span class="cm-keyword">return</span> <span class="cm-string">"空数据"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">$</span><span class="cm-string">"修改成功，Age：{user.Age}，{DateTime.Now}"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 323px;"></div><div class="CodeMirror-gutters" style="display: none; height: 323px;"></div></div></div></pre><h4 id='悲观锁-2'><span>悲观锁</span></h4><p><span>修改Age为初始值4</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-number">4</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>ChangeAgeByPCC接口实现逻辑：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 悲观锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="userId"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="delay"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span> <span class="cm-def">ChangeAgeByPCC</span>(<span class="cm-variable-3">Guid</span> <span class="cm-variable">userId</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">delay</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">sb</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">StringBuilder</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">using</span> (<span class="cm-keyword">var</span> <span class="cm-def">tran</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">Database</span>.<span class="cm-variable">BeginTransaction</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// http://localhost:5125/api/SqlTest/ChangeAgeByPCC?userId=08db1fba-affb-49bd-88ca-6a91fe1e1a03</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">string</span> <span class="cm-variable">sql</span> <span class="cm-operator">=</span> <span class="cm-string">"select * from [User] WITH(UPDLOCK) where id = @id"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">param</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">SqlParameter</span>(<span class="cm-string">"@id"</span>, <span class="cm-variable">userId</span>.<span class="cm-variable">ToString</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">users</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">User</span><span class="cm-operator">&gt;</span>().<span class="cm-variable">FromSqlRaw</span>(<span class="cm-variable">sql</span>, <span class="cm-variable">param</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">user</span> <span class="cm-operator">=</span> <span class="cm-variable">users</span>.<span class="cm-variable">FirstOrDefault</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">user</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) <span class="cm-keyword">return</span> <span class="cm-string">"空数据"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"初始值为：{user.Age},{DateTime.Now}\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">Task</span>.<span class="cm-variable">Delay</span>(<span class="cm-variable">delay</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>).<span class="cm-variable">Wait</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">user</span>.<span class="cm-variable">SetAge</span>(<span class="cm-variable">user</span>.<span class="cm-variable">Age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"修改值为：{user.Age},{DateTime.Now}\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"等待：{delay}s\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_db</span>.<span class="cm-variable">SaveChanges</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tran</span>.<span class="cm-variable">Commit</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">sb</span>.<span class="cm-variable">ToString</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 622px;"></div><div class="CodeMirror-gutters" style="display: none; height: 622px;"></div></div></div></pre><p><span>在执行ChangeAgeByPCC的同时执行ChangeAgeNoLock，我们看一下效果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230817113158850.png" referrerpolicy="no-referrer" alt="image-20230817113158850"></p><p><span>我们可以看出，ChangeAgeNoLock会等待ChangeAgeByPCC执行完毕后再执行，两个接口都</span><strong><span>执行成功</span></strong><span>。执行完后，Age的值由4变为6(4+1+1)。</span></p><h4 id='乐观锁-2'><span>乐观锁</span></h4><p><span>修改Age为初始值4</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="sql"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="sql"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">update</span> <span class="cm-bracket">[</span><span class="cm-keyword">User</span><span class="cm-bracket">]</span> <span class="cm-keyword">set</span> Age <span class="cm-operator">=</span> <span class="cm-number">4</span> <span class="cm-keyword">where</span> id <span class="cm-operator">=</span> <span class="cm-string">'08db1fba-affb-49bd-88ca-6a91fe1e1a03'</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>ChangeAgeByOCC接口实现逻辑：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="csharp" style="break-inside: unset;"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="csharp"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.51875px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;summary&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// 乐观锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;/summary&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="userId"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;param name="delay"&gt;&lt;/param&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/// &lt;returns&gt;&lt;/returns&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">string</span> <span class="cm-def">ChangeAgeByOCC</span>(<span class="cm-variable-3">Guid</span> <span class="cm-variable">userId</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">delay</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">sb</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">StringBuilder</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">using</span> (<span class="cm-keyword">var</span> <span class="cm-def">tran</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">Database</span>.<span class="cm-variable">BeginTransaction</span>())</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// http://localhost:5125/api/SqlTest/ChangeAgeByOCC?userId=08db1fba-affb-49bd-88ca-6a91fe1e1a03</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">user</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">User</span>.<span class="cm-variable">FirstOrDefault</span>(<span class="cm-variable">x</span><span class="cm-operator">=&gt;</span><span class="cm-variable">x</span>.<span class="cm-variable">Id</span> <span class="cm-operator">==</span> <span class="cm-variable">userId</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">user</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) <span class="cm-keyword">return</span> <span class="cm-string">"空数据"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"初始值为：{user.Age},{DateTime.Now}\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">Task</span>.<span class="cm-variable">Delay</span>(<span class="cm-variable">delay</span> <span class="cm-operator">*</span> <span class="cm-number">1000</span>).<span class="cm-variable">Wait</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">user</span>.<span class="cm-variable">SetAge</span>(<span class="cm-variable">user</span>.<span class="cm-variable">Age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"修改值为：{user.Age},{DateTime.Now}\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-variable">$</span><span class="cm-string">"等待：{delay}s\n"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="" cm-zwsp="">
</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">var</span> <span class="cm-def">rowCount</span> <span class="cm-operator">=</span> <span class="cm-variable">_db</span>.<span class="cm-variable">Database</span>.<span class="cm-variable">ExecuteSqlRaw</span>(<span class="cm-string">"update [User] set Age = {0} where id ={1} and TimesFlag = {2}"</span>, <span class="cm-variable">user</span>.<span class="cm-variable">Age</span> <span class="cm-operator">+</span> <span class="cm-number">1</span>, <span class="cm-variable">user</span>.<span class="cm-variable">Id</span>, <span class="cm-variable">user</span>.<span class="cm-variable">TimesFlag</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">_db</span>.<span class="cm-variable">SaveChanges</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">tran</span>.<span class="cm-variable">Commit</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">sb</span>.<span class="cm-variable">Append</span>(<span class="cm-string">"修改"</span> <span class="cm-operator">+</span> (<span class="cm-variable">rowCount</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span> <span class="cm-operator">?</span> <span class="cm-string">"失败"</span> : <span class="cm-string">"成功"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">sb</span>.<span class="cm-variable">ToString</span>();</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 645px;"></div><div class="CodeMirror-gutters" style="display: none; height: 645px;"></div></div></div></pre><p><span>在执行ChangeAgeByOCC的同时执行ChangeAgeNoLock，我们看一下效果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230817112256665.png" referrerpolicy="no-referrer" alt="image-20230817112256665"></p><p><span>我们可以看出，在ChangeAgeByOCC执行的过程中执行ChangeAgeNoLock，ChangeAgeNoLock成功修改Age值，但是ChangeAgeByOCC修改Age的值却</span><strong><span>提示失败</span></strong><span>，说明此次修改不起作用。</span></p><p><span>我们再单独执行ChangeAgeByOCC接口，看一下效果：</span></p><p><img src="https://gcore.jsdelivr.net/gh/logerlink/blogImg/typora-img/image-20230817112648640.png" referrerpolicy="no-referrer" alt="image-20230817112648640"></p><p><span>我们可以看出，因为在ChangeAgeByOCC执行的过程中没有修改该数据，执行成功。</span></p><p>&nbsp;</p><p><span>花了半个多月，终于撸完了，希望有帮助，去搬砖了。</span></p></div></div>

</div>
</div>
</article>
</div>
<div class="btn-toTop"></div>
</div>
</body>
</html>